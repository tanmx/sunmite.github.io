<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>谭明宵博客</title>
  
  <subtitle>Every day is May day!</subtitle>
  <link href="https://www.sunmite.com/atom.xml" rel="self"/>
  
  <link href="https://www.sunmite.com/"/>
  <updated>2021-02-25T03:28:35.866Z</updated>
  <id>https://www.sunmite.com/</id>
  
  <author>
    <name>tanmx</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用ceph-ansible部署Ceph Octopus</title>
    <link href="https://www.sunmite.com/ceph/ceph-ansible-deploy-octopus.html"/>
    <id>https://www.sunmite.com/ceph/ceph-ansible-deploy-octopus.html</id>
    <published>2020-12-31T06:10:09.000Z</published>
    <updated>2021-02-25T03:28:35.866Z</updated>
    
    <content type="html"><![CDATA[<p>之前用的是 ceph-deploy 部署 ceph 集群，在官网的最新介绍中有如下描述：</p><blockquote><p>ceph-deploy is no longer actively maintained. It is not tested on versions of Ceph newer than Nautilus. It does not support RHEL8, CentOS 8, or newer operating systems.  </p></blockquote><p>ceph-deploy 已经不在维护，并且在 ceph Nautilus 之后都没有很好的测试，不支持 RHEL8、CentOS8等系统。对比了 ceph-ansible 和 cephadm 这两个工具，最终选择的 ceph-ansible 作为部署工具。</p><span id="more"></span><h1 id="主机角色"><a href="#主机角色" class="headerlink" title="主机角色"></a>主机角色</h1><table><thead><tr><th>Hostname</th><th>Role</th><th>Admin/Public Network</th><th>Cluster Network</th><th>OS</th></tr></thead><tbody><tr><td>node01.ceph.local</td><td>ceph-ansible,mon,mgr,osd,rgw,mds,grafana</td><td>192.168.198.131/24</td><td>172.20.1.131/24</td><td>CentOS Linux release 8.3.2011</td></tr><tr><td>node02.ceph.local</td><td>mon,mgr,osd,rgw,mds</td><td>192.168.198.132/24</td><td>172.20.1.132/24</td><td>CentOS Linux release 8.3.2011</td></tr><tr><td>node03.ceph.local</td><td>mon,mgr,osd,rgw,mds</td><td>192.168.198.133/24</td><td>172.20.1.133/24</td><td>CentOS Linux release 8.3.2011</td></tr></tbody></table><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>包括<code>配置IP</code>、<code>配置主机名</code>、<code>配置HOSTS文件</code>、<code>配置加速源（EPEL）</code>、<code>配置时钟同步</code>、<code>关闭 SELinux</code>、<code>关闭Firewalld</code>、<code>设置免密登录</code>等，不再赘述。</p><h1 id="Ansible配置"><a href="#Ansible配置" class="headerlink" title="Ansible配置"></a>Ansible配置</h1><h2 id="1-ansible安装"><a href="#1-ansible安装" class="headerlink" title="1.ansible安装"></a>1.ansible安装</h2><p>使用以下命令安装 ansible, ceph-ansible stable 5.x 需要 ansible 2.9 源中的版本满足需求，可以直接 yum 安装</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install ansible -y</span></span><br></pre></td></tr></table></figure><h2 id="2-主机配置"><a href="#2-主机配置" class="headerlink" title="2.主机配置"></a>2.主机配置</h2><p>编辑 /etc/ansible/hosts 加入以下内容</p><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/ansible/hosts</span></span><br><span class="line"></span><br><span class="line">[mons]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br><span class="line">node02.ceph.<span class="keyword">local</span></span><br><span class="line">node03.ceph.<span class="keyword">local</span></span><br><span class="line"></span><br><span class="line">[mgrs]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br><span class="line">node02.ceph.<span class="keyword">local</span></span><br><span class="line">node03.ceph.<span class="keyword">local</span></span><br><span class="line"></span><br><span class="line">[osds]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br><span class="line">node02.ceph.<span class="keyword">local</span></span><br><span class="line">node03.ceph.<span class="keyword">local</span></span><br><span class="line"></span><br><span class="line">[rgws]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br><span class="line">node02.ceph.<span class="keyword">local</span></span><br><span class="line">node03.ceph.<span class="keyword">local</span></span><br><span class="line"></span><br><span class="line">[mdss]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br><span class="line">node02.ceph.<span class="keyword">local</span></span><br><span class="line">node03.ceph.<span class="keyword">local</span></span><br><span class="line"></span><br><span class="line">[grafana-server]</span><br><span class="line">node01.ceph.<span class="keyword">local</span></span><br></pre></td></tr></table></figure><h1 id="ceph-ansible配置"><a href="#ceph-ansible配置" class="headerlink" title="ceph-ansible配置"></a>ceph-ansible配置</h1><h2 id="1-下载-ceph-ansible"><a href="#1-下载-ceph-ansible" class="headerlink" title="1.下载 ceph-ansible"></a>1.下载 ceph-ansible</h2><p>下载 5.x 版本的 ceph-ansible</p><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># wget https:<span class="comment">//github.com/ceph/ceph-ansible/archive/v5.0.3.tar.gz</span></span></span><br></pre></td></tr></table></figure><h2 id="2-安装-ceph-ansible-依赖"><a href="#2-安装-ceph-ansible-依赖" class="headerlink" title="2.安装 ceph-ansible 依赖"></a>2.安装 ceph-ansible 依赖</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># tar zxvf v5.0.3.tar.gz</span></span><br><span class="line"><span class="meta"># yum install python-pip</span></span><br><span class="line"><span class="meta"># pip install -r ceph-ansible/requirements.txt</span></span><br></pre></td></tr></table></figure><h2 id="3-修改安装-ceph-配置"><a href="#3-修改安装-ceph-配置" class="headerlink" title="3.修改安装 ceph 配置"></a>3.修改安装 ceph 配置</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd ceph-ansible/group_vars/</span></span><br><span class="line"><span class="comment"># mv all.yml.sample all.yml</span></span><br><span class="line"><span class="comment"># grep -Ev &#x27;^#|^$&#x27; all.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">dummy:</span></span><br><span class="line"><span class="attr">ceph_repository_type:</span> <span class="string">repository</span></span><br><span class="line"><span class="attr">ceph_origin:</span> <span class="string">repository</span></span><br><span class="line"><span class="attr">ceph_repository:</span> <span class="string">community</span></span><br><span class="line"><span class="attr">ceph_mirror:</span> <span class="string">https://mirrors.tuna.tsinghua.edu.cn/ceph/</span></span><br><span class="line"><span class="attr">ceph_stable_key:</span> <span class="string">https://mirrors.tuna.tsinghua.edu.cn/ceph/keys/release.asc</span></span><br><span class="line"><span class="attr">ceph_stable_release:</span> <span class="string">octopus</span></span><br><span class="line"><span class="attr">ceph_stable_repo:</span> <span class="string">https://mirrors.tuna.tsinghua.edu.cn/ceph/rpm-15.2.7/el7/</span></span><br><span class="line"><span class="attr">monitor_interface:</span> <span class="string">eth0</span></span><br><span class="line"><span class="attr">public_network:</span> <span class="number">192.168</span><span class="number">.198</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">cluster_network:</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"><span class="attr">osd_objectstore:</span> <span class="string">bluestore</span></span><br><span class="line"><span class="attr">radosgw_civetweb_port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">radosgw_interface:</span> <span class="string">eth0</span></span><br><span class="line"><span class="attr">dashboard_enabled:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">dashboard_admin_user:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">dashboard_admin_password:</span> <span class="string">p@ssw0rd</span></span><br><span class="line"><span class="attr">grafana_admin_user:</span> <span class="string">admin</span></span><br><span class="line"><span class="attr">grafana_admin_password:</span> <span class="string">p@ssw0rd</span></span><br><span class="line"><span class="attr">ceph_conf_overrides:</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">        <span class="attr">mon_allow_pool_delete:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">mon_osd_allow_primary_affinity:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">mon_clock_drift_allowed:</span> <span class="number">0.5</span></span><br><span class="line">        <span class="attr">osd_pool_default_size:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">osd_pool_default_min_size:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">mon_pg_warn_min_per_osd:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">mon_pg_warn_max_per_osd:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">mon_pg_warn_max_object_skew:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">client:</span></span><br><span class="line">        <span class="attr">rbd_default_features:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="4-osd配置"><a href="#4-osd配置" class="headerlink" title="4.osd配置"></a>4.osd配置</h2><p>按照服务器配置的磁盘修改以下配置文件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cp osds.yml.sample osds.yml</span></span><br><span class="line"><span class="comment"># grep -Ev &#x27;^#|^$&#x27; osds.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">dummy:</span></span><br><span class="line"><span class="attr">devices:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/dev/sdb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/dev/sdc</span></span><br></pre></td></tr></table></figure><h2 id="5-其他配置"><a href="#5-其他配置" class="headerlink" title="5.其他配置"></a>5.其他配置</h2><p>复制其他的配置文件</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cp clients.yml.sample clients.yml</span></span><br><span class="line"><span class="meta"># cp mons.yml.sample mons.yml</span></span><br><span class="line"><span class="meta"># cp mgrs.yml.sample mgrs.yml</span></span><br><span class="line"><span class="meta"># cp rgws.yml.sample rgws.yml</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># cd ../</span></span><br><span class="line"><span class="meta"># cp site.yml.sample site.yml</span></span><br></pre></td></tr></table></figure><h1 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h1><p>执行以下命令开始安装</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># ansible-playbook site.yml</span></span><br></pre></td></tr></table></figure><p>完成安装后查看集群状态：</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ceph -s</span></span><br><span class="line">  <span class="attribute">cluster</span>:</span><br><span class="line">    <span class="attribute">id</span>:     <span class="number">6</span>e<span class="number">344</span>dd<span class="number">2</span>-<span class="number">341</span>a-<span class="number">4</span>bb<span class="number">6</span>-aafa-<span class="number">4299</span>a<span class="number">0</span>ebbe<span class="number">51</span></span><br><span class="line">    <span class="attribute">health</span>: HEALTH_OK</span><br><span class="line"></span><br><span class="line">  <span class="attribute">services</span>:</span><br><span class="line">    <span class="attribute">mon</span>: <span class="number">3</span> daemons, quorum node<span class="number">01</span>.ceph.local,node<span class="number">02</span>.ceph.local,node<span class="number">03</span>.ceph.local (age <span class="number">6</span>m)</span><br><span class="line">    <span class="attribute">mgr</span>: node<span class="number">01</span>.ceph.local(active, since <span class="number">40</span>s), standbys: node<span class="number">02</span>.ceph.local, node<span class="number">02</span>.ceph.local</span><br><span class="line">    <span class="attribute">mds</span>: cephfs:<span class="number">1</span> &#123;<span class="number">0</span>=node<span class="number">01</span>.ceph.local=up:active&#125; <span class="number">2</span> up:standby</span><br><span class="line">    <span class="attribute">osd</span>: <span class="number">12</span> osds: <span class="number">12</span> up (since <span class="number">2</span>m), <span class="number">12</span> in (since <span class="number">23</span>m)</span><br><span class="line">    <span class="attribute">rgw</span>: <span class="number">3</span> daemons active (node<span class="number">01</span>.ceph.local.rgw<span class="number">0</span>, node<span class="number">02</span>.ceph.local.rgw<span class="number">0</span>, <span class="number">3</span>.ceph.local.rgw<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="attribute">data</span>:</span><br><span class="line">    <span class="attribute">pools</span>:   <span class="number">6</span> pools, <span class="number">144</span> pgs</span><br><span class="line">    <span class="attribute">objects</span>: <span class="number">212</span> objects, <span class="number">6</span>.<span class="number">4</span> KiB</span><br><span class="line">    <span class="attribute">usage</span>:   <span class="number">12</span> GiB used, <span class="number">9</span>.<span class="number">8</span> TiB / <span class="number">9</span>.<span class="number">8</span> TiB avail</span><br><span class="line">    <span class="attribute">pgs</span>:     <span class="number">144</span> active+clean</span><br></pre></td></tr></table></figure><h1 id="清理安装"><a href="#清理安装" class="headerlink" title="清理安装"></a>清理安装</h1><p>如果安装出错，或者遇到其他问题，可以清理集群后再次尝试安装</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># ansible-playbook infrastructure-playbooks/purge-cluster.yml</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;之前用的是 ceph-deploy 部署 ceph 集群，在官网的最新介绍中有如下描述：&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ceph-deploy is no longer actively maintained. It is not tested on versions of Ceph newer than Nautilus. It does not support RHEL8, CentOS 8, or newer operating systems.  &lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;ceph-deploy 已经不在维护，并且在 ceph Nautilus 之后都没有很好的测试，不支持 RHEL8、CentOS8等系统。对比了 ceph-ansible 和 cephadm 这两个工具，最终选择的 ceph-ansible 作为部署工具。&lt;/p&gt;</summary>
    
    
    
    <category term="ceph" scheme="https://www.sunmite.com/categories/ceph/"/>
    
    
    <category term="ceph" scheme="https://www.sunmite.com/tags/ceph/"/>
    
  </entry>
  
  <entry>
    <title>将 HEXO 部署到VPS</title>
    <link href="https://www.sunmite.com/linux/deploy-hexo-to-vps.html"/>
    <id>https://www.sunmite.com/linux/deploy-hexo-to-vps.html</id>
    <published>2020-03-31T08:06:43.000Z</published>
    <updated>2021-01-25T02:17:02.356Z</updated>
    
    <content type="html"><![CDATA[<p>hexo 可以部署在github，conding。当有了一个 vps 之后可以把 hexo 部署到 vps ,步骤如下：</p><h2 id="1-安装-Git"><a href="#1-安装-Git" class="headerlink" title="1.安装 Git"></a>1.安装 Git</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># apt install git</span></span><br></pre></td></tr></table></figure><h2 id="2-创建-git-用户"><a href="#2-创建-git-用户" class="headerlink" title="2.创建 git 用户"></a>2.创建 git 用户</h2><figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"># adduser git  #根据提示设置密码。</span><br></pre></td></tr></table></figure><h2 id="3-赋予git用户sudo权限"><a href="#3-赋予git用户sudo权限" class="headerlink" title="3.赋予git用户sudo权限"></a>3.赋予git用户sudo权限</h2><p>编辑 sudoers 文件加入以下内容</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">vim</span> /etc/sudoers</span><br><span class="line"></span><br><span class="line"><span class="comment"># User privilege specification</span></span><br><span class="line"><span class="attribute">root</span>    <span class="literal">ALL</span>=(<span class="literal">ALL</span>:<span class="literal">ALL</span>) <span class="literal">ALL</span></span><br><span class="line"><span class="attribute">git</span>     <span class="literal">ALL</span>=(<span class="literal">ALL</span>:<span class="literal">ALL</span>) <span class="literal">ALL</span> #添加此行内容</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="4-关闭git用户shell权限"><a href="#4-关闭git用户shell权限" class="headerlink" title="4.关闭git用户shell权限"></a>4.关闭git用户shell权限</h2><p>将最后一行的/bin/bash修改为usr/bin/git-shell</p><figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/passwd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#git:x:1001:1001:,,,:/home/git:/bin/bash</span></span><br><span class="line"><span class="symbol">git:</span><span class="symbol">x:</span><span class="number">1001</span><span class="symbol">:</span><span class="number">1001</span><span class="symbol">:</span>,,,<span class="symbol">:/home/git</span><span class="symbol">:/usr/bin/git-shell</span></span><br></pre></td></tr></table></figure><h2 id="5-配置-ssh"><a href="#5-配置-ssh" class="headerlink" title="5.配置 ssh"></a>5.配置 ssh</h2><p>su 到 git 用户，将本地的公钥复制到authorized_keys文件里</p><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">~ <span class="keyword">cd</span> <span class="string">/home/git</span>                <span class="string">//</span>切换到git用户目录</span><br><span class="line">~ mkdir <span class="string">.ssh</span>              <span class="string">//</span>创建<span class="string">.ssh</span>目录</span><br><span class="line">~ <span class="keyword">cd</span> <span class="string">.ssh</span></span><br><span class="line">~ vim authorized_keys    <span class="string">//</span>复制本地的公钥到这里</span><br></pre></td></tr></table></figure><p>修改公钥文件相应权限</p><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">~ <span class="keyword">chmod</span> <span class="number">600</span> ~<span class="regexp">/.ssh/au</span>thorized_keys <span class="comment">#只有拥有者有读写权限</span></span><br><span class="line">~ <span class="keyword">chmod</span> <span class="number">700</span> ~/.ssh <span class="comment">#只有拥有者有读、写、执行权限</span></span><br></pre></td></tr></table></figure><p>返回本地终端，测试是否可以连上 vps</p><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ssh -v git<span class="doctag">@VPS</span>_IP</span></span><br></pre></td></tr></table></figure><p>应该可以免密用 git 用户登录 vps</p><h2 id="6-确定网站路径"><a href="#6-确定网站路径" class="headerlink" title="6.确定网站路径"></a>6.确定网站路径</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/home/gi</span>t<span class="regexp">/blog/</span>blog.git <span class="comment">#git仓库</span></span><br><span class="line"><span class="regexp">/var/</span>www/blog           <span class="comment">#网站根目录</span></span><br></pre></td></tr></table></figure><h2 id="7-初始化-git-仓库"><a href="#7-初始化-git-仓库" class="headerlink" title="7.初始化 git 仓库"></a>7.初始化 git 仓库</h2><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line">~ <span class="keyword">cd</span> <span class="string">/home/git</span></span><br><span class="line">~ git init <span class="params">--bare</span> blog.git  <span class="comment">#参数 --bare ，创建一个裸仓库，不包含工作区</span></span><br></pre></td></tr></table></figure><h2 id="8-配置-git-hook"><a href="#8-配置-git-hook" class="headerlink" title="8.配置 git hook"></a>8.配置 git hook</h2><p>在 blog.git/hooks 目录下新建一个 post-receive 文件,加入以下内容</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">～ vim post-receive</span><br><span class="line"></span><br><span class="line">GIT_REPO=<span class="regexp">/home/gi</span>t/blog.git   <span class="comment">#仓库路径</span></span><br><span class="line">TMP_GIT_CLONE=<span class="regexp">/tmp/</span>blog          <span class="comment">#临时目录</span></span><br><span class="line">PUBLIC_WWW=<span class="regexp">/var/</span>www/blog      <span class="comment">#网站路径</span></span><br><span class="line">rm -rf <span class="variable">$&#123;TMP_GIT_CLONE&#125;</span></span><br><span class="line">git clone <span class="variable">$GIT_REPO</span> <span class="variable">$TMP_GIT_CLONE</span></span><br><span class="line">rm -rf <span class="variable">$&#123;PUBLIC_WWW&#125;</span>/*</span><br><span class="line">cp -rf <span class="variable">$&#123;TMP_GIT_CLONE&#125;</span>/* <span class="variable">$&#123;PUBLIC_WWW&#125;</span></span><br></pre></td></tr></table></figure><p>添加post-receive文件的可执行权限</p><figure class="highlight erlang"><table><tr><td class="code"><pre><span class="line">～ chmod +x post-<span class="keyword">receive</span></span><br></pre></td></tr></table></figure><h2 id="9-创建网站目录"><a href="#9-创建网站目录" class="headerlink" title="9.创建网站目录"></a>9.创建网站目录</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"># mkdir -<span class="selector-tag">p</span> /<span class="selector-tag">var</span>/www/blog</span><br></pre></td></tr></table></figure><h2 id="10-配置-hexo-推送"><a href="#10-配置-hexo-推送" class="headerlink" title="10.配置 hexo 推送"></a>10.配置 hexo 推送</h2><p>编辑 hexo 的 _config.yml 加入以下内容：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">repo:</span></span><br><span class="line">    <span class="attr">blog-vps:</span> <span class="string">git@VPS_IP:blog.git</span></span><br><span class="line">  <span class="attr">message:</span> <span class="string">blog</span> <span class="string">update</span></span><br></pre></td></tr></table></figure><h2 id="11-本地推送网站文件到-vps"><a href="#11-本地推送网站文件到-vps" class="headerlink" title="11.本地推送网站文件到 vps"></a>11.本地推送网站文件到 vps</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># hexo d</span></span><br></pre></td></tr></table></figure><p>查看网站目录是否生成网站文件</p><p>之后还需要配置 nginx 等，本文不讨论。</p><hr><h2 id="步骤来源于网上，略作修改"><a href="#步骤来源于网上，略作修改" class="headerlink" title="步骤来源于网上，略作修改"></a>步骤来源于网上，略作修改</h2>]]></content>
    
    
    <summary type="html">&lt;p&gt;hexo 可以部署在github，conding。当有了一个 vps 之后可以把 hexo 部署到 vps ,步骤如下：&lt;/p&gt;
&lt;h2 id=&quot;1-安装-Git&quot;&gt;&lt;a href=&quot;#1-安装-Git&quot; class=&quot;headerlink&quot; title=&quot;1.安装 Git&quot;&gt;&lt;/a&gt;1.安装 Git&lt;/h2&gt;&lt;figure class=&quot;highlight vala&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# apt install git&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;2-创建-git-用户&quot;&gt;&lt;a href=&quot;#2-创建-git-用户&quot; class=&quot;headerlink&quot; title=&quot;2.创建 git 用户&quot;&gt;&lt;/a&gt;2.创建 git 用户&lt;/h2&gt;&lt;figure class=&quot;highlight clean&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# adduser git  #根据提示设置密码。&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;3-赋予git用户sudo权限&quot;&gt;&lt;a href=&quot;#3-赋予git用户sudo权限&quot; class=&quot;headerlink&quot; title=&quot;3.赋予git用户sudo权限&quot;&gt;&lt;/a&gt;3.赋予git用户sudo权限&lt;/h2&gt;&lt;p&gt;编辑 sudoers 文件加入以下内容&lt;/p&gt;
&lt;figure class=&quot;highlight apache&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;vim&lt;/span&gt; /etc/sudoers&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# User privilege specification&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;root&lt;/span&gt;    &lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;=(&lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;) &lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;git&lt;/span&gt;     &lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;=(&lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;:&lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt;) &lt;span class=&quot;literal&quot;&gt;ALL&lt;/span&gt; #添加此行内容&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.sunmite.com/categories/linux/"/>
    
    
    <category term="linux" scheme="https://www.sunmite.com/tags/linux/"/>
    
    <category term="hexo" scheme="https://www.sunmite.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 的基本概念和术语</title>
    <link href="https://www.sunmite.com/kubernetes/basic-concepts-and-terms-of-kubernetes.html"/>
    <id>https://www.sunmite.com/kubernetes/basic-concepts-and-terms-of-kubernetes.html</id>
    <published>2019-10-21T06:24:10.000Z</published>
    <updated>2021-01-25T02:17:02.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><p>Kubernetes 里的 Master 指的是集群的控制节点，负责整个集群的管理和控制。<br>在 Master 上运行中以下关键进程：</p><ul><li>Kubernetes API Server（kube-apiserver）：提供了 HTTP Rest 接口的关键服务进程，是 Kubernetes 里所有资源的增删改查等操作的唯一入口，也是集群控制的入口进程</li><li>Kubernetes Controller Manager（kube-controller-manager）：Kubernetes 里所有资源对象的自动化控制中心</li><li>Kubernetes Scheduler（kube-scheduler）：负责资源调度（Pod 调度）的进程<br>此外在 Master 上通常还需要不是 etcd 服务，因为 Kubernetes 里的所有资源对象的数据都被保存在 etcd 中。<span id="more"></span></li></ul><h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p>Node 是 Kubernetes 集群中的工作负载的节点，每个 Node 都会被 Master 分配一些工作负载（docker 容器）。<br>在 Node 上运行着以下关键进程：</p><ul><li>kubelet：负责 Pod 对应的容器的创建、启停等任务，同时与 Master 密切协助，实现集群管理的基本功能</li><li>kube-proxy：实现 Kubernetes Service 的通信与负载均衡机制的重要组件</li><li>Docker Engine（Docker）：Docker 引擎，负责本机的容器创建和管理工作</li></ul><h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p>每个 Pod 都有一个特殊的被称为“根容器”的 Pause 容器，除了 Pause 容器，每个 Pod 还包含一个或多个紧密相关的用户业务容器。<br>Kubernetes 为每个 Pod 都分配了一个唯一的 IP 地址，称之为 Pod IP，一个 Pod 里的多个容器共享 Pod IP 地址。<br>在 Kubernetes 里，一个 Pod 里的容器与另外主机上的 Pod 里的容器能够直接通信。<br>为什么要有一个 Pause 容器？<br>1.引入业务无关的且不易死亡的 Pause 容器作为 Pod 的根容器，以它的状态代表整个容器组的状态。<br>2.Pod 里的多个业务容器共享 Pause 容器的 IP，共享 Pause 容器挂载的 Volume，简化了密切关联的业务容器之间的通信问题，也解决了他们之间的文件共享问题。</p><h2 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h2><p>Label（标签）是 Kubernetes 系统中另外一个核心概念。一个 Label 是一个 key=value 的键值对，其中 key 与 value 由用户自己指定。Label 可以被附加到各种资源对象上，例如 Node、Pod、Service、RC 等，一个资源对象可以定义任意数量的 Label ，同一个 Label 也可以被添加到任意数量的资源对象上。Label 通常在资源对象定义的时确定，也可以在对象创建后动态的添加或者删除。</p><h2 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h2><p>RC 的定义包括以下几个部分：</p><ul><li>Pod 期待的副本数量</li><li>用于筛选目标 Pod 的 Label Selector </li><li>当 Pod 的副本数量小于预期数量时，用于创建新 Pod 的 Pod 模板（template）<br>Replica Set 与 Deployment 这两个重要的资源对象逐步替代了之前 RC 的作用。<br>RC(Replica Set)的一些特性与作用：</li><li>在大多数的情况下，我们通过定义一个 RC 实现 Pod 的创建及副本数量的自动控制</li><li>在 RC 里包括完成的 Pod 定义模板</li><li>RC 通过 Label Selector 机制实现对 Pod 副本的自动控制</li><li>通过改变 RC 里的 Pod 副本数量，可以实现 Pod 的扩容和缩容</li><li>通过改变 RC 里 Pod 模板中的镜像版本，可以实现 Pod 的滚动升级</li></ul><h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>Deployment 内部使用了 Replica Set 来实现目的。<br>Deployment 的典型使用场景有以下几个：</p><ul><li>创建一个 Deployment 对象来生成对应的 Replica Set 并完成 Pod 副本的创建</li><li>检查 Deployment 的状态来看部署动作是否完成（Pod 副本数量是否达到预期的值）</li><li>更新 Deployment 以创建新的 Pod（比如镜像升级）</li><li>如果当前 Deployment 不稳定，则回滚到一个早先的 Deployment 版本</li><li>暂停 Deployment 以便于一次性修改多个 PodTemplateSpec 的配置项，之后在恢复 Deployment ，进行先得发布</li><li>扩展 Deployment 以应对高负载</li><li>查看 Deployment 的状态，以此作为发布是否成功的指标</li><li>清理不再需要的旧版本 ReplicaSets</li></ul><h2 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h2><p>Horizontal Pod Autoscaler（Pod 横向自动扩容，HPA）通过追踪分析指定 RC 控制的所有目标 Pod 的负载变化情况，来确定是否需要有针对性的调整目标 Pod 的副本数量。<br>HPA 有以下两种方式作为 Pod 负载的度量指标：</p><ul><li>CPUUtilizationPercenta</li><li>应用程序自定义的度量指标，比如服务在每秒内的请求数（TPS 或 QPS)</li></ul><h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>在 Kubernetes 系统中，Pod 的管理对象 RC、Deployment、DaemonSet 和 Job 都面向无状态的服务。<br>StatefulSet 从本质上来说，可以看作 Deployment/RC 的一个特殊变种，它有如下特性：</p><ul><li>StatefulSet 里的每个 Pod 都有稳定、唯一的网络标识，可以用来发现集群内的其他成员</li><li>StatefulSet 控制的 Pod 副本启停顺序是受控的，操作第 n 个 Pod 时，前 n-1 个 Pod 已经是运行且准备好的状态</li><li>StatefulSet 里的 Pod 采用稳定的持久化存储卷，通过 PV 或 PVC 来实现，删除 Pod 时默认不会删除与 StatefulSet 相关的存储卷。</li></ul><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>Kubernetes 的 Service 定义了一个服务的访问入口地址，每个 Service 都有唯一的 Cluster IP 及唯一的名称。<br>Kubernetes 里的 3 种 IP:</p><ul><li>Node IP: Node 的 IP 地址</li><li>Pod IP: Pod 的 IP 地址</li><li>Cluster IP: Service 的 IP 地址</li></ul><h2 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h2><p>Job 控制一组 Pod 容器，Job 也是一种特殊的 Pod 副本自动控制器。Job 控制 Pod 副本与 RC 等控制器的工作机制有以下区别：</p><ol><li>Job 所控制的 Pod 副本是短暂运行的，可以将其视为一组 Docker 容器，其中每个 Docker 容器都仅运行一次。当 Job 控制的所有 Pod 副本都运行结束时，对应的 Job 也就结束了。Job 在实现方式上与 RC 等副本控制器不同，Job 生成的 Pod 副本是不能自动重启的，对应 Pod 副本的 RestartPolicy 都被设置为 Never.</li><li>Job 所控制的 Pod 副本的工作模式能够多实例并行计算。</li></ol><h2 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h2><p>Volume 是 Pod 中能够被多个容器访问的共享目录。<br>Kubernetes 提供了以下的 Volume 类型：</p><ol><li>emptyDir<br>一个 emptyDir Volume 是在 Pod 分配到 Node 的时创建的。他的初始内容为空，并且无需指定宿主机上对应的目录文件。Kubernetes 自动分配一个目录，当 Pod 从 Node 上面移除时， emptyDir 中的数据也会被永久删除。emptyDir 的一些用途如下：</li></ol><ul><li>临时空间，例如某些程序运行时所需的临时目录</li><li>长时间任务的中间过程 CheckPoint 的临时保存目录</li><li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）</li></ul><ol start="2"><li>hostPath<br>hostPath 为在 Pod 上挂载宿主机上的文件或目录，通常用于以下几个方面：</li></ol><ul><li>容器应用程序生成的日志文件需要永久保存时，可以使用宿主机的高速文件系统进行存储</li><li>需要访问宿主机上 Docker 引擎内部数据结构的容器应用时，可以通过定义 hostPath 为宿主机 /var/lib/docker 目录，使容器内部应用可以直接访问 Docker 的文件系统<br>在使用 hostpath 时，需要注意以下几点：</li><li>在不同的 Node 上具有相同配置的 Pod，可能会因为宿主机上的目录和文件不同而导致 Volume 上目录和文件的访问结果不一致</li><li>如果使用了资源配额管理，则 Kubernetes 无法将 hostPath 在宿主机上使用的资源纳入管理</li></ul><ol start="3"><li><p>gcePersistentDisk<br>使用谷歌云提供永久磁盘，当 Pod 被删除时，PD 只是被卸载，不会被删除。需要在谷歌云环境中使用。</p></li><li><p>awsElasticBlockStore<br>使用 AWS 提供的 EBS Volume 存储数据，需要在 AWS 环境中使用。</p></li><li><p>NFS<br>使用 NFS 网络文件系统提供共享目录存储数据。</p></li><li><p>其他类型的 Volume</p></li></ol><ul><li>iscsi: 使用 iSCSI 存储设备上的目录挂载到 Pod 中</li><li>flocker: 使用 Flocker 管理存储卷</li><li>glusterfs: 使用开源 GlusterFS 网络文件系统的目录挂载到 Pod 中</li><li>rbd: 使用 Ceph 块设备共享存储挂载到 Pod 中</li><li>gitRepo: 通过挂载一个空目录，并从 Git 库 clone 一个git repository 供 Pod 使用</li><li>secret: 一个 Secret Volume 用于为 Pod 提供加密的信息，可以将定义在 Kubernetes 中的 Secret 直接挂载为文件让 Pod 访问。</li></ul><h2 id="Persistent-Volume"><a href="#Persistent-Volume" class="headerlink" title="Persistent Volume"></a>Persistent Volume</h2><p>PV 可以被理解成 Kubernetes 集群中的某个网络存储对应的一块存储，它与 Volume 类似，但有以下区别。</p><ul><li>PV 只能是网络存储，不属于任何 Node,但可以在每个 Node 上访问</li><li>Pv 并不是定义在 Pod 上，而是独立于 Pod 之外定义的       </li><li>PV 目前支持的类型包括: gcePersistentDisk、awsElasticBlockStore、AzureFile、AzureDisk、FC、Flocker、NFC、iSCSI、RBD、CephFS、Cinder、GlusterFS、VsphereVolume、Quobyte Volumes、VMware Photon、Portworx Volumes、ScaleIO Volumes 和 hostPath（仅供单机测试）</li></ul><p>PV 的 accessModes 属性：</p><ul><li>ReadWriteOnce: 读写权限，并且只能被单个 Node 挂载</li><li>ReadOnlyMany: 只读权限，允许被多个 Node 挂载</li><li>ReadWriteMany: 读写权限，允许被多个 Node 挂载</li></ul><p>PV 的状态：</p><ul><li>Available：空闲状态</li><li>Bound: 已经绑定到某个 PVC 上面</li><li>Released: 对应的 PVC 已经被删除，但是资源还没有被集群回收</li><li>Failed: PV 自动回收失败</li></ul><h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>Namespace 在很多情况下用于实现多租户的资源隔离，可以给每个租户创建一个 Namespace 来实现多租户的资源隔离。</p><h2 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h2><p>Annotation 与 Label 类似，也使用 key/value 键值对的形式进行定义。不同的是 Label 就有严格的命名规则，它定义的是 Kubernetes 对象的元数据，并且用于 Label Selector。Annotation 则是用户任意定义的附加信息，以便于外部工具查找。Kubernetes 的模块自身会通过 Annotation 标记资源对象的一些特殊信息。<br>通常来说，用 Annotation 来记录的信息如下：</p><ul><li>build 信息、release 信息、Docker 镜像信息等，例如书简戳、release id 号、PR 号、镜像 Hash 值、Docker registry 地址等</li><li>日志库、监控库、分析库等资源库的信息</li><li>程序调试工具信息，例如工具名称、版本号等</li><li>团队的联系信息，例如电话号码、负责人名称、网址等</li></ul><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>首先，把所有的配置项都当作 key-value 字符串，这些配置项可以作为 Map 表中的一个项，整个 Map 的数据可以被持久化存储在 Kubernetes 的 Etcd 数据库中，然后提供 API 以方便 Kubernetes 相关组件或客户应用 CRUD 操作这些数据，上述专门用于保存配置参数的 Map 就是 Kubernetes ConfigMap 资源对象。<br>接下来，Kubernetes 提供了一种内建机制，将存储在 etcd 中的 ConfigMap 通过 Volume 映射的方式变成目标 Pod 内的配置文件，不管 Pod 被调度到哪台服务器上，都会完成自动映射。进一步地，如果 ConfigMap 中的 key-value 数据被修改，则映射到 Pod 中的“配置文件”也会随之更新。</p><hr><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>整理自 《Kubernetes 权威指南（第4版）》</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Master&quot;&gt;&lt;a href=&quot;#Master&quot; class=&quot;headerlink&quot; title=&quot;Master&quot;&gt;&lt;/a&gt;Master&lt;/h2&gt;&lt;p&gt;Kubernetes 里的 Master 指的是集群的控制节点，负责整个集群的管理和控制。&lt;br&gt;在 Master 上运行中以下关键进程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubernetes API Server（kube-apiserver）：提供了 HTTP Rest 接口的关键服务进程，是 Kubernetes 里所有资源的增删改查等操作的唯一入口，也是集群控制的入口进程&lt;/li&gt;
&lt;li&gt;Kubernetes Controller Manager（kube-controller-manager）：Kubernetes 里所有资源对象的自动化控制中心&lt;/li&gt;
&lt;li&gt;Kubernetes Scheduler（kube-scheduler）：负责资源调度（Pod 调度）的进程&lt;br&gt;此外在 Master 上通常还需要不是 etcd 服务，因为 Kubernetes 里的所有资源对象的数据都被保存在 etcd 中。</summary>
    
    
    
    <category term="kubernetes" scheme="https://www.sunmite.com/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://www.sunmite.com/tags/kubernetes/"/>
    
    <category term="docker" scheme="https://www.sunmite.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>黑苹果配置</title>
    <link href="https://www.sunmite.com/MacOS/hackintosh.html"/>
    <id>https://www.sunmite.com/MacOS/hackintosh.html</id>
    <published>2019-08-29T01:49:07.000Z</published>
    <updated>2021-01-25T02:17:02.363Z</updated>
    
    <content type="html"><![CDATA[<p>家里目前使用的台式机虽说性能还行，但是自从使用了 MBP 之后感觉 macOS 系统更加好用。总想在家里折腾一套，官方的 Mac mini 是个不错的选择，但是价格就……想了想不如重新组一套 itx 或者 matx 用来装黑苹果，岂不是美滋滋。</p><span id="more"></span><p>选取了对黑苹果友好的一些硬件配置，部分配置还是可以缩一缩，毕竟能用就行。表格如下：</p><table><thead><tr><th>种类</th><th>品牌型号</th><th>单价</th><th>数量</th><th>总额</th></tr></thead><tbody><tr><td>CPU</td><td>Intel Core i5 9600K</td><td></td><td></td><td></td></tr><tr><td>主板</td><td>ASRock Z390M Pro4</td><td></td><td></td><td></td></tr><tr><td>内存</td><td>芝奇幻光戟 DDR4 3200 8Gx2（C16）</td><td></td><td></td><td></td></tr><tr><td>SSD</td><td>西数黑盘 M.2接口 500GB SSD（3470MB/s） or   西数蓝盘 M.2接口 500GB SSD（1700MB/s）</td><td></td><td></td><td></td></tr><tr><td>显卡</td><td>蓝宝石（Sapphire）Radeon RX Vega 56 8G</td><td></td><td></td><td></td></tr><tr><td>蓝牙/无线</td><td>BCM943602CS 四天线</td><td></td><td></td><td></td></tr><tr><td>电源</td><td>振华（SUPER FLOWER）650W LEADEX G 650</td><td></td><td></td><td></td></tr><tr><td>散热器</td><td>采融（Prolimatech）ARTISTS 3i</td><td></td><td></td><td></td></tr><tr><td>机箱</td><td>追风者（PHANTEKS）MG 410 黑色 RGB mATX</td><td></td><td></td><td></td></tr><tr><td>显示器</td><td></td><td></td><td></td><td></td></tr><tr><td>其他</td><td></td><td></td><td></td><td></td></tr></tbody></table><p>备注：</p><p>显卡：RX 590 或 vega56（真正免驱，无需搭配集显也可完全硬件加速）</p><p>蓝牙/无线：苹果机同款的 BCM943602CS 是免驱卡，WIFI带蓝牙二合一，四天线的，即插即用。（三天线的蓝牙和2.4G无线冲突） + M.2转接卡 + 天线</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;家里目前使用的台式机虽说性能还行，但是自从使用了 MBP 之后感觉 macOS 系统更加好用。总想在家里折腾一套，官方的 Mac mini 是个不错的选择，但是价格就……想了想不如重新组一套 itx 或者 matx 用来装黑苹果，岂不是美滋滋。&lt;/p&gt;</summary>
    
    
    
    <category term="MacOS" scheme="https://www.sunmite.com/categories/MacOS/"/>
    
    
    <category term="macos" scheme="https://www.sunmite.com/tags/macos/"/>
    
  </entry>
  
  <entry>
    <title>MacOS 上让 iTerm2 记住SSH用户名密码</title>
    <link href="https://www.sunmite.com/MacOS/use-expect-remember-passwd.html"/>
    <id>https://www.sunmite.com/MacOS/use-expect-remember-passwd.html</id>
    <published>2019-02-22T01:15:00.000Z</published>
    <updated>2021-01-25T02:17:02.333Z</updated>
    
    <content type="html"><![CDATA[<p>win下习惯使用 xshell，但是 xshell 并无 MacOS 版。了解到了 iterm2 这款软件，通过一些改造也能实现类似的效果。</p><h3 id="1-安装-expect"><a href="#1-安装-expect" class="headerlink" title="1. 安装 expect"></a>1. 安装 expect</h3><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>expect</span><br></pre></td></tr></table></figure><p>如果遇到 man 目录的权限问题可以执行以下命令后在执行安装命令</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo chown -R $(whoami) <span class="regexp">/usr/</span>local<span class="regexp">/share/m</span>an/man5</span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="2-创建-except-脚本"><a href="#2-创建-except-脚本" class="headerlink" title="2. 创建 except 脚本"></a>2. 创建 except 脚本</h3><figure class="highlight tcl"><table><tr><td class="code"><pre><span class="line">sudo vim /usr/local/bin/iterm2login.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> timeout <span class="number">30</span></span><br><span class="line">spawn ssh -p [<span class="keyword">lindex</span> $argv <span class="number">0</span>] [<span class="keyword">lindex</span> $argv <span class="number">1</span>]@[<span class="keyword">lindex</span> $argv <span class="number">2</span>]</span><br><span class="line">expect &#123;</span><br><span class="line">        <span class="string">&quot;(yes/no)?&quot;</span></span><br><span class="line">        &#123;send <span class="string">&quot;yes\n&quot;</span>;exp_continue&#125;</span><br><span class="line">        <span class="string">&quot;password:&quot;</span></span><br><span class="line">        &#123;send <span class="string">&quot;[lindex $argv 3]\n&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure><p>这里[lindex $argv 0]， [lindex $argv 1]，[lindex $argv 2]， [lindex $argv 3] 分别代表着 <strong>端口号 用户名 服务器地址 密码</strong> 4个参数。<br>还需要给脚本执行权限</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo chmod +x <span class="regexp">/usr/</span>local<span class="regexp">/bin/i</span>term2login.sh</span><br></pre></td></tr></table></figure><h3 id="3-新建-profiles"><a href="#3-新建-profiles" class="headerlink" title="3. 新建 profiles"></a>3. 新建 profiles</h3><p>iTerm2 -&gt; Preferences -&gt; Profiles<br>为每个服务器的连接, 打上不同的Tag, 就自动按Tag分好组了.<br><img data-src="/images/uploads/2019/02/1.jpg" alt="创建profiles"><br>另外 还可以在Colors中设置每个打开Tab 的颜色. 多个项目同时操作也不怕搞错了.<br><img data-src="/images/uploads/2019/02/2.jpg" alt="tab color"><br><img data-src="/images/uploads/2019/02/3.jpg" alt="tab"></p><h3 id="4-最终效果"><a href="#4-最终效果" class="headerlink" title="4. 最终效果"></a>4. 最终效果</h3><p>如图，使用起来方便多了<br><img data-src="/images/uploads/2019/02/4.jpg" alt="最终效果"></p><hr><h3 id="方法来源于网上，稍作修改"><a href="#方法来源于网上，稍作修改" class="headerlink" title="方法来源于网上，稍作修改"></a>方法来源于网上，稍作修改</h3>]]></content>
    
    
    <summary type="html">&lt;p&gt;win下习惯使用 xshell，但是 xshell 并无 MacOS 版。了解到了 iterm2 这款软件，通过一些改造也能实现类似的效果。&lt;/p&gt;
&lt;h3 id=&quot;1-安装-expect&quot;&gt;&lt;a href=&quot;#1-安装-expect&quot; class=&quot;headerlink&quot; title=&quot;1. 安装 expect&quot;&gt;&lt;/a&gt;1. 安装 expect&lt;/h3&gt;&lt;figure class=&quot;highlight mipsasm&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;brew &lt;/span&gt;&lt;span class=&quot;keyword&quot;&gt;install &lt;/span&gt;expect&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;如果遇到 man 目录的权限问题可以执行以下命令后在执行安装命令&lt;/p&gt;
&lt;figure class=&quot;highlight awk&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo chown -R $(whoami) &lt;span class=&quot;regexp&quot;&gt;/usr/&lt;/span&gt;local&lt;span class=&quot;regexp&quot;&gt;/share/m&lt;/span&gt;an/man5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="MacOS" scheme="https://www.sunmite.com/categories/MacOS/"/>
    
    
    <category term="MacOS" scheme="https://www.sunmite.com/tags/MacOS/"/>
    
  </entry>
  
  <entry>
    <title>使用 Prometheus Operator 监控 Kubernetes</title>
    <link href="https://www.sunmite.com/docker/use-prometheus-operator-monitor-kubernetes.html"/>
    <id>https://www.sunmite.com/docker/use-prometheus-operator-monitor-kubernetes.html</id>
    <published>2019-01-09T02:29:00.000Z</published>
    <updated>2021-01-25T02:17:02.345Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Prometheus Operator 是 CoreOS 开发的基于 Prometheus 的 Kubernete s监控方案，也可能是目前功能最全面的开源方案。更多信息可以查看<a href="https://github.com/coreos/prometheus-operator">https://github.com/coreos/prometheus-operator</a></p><h1 id="部署-Prometheus-Operator"><a href="#部署-Prometheus-Operator" class="headerlink" title="部署 Prometheus Operator"></a>部署 Prometheus Operator</h1><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><h3 id="1-创建命名空间"><a href="#1-创建命名空间" class="headerlink" title="1. 创建命名空间"></a>1. 创建命名空间</h3><p>为方便管理，创建一个单独的 Namespace monitoring，Prometheus Operator 相关的组件都会部署到这个 Namespace。</p><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line"># kubectl create <span class="keyword">namespace</span> <span class="symbol">monitoring</span></span><br></pre></td></tr></table></figure><h3 id="2-导入相关镜像"><a href="#2-导入相关镜像" class="headerlink" title="2. 导入相关镜像"></a>2. 导入相关镜像</h3><p>所有节点上面导入 prometheus-operator.tar，下载地址：<a href="https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg">prometheus-operator.tar</a></p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># docker <span class="keyword">load</span> -i prometheus-<span class="keyword">operator</span>.tar</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="安装-Prometheus-Operator"><a href="#安装-Prometheus-Operator" class="headerlink" title="安装 Prometheus Operator"></a>安装 Prometheus Operator</h2><h3 id="1-使用-Helm-安装-Prometheus-Operator"><a href="#1-使用-Helm-安装-Prometheus-Operator" class="headerlink" title="1. 使用 Helm 安装 Prometheus Operator"></a>1. 使用 Helm 安装 Prometheus Operator</h3><p>Prometheus Operator 所有的组件都打包成 Helm Chart，安装部署非常方便。</p><figure class="highlight delphi"><table><tr><td class="code"><pre><span class="line"># helm install --<span class="keyword">name</span> prometheus-<span class="keyword">operator</span> --namespace=monitoring stable/prometheus-<span class="keyword">operator</span></span><br></pre></td></tr></table></figure><h3 id="2-查看创建的资源"><a href="#2-查看创建的资源" class="headerlink" title="2. 查看创建的资源"></a>2. 查看创建的资源</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get all -n monitoring </span></span><br><span class="line"><span class="attribute">NAME</span>                                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="attribute">pod</span>/alertmanager-prometheus-operator-alertmanager-<span class="number">0</span>           <span class="number">2</span>/<span class="number">2</span>     Running   <span class="number">0</span>          <span class="number">60</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-grafana-<span class="number">6</span>c<span class="number">8</span>f<span class="number">4</span>bcfb<span class="number">4</span>-jp<span class="number">5</span>bh              <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-kube-state-metrics-<span class="number">6</span>b<span class="number">6</span>d<span class="number">6</span>b<span class="number">8</span>bbd-gff<span class="number">7</span>j   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-operator-<span class="number">76</span>f<span class="number">78</span>fd<span class="number">685</span>-<span class="number">295</span>rb             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-prometheus-node-exporter-<span class="number">44</span>tgz        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-prometheus-node-exporter-<span class="number">6</span>t<span class="number">4</span>sc        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-operator-prometheus-node-exporter-vnwrv        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">65</span>s</span><br><span class="line"><span class="attribute">pod</span>/prometheus-prometheus-operator-prometheus-<span class="number">0</span>               <span class="number">3</span>/<span class="number">3</span>     Running   <span class="number">1</span>          <span class="number">54</span>s</span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line"><span class="attribute">service</span>/alertmanager-operated                          ClusterIP   None             &lt;none&gt;        <span class="number">9093</span>/TCP,<span class="number">6783</span>/TCP   <span class="number">60</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operated                            ClusterIP   None             &lt;none&gt;        <span class="number">9090</span>/TCP            <span class="number">54</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-alertmanager               ClusterIP   <span class="number">10.105.62.219</span>    &lt;none&gt;        <span class="number">9093</span>/TCP            <span class="number">65</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-grafana                    ClusterIP   <span class="number">10.103.30.59</span>     &lt;none&gt;        <span class="number">80</span>/TCP              <span class="number">65</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-kube-state-metrics         ClusterIP   <span class="number">10.105.189.63</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">65</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-operator                   ClusterIP   <span class="number">10.105.212.90</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">65</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-prometheus                 ClusterIP   <span class="number">10.104.229.158</span>   &lt;none&gt;        <span class="number">9090</span>/TCP            <span class="number">65</span>s</span><br><span class="line"><span class="attribute">service</span>/prometheus-operator-prometheus-node-exporter   ClusterIP   <span class="number">10.103.226.249</span>   &lt;none&gt;        <span class="number">9100</span>/TCP            <span class="number">65</span>s</span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class="line"><span class="attribute">daemonset</span>.apps/prometheus-operator-prometheus-node-exporter   <span class="number">3</span>         <span class="number">3</span>         <span class="number">3</span>       <span class="number">3</span>            <span class="number">3</span>           &lt;none&gt;          <span class="number">65</span>s</span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line"><span class="attribute">deployment</span>.apps/prometheus-operator-grafana              <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">65</span>s</span><br><span class="line"><span class="attribute">deployment</span>.apps/prometheus-operator-kube-state-metrics   <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">65</span>s</span><br><span class="line"><span class="attribute">deployment</span>.apps/prometheus-operator-operator             <span class="number">1</span>/<span class="number">1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">65</span>s</span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line"><span class="attribute">replicaset</span>.apps/prometheus-operator-grafana-<span class="number">6</span>c<span class="number">8</span>f<span class="number">4</span>bcfb<span class="number">4</span>              <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">65</span>s</span><br><span class="line"><span class="attribute">replicaset</span>.apps/prometheus-operator-kube-state-metrics-<span class="number">6</span>b<span class="number">6</span>d<span class="number">6</span>b<span class="number">8</span>bbd   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">65</span>s</span><br><span class="line"><span class="attribute">replicaset</span>.apps/prometheus-operator-operator-<span class="number">76</span>f<span class="number">78</span>fd<span class="number">685</span>             <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">65</span>s</span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                                             READY   AGE</span><br><span class="line"><span class="attribute">statefulset</span>.apps/alertmanager-prometheus-operator-alertmanager   <span class="number">1</span>/<span class="number">1</span>     <span class="number">60</span>s</span><br><span class="line"><span class="attribute">statefulset</span>.apps/prometheus-prometheus-operator-prometheus       <span class="number">1</span>/<span class="number">1</span>     <span class="number">54</span>s</span><br></pre></td></tr></table></figure><h3 id="3-查看安装后的-release"><a href="#3-查看安装后的-release" class="headerlink" title="3.查看安装后的 release"></a>3.查看安装后的 release</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm list </span></span><br><span class="line"><span class="attribute">NAME</span>               REVISIONUPDATED                 STATUS  CHART                    APP VERSIONNAMESPACE </span><br><span class="line"><span class="attribute">prometheus</span>-operator<span class="number">1</span>       Tue Jan  <span class="number">8</span> <span class="number">13</span>:<span class="number">49</span>:<span class="number">12</span> <span class="number">2019</span>DEPLOYEDprometheus-operator-<span class="number">1</span>.<span class="number">5</span>.<span class="number">1</span><span class="number">0</span>.<span class="number">26</span>.<span class="number">0</span>     monitoring</span><br></pre></td></tr></table></figure><p>prometheus-operator 的 charts 会自动安装 Prometheus、Alertmanager 和 Grafana。</p><h2 id="修改访问模式"><a href="#修改访问模式" class="headerlink" title="修改访问模式"></a>修改访问模式</h2><h3 id="1-查看访问类型"><a href="#1-查看访问类型" class="headerlink" title="1. 查看访问类型"></a>1. 查看访问类型</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n monitoring </span></span><br><span class="line"><span class="attribute">NAME</span>                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line"><span class="attribute">alertmanager</span>-operated                          ClusterIP   None             &lt;none&gt;        <span class="number">9093</span>/TCP,<span class="number">6783</span>/TCP   <span class="number">7</span>m<span class="number">30</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operated                            ClusterIP   None             &lt;none&gt;        <span class="number">9090</span>/TCP            <span class="number">7</span>m<span class="number">24</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-alertmanager               ClusterIP   <span class="number">10.105.62.219</span>    &lt;none&gt;        <span class="number">9093</span>/TCP            <span class="number">7</span>m<span class="number">35</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-grafana                    ClusterIP   <span class="number">10.103.30.59</span>     &lt;none&gt;        <span class="number">80</span>/TCP              <span class="number">7</span>m<span class="number">35</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-kube-state-metrics         ClusterIP   <span class="number">10.105.189.63</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">7</span>m<span class="number">35</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-operator                   ClusterIP   <span class="number">10.105.212.90</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">7</span>m<span class="number">35</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-prometheus                 ClusterIP   <span class="number">10.104.229.158</span>   &lt;none&gt;        <span class="number">9090</span>/TCP            <span class="number">7</span>m<span class="number">35</span>s</span><br><span class="line"><span class="attribute">prometheus</span>-operator-prometheus-node-exporter   ClusterIP   <span class="number">10.103.226.249</span>   &lt;none&gt;        <span class="number">9100</span>/TCP            <span class="number">7</span>m<span class="number">35</span>s</span><br></pre></td></tr></table></figure><p>默认的访问类型为 ClusterIP 无法外部访问，只能集群内访问。</p><h3 id="2-修改-alertmanager、prometheus、grafana的访问类型"><a href="#2-修改-alertmanager、prometheus、grafana的访问类型" class="headerlink" title="2. 修改 alertmanager、prometheus、grafana的访问类型"></a>2. 修改 alertmanager、prometheus、grafana的访问类型</h3><p>grafana：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit svc prometheus-operator-grafana -n monitoring</span></span><br><span class="line"></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.103</span><span class="number">.30</span><span class="number">.59</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">prometheus-operator</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>        <span class="comment">#修改此行</span></span><br></pre></td></tr></table></figure><p>alertmanager：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit svc prometheus-operator-alertmanager -n monitoring</span></span><br><span class="line"></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.105</span><span class="number">.62</span><span class="number">.219</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9093</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">alertmanager:</span> <span class="string">prometheus-operator-alertmanager</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>       <span class="comment">#修改此行</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>prometheus：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit svc prometheus-operator-prometheus -n monitoring</span></span><br><span class="line"></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.104</span><span class="number">.229</span><span class="number">.158</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">prometheus-operator-prometheus</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>      <span class="comment">#修改此行</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><h3 id="3-查看修改后的访问类型"><a href="#3-查看修改后的访问类型" class="headerlink" title="3. 查看修改后的访问类型"></a>3. 查看修改后的访问类型</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n monitoring </span></span><br><span class="line"><span class="attribute">NAME</span>                                           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line"><span class="attribute">alertmanager</span>-operated                          ClusterIP   None             &lt;none&gt;        <span class="number">9093</span>/TCP,<span class="number">6783</span>/TCP   <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operated                            ClusterIP   None             &lt;none&gt;        <span class="number">9090</span>/TCP            <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-alertmanager               NodePort    <span class="number">10.105.62.219</span>    &lt;none&gt;        <span class="number">9093</span>:<span class="number">32645</span>/TCP      <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-grafana                    NodePort    <span class="number">10.103.30.59</span>     &lt;none&gt;        <span class="number">80</span>:<span class="number">30043</span>/TCP        <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-kube-state-metrics         ClusterIP   <span class="number">10.105.189.63</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-operator                   ClusterIP   <span class="number">10.105.212.90</span>    &lt;none&gt;        <span class="number">8080</span>/TCP            <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-prometheus                 NodePort    <span class="number">10.104.229.158</span>   &lt;none&gt;        <span class="number">9090</span>:<span class="number">32275</span>/TCP      <span class="number">23</span>m</span><br><span class="line"><span class="attribute">prometheus</span>-operator-prometheus-node-exporter   ClusterIP   <span class="number">10.103.226.249</span>   &lt;none&gt;        <span class="number">9100</span>/TCP            <span class="number">23</span>m</span><br></pre></td></tr></table></figure><h2 id="修改-kubelet-打开只读端口"><a href="#修改-kubelet-打开只读端口" class="headerlink" title="修改 kubelet 打开只读端口"></a>修改 kubelet 打开只读端口</h2><p>prometheus 需要访问 kubelet 的 10255 端口获取 metrics。但是默认情况下 10255 端口是不开放的，会导致 prometheus 上有 unhealthy，如下图：<br><img data-src="/images/uploads/2019/01/unhealthy.png" alt="unhealthy"><br>打开只读端口需要编辑所有节点的 /var/lib/kubelet/config.yaml 文件，加入以下内容</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># /var/lib/kubelet/config.yaml</span></span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"><span class="symbol">oomScoreAdj:</span> <span class="number">-999</span></span><br><span class="line"><span class="symbol">podPidsLimit:</span> <span class="number">-1</span></span><br><span class="line"><span class="symbol">port:</span> <span class="number">10250</span></span><br><span class="line"><span class="symbol">readOnlyPort:</span> <span class="number">10255</span>          <span class="meta">#增加此行</span></span><br><span class="line"><span class="symbol">registryBurst:</span> <span class="number">10</span></span><br><span class="line"><span class="symbol">registryPullQPS:</span> <span class="number">5</span></span><br><span class="line"><span class="symbol">resolvConf:</span> <span class="meta-keyword">/etc/</span>resolv.conf</span><br></pre></td></tr></table></figure><p>重启 kubelet 服务</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl restart kubelet.service</span></span><br></pre></td></tr></table></figure><p>查看 prometheus target<br><img data-src="/images/uploads/2019/01/healthy.png" alt="healthy"></p><h1 id="访问-dashboard"><a href="#访问-dashboard" class="headerlink" title="访问 dashboard"></a>访问 dashboard</h1><ol><li><p> Pormetheus 的 Web UI<br>访问地址为：<a href="http://nodeip:32275/target%EF%BC%8C%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A">http://nodeip:32275/target，如下图：</a><br><img data-src="/images/uploads/2019/01/prometheus.png" alt="prometheus"></p></li><li><p>Alertmanager 的 Web UI<br>访问地址为：<a href="http://nodeip:32645/%EF%BC%8C%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A">http://nodeip:32645/，如下图：</a><br><img data-src="/images/uploads/2019/01/alertmanager.png" alt="alertmanager"></p></li><li><p>Grafana Dashboard<br>访问地址为：<a href="http://nodeip:30043/%EF%BC%8C%E9%BB%98%E8%AE%A4%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D/%E5%AF%86%E7%A0%81%E4%B8%BA%EF%BC%9Aadmin/prom-operator%EF%BC%8C%E7%99%BB%E9%99%86%E5%90%8E%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A">http://nodeip:30043/，默认的用户名/密码为：admin/prom-operator，登陆后如下图：</a><br><img data-src="/images/uploads/2019/01/grafana.png" alt="grafana"><br><img data-src="/images/uploads/2019/01/grafana-1.png" alt="grafana-1"><br><img data-src="/images/uploads/2019/01/grafana-2.png" alt="grafana-2"></p></li></ol><h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><h2 id="1-prometheus-operator-coredns-无数据"><a href="#1-prometheus-operator-coredns-无数据" class="headerlink" title="1. prometheus-operator-coredns 无数据"></a>1. prometheus-operator-coredns 无数据</h2><p>问题详情见：<a href="https://github.com/coreos/prometheus-operator/issues/2110">Don’t scrape metrics from coreDNS</a><br>解决方法如下：修改 prometheus-operator-coredns 服务的 selector 为 kube-dns</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl edit svc prometheus-operator-coredns  -n kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http-metrics</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9153</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9153</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-dns</span>         <span class="comment">#修改此行</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><h2 id="2-prometheus-operator-kube-etcd-无数据"><a href="#2-prometheus-operator-kube-etcd-无数据" class="headerlink" title="2. prometheus-operator-kube-etcd 无数据"></a>2. prometheus-operator-kube-etcd 无数据</h2><p>prometheus 通过 4001 端口访问 etcd metrics，但是 etcd 默认监听 2379。<br>解决方法如下：</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/etc/</span>kubernetes<span class="regexp">/manifests/</span>etcd.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    scheduler.alpha.kubernetes.io/critical-pod: <span class="string">&quot;&quot;</span></span><br><span class="line">  creationTimestamp: <span class="keyword">null</span></span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: etcd-server                                                       #增加此行</span><br><span class="line">    component: etcd</span><br><span class="line">    tier: control-plane</span><br><span class="line">  name: etcd</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - command:</span><br><span class="line">    - etcd</span><br><span class="line">    - --advertise-client-urls=https:<span class="comment">//172.20.6.116:2379</span></span><br><span class="line">    - --cert-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/server.crt</span><br><span class="line">    - --client-cert-auth=<span class="keyword">true</span></span><br><span class="line">    - --data-dir=<span class="regexp">/var/</span>lib/etcd</span><br><span class="line">    - --initial-advertise-peer-urls=https:<span class="comment">//172.20.6.116:2380</span></span><br><span class="line">    - --initial-cluster=k8s-master=https:<span class="comment">//172.20.6.116:2380</span></span><br><span class="line">    - --key-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/server.key</span><br><span class="line">    - --listen-client-urls=https:<span class="comment">//127.0.0.1:2379,https://172.20.6.116:2379,http://172.20.6.116:4001         #增加 4001 端口的 http 监听</span></span><br><span class="line">    - --listen-peer-urls=https:<span class="comment">//172.20.6.116:2380</span></span><br><span class="line">    - --name=k8s-master</span><br><span class="line">    - --peer-cert-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/peer.crt</span><br><span class="line">    - --peer-client-cert-auth=<span class="keyword">true</span></span><br><span class="line">    - --peer-key-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/peer.key</span><br><span class="line">    - --peer-trusted-ca-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/ca.crt</span><br><span class="line">    - --snapshot-<span class="keyword">count</span>=<span class="number">10000</span></span><br><span class="line">    - --trusted-ca-<span class="keyword">file</span>=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/pki/</span>etcd/ca.crt</span><br></pre></td></tr></table></figure><p>重启 kubelet 服务即可</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl restart kubelet.service</span></span><br></pre></td></tr></table></figure><h2 id="3-prometheus-operator-kube-controller-manager-和-prometheus-operator-kube-scheduler-无数据"><a href="#3-prometheus-operator-kube-controller-manager-和-prometheus-operator-kube-scheduler-无数据" class="headerlink" title="3. prometheus-operator-kube-controller-manager 和 prometheus-operator-kube-scheduler 无数据"></a>3. prometheus-operator-kube-controller-manager 和 prometheus-operator-kube-scheduler 无数据</h2><p>由于 kube-controller-manager 和 kube-scheduler 默认监听 127.0.0.1 ，prometheus 无法通过本机地址获取数据，需要修改kube-controller-manager 和 kube-scheduler 监听地址。<br>解决办法如下：<br>kube-controller-manager:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-controller-manager</span>               <span class="comment">#增加此行</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-controller-manager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-controller-manager</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--address=0.0.0.0</span>                                   <span class="comment">#修改监听地址</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--allocate-node-cidrs=true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>kube-scheduler:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/kubernetes/manifests/kube-scheduler.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kube-scheduler</span>                         <span class="comment">#增加此行</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--address=0.0.0.0</span>                                   <span class="comment">#修改监听地址</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-elect=true</span></span><br></pre></td></tr></table></figure><p>重启 kubelet 服务即可</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl restart kubelet.service</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;Prometheus Operator 是 CoreOS 开发的基于 Prometheus 的 Kubernete s监控方案，也可能是目前功能最全面的开源方案。更多信息可以查看&lt;a href=&quot;https://github.com/coreos/prometheus-operator&quot;&gt;https://github.com/coreos/prometheus-operator&lt;/a&gt;&lt;/p&gt;
&lt;h1 id=&quot;部署-Prometheus-Operator&quot;&gt;&lt;a href=&quot;#部署-Prometheus-Operator&quot; class=&quot;headerlink&quot; title=&quot;部署 Prometheus Operator&quot;&gt;&lt;/a&gt;部署 Prometheus Operator&lt;/h1&gt;&lt;h2 id=&quot;前期准备&quot;&gt;&lt;a href=&quot;#前期准备&quot; class=&quot;headerlink&quot; title=&quot;前期准备&quot;&gt;&lt;/a&gt;前期准备&lt;/h2&gt;&lt;h3 id=&quot;1-创建命名空间&quot;&gt;&lt;a href=&quot;#1-创建命名空间&quot; class=&quot;headerlink&quot; title=&quot;1. 创建命名空间&quot;&gt;&lt;/a&gt;1. 创建命名空间&lt;/h3&gt;&lt;p&gt;为方便管理，创建一个单独的 Namespace monitoring，Prometheus Operator 相关的组件都会部署到这个 Namespace。&lt;/p&gt;
&lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# kubectl create &lt;span class=&quot;keyword&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;symbol&quot;&gt;monitoring&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2-导入相关镜像&quot;&gt;&lt;a href=&quot;#2-导入相关镜像&quot; class=&quot;headerlink&quot; title=&quot;2. 导入相关镜像&quot;&gt;&lt;/a&gt;2. 导入相关镜像&lt;/h3&gt;&lt;p&gt;所有节点上面导入 prometheus-operator.tar，下载地址：&lt;a href=&quot;https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg&quot;&gt;prometheus-operator.tar&lt;/a&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight pgsql&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# docker &lt;span class=&quot;keyword&quot;&gt;load&lt;/span&gt; -i prometheus-&lt;span class=&quot;keyword&quot;&gt;operator&lt;/span&gt;.tar&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="docker" scheme="https://www.sunmite.com/categories/docker/"/>
    
    
    <category term="kubernetes" scheme="https://www.sunmite.com/tags/kubernetes/"/>
    
    <category term="helm" scheme="https://www.sunmite.com/tags/helm/"/>
    
    <category term="prometheus" scheme="https://www.sunmite.com/tags/prometheus/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes 安装 Helm 并使用 Helm 安装 wordpress</title>
    <link href="https://www.sunmite.com/docker/kubernetes-install-helm-and-wordpress.html"/>
    <id>https://www.sunmite.com/docker/kubernetes-install-helm-and-wordpress.html</id>
    <published>2019-01-04T07:31:00.000Z</published>
    <updated>2021-01-25T02:17:02.332Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Helm-简介"><a href="#Helm-简介" class="headerlink" title="Helm 简介"></a>Helm 简介</h1><p>Helm 有两个重要的概念：chart 和 release。</p><p>chart 是创建一个应用的信息集合，包括各种 Kubernetes 对象的配置模板、参数定义、依赖关系、文档说明等。chart 是应用部署的自包含逻辑单元。可以将 chart 想象成 apt、yum 中的软件安装包。</p><p>release 是 chart 的运行实例，代表了一个正在运行的应用。当 chart 被安装到 Kubernetes 集群，就生成一个 release。chart 能够多次安装到同一个集群，每次安装都是一个 release。</p><p>Kubernetes Helm 是一个管理预先配置 Kubernetes 资源包的工具，这里的资源在 Helm 中也被称作 Kubernetes charts。使用 Helm可以：</p><ul><li>查找并使用已经打包为 Kubernetes charts 的流行软件</li><li>分享您自己的应用作为 Kubernetes charts</li><li>为 Kubernetes 应用创建可重复执行的构建</li><li>为您的 Kubernetes 清单文件提供更智能化的管理</li><li>管理 Helm 软件包的发布</li></ul><p>Helm 包含两个组件：Helm 客户端和 Tiller 服务器，如下图所示。<br><img data-src="/images/uploads/2019/01/helm.png" alt="helm"></p><p>Helm 客户端负责 chart 和 release 的创建和管理以及和 Tiller 的交互。Tiller 服务器运行在 Kubernetes 集群中，它会处理 Helm 客户端的请求，与 Kubernetes API Server 交互。</p><span id="more"></span><h1 id="安装和部署-Helm"><a href="#安装和部署-Helm" class="headerlink" title="安装和部署 Helm"></a>安装和部署 Helm</h1><h2 id="安装-Helm-客户端"><a href="#安装-Helm-客户端" class="headerlink" title="安装 Helm 客户端"></a>安装 Helm 客户端</h2><p>所有运行 kubectl 的节点均需要安装</p><h3 id="1-下载安装"><a href="#1-下载安装" class="headerlink" title="1. 下载安装"></a>1. 下载安装</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># curl https:<span class="comment">//raw.githubusercontent.com/helm/helm/master/scripts/get | bash</span></span><br><span class="line"></span><br><span class="line">Downloading https:<span class="comment">//kubernetes-helm.storage.googleapis.com/helm-v2.12.1-linux-amd64.tar.gz</span></span><br><span class="line">Preparing to install helm and tiller <span class="keyword">into</span> <span class="regexp">/usr/</span>local/bin</span><br><span class="line">helm installed <span class="keyword">into</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>helm</span><br><span class="line">tiller installed <span class="keyword">into</span> <span class="regexp">/usr/</span>local<span class="regexp">/bin/</span>tiller</span><br><span class="line">Run <span class="string">&#x27;helm init&#x27;</span> to configure helm.</span><br></pre></td></tr></table></figure><h3 id="2-验证安装"><a href="#2-验证安装" class="headerlink" title="2. 验证安装"></a>2. 验证安装</h3><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"># helm version</span><br><span class="line"></span><br><span class="line">Client: &amp;version.Version&#123;SemVer:&quot;v2.12.1&quot;, GitCommit:&quot;02a47c7249b1fc6d8fd3b94e6b4babf9d818144e&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br><span class="line"><span class="keyword">Error: </span>could not find tiller</span><br></pre></td></tr></table></figure><p>安装安装的版本为 2.12.1，tiller 服务器还没有安装所以有一个报错</p><h3 id="3-安装-helm-的-bash-命令补全脚本"><a href="#3-安装-helm-的-bash-命令补全脚本" class="headerlink" title="3. 安装 helm 的 bash 命令补全脚本"></a>3. 安装 helm 的 bash 命令补全脚本</h3><p>helm 有很多子命令和参数，为了提高使用命令行的效率，通常建议安装 helm 的 bash 命令补全脚本。</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> helm completion bash &gt; .helmrc &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;source .helmrc&quot;</span> &gt;&gt; .bashrc</span></span><br></pre></td></tr></table></figure><p>重新登陆后，就能通过 TAB 自动补全  helm 命令的子命令和参数了。<br><img data-src="/images/uploads/2019/01/bash.png" alt="bash"></p><h2 id="安装-Tiller-服务器"><a href="#安装-Tiller-服务器" class="headerlink" title="安装 Tiller 服务器"></a>安装 Tiller 服务器</h2><h3 id="1-导入-tiller-镜像"><a href="#1-导入-tiller-镜像" class="headerlink" title="1. 导入 tiller 镜像"></a>1. 导入 tiller 镜像</h3><p>所有节点上面导入 tiller.tar，下载地址：<a href="https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg">tiller.tar</a></p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># docker load -i tiller.tar</span></span><br></pre></td></tr></table></figure><h3 id="2-创建-helm-服务账号"><a href="#2-创建-helm-服务账号" class="headerlink" title="2. 创建 helm 服务账号"></a>2. 创建 helm 服务账号</h3><p>创建 tiller-rbac-config.yaml 文件，加入以下内容</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim tiller-rbac-config.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">tiller</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><p>运行以下命令创建 tiller 服务账号</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl apply -f tiller-rbac-config.yaml</span></span><br></pre></td></tr></table></figure><h3 id="3-部署-tiller"><a href="#3-部署-tiller" class="headerlink" title="3. 部署 tiller"></a>3. 部署 tiller</h3><p>Tiller 服务器安装非常简单，只需要执行 helm init，这里我们指定使用上一步创建的服务账号。</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm init --service-account tiller</span></span><br><span class="line"></span><br><span class="line">Creating <span class="regexp">/root/</span>.helm </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm/repository </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm<span class="regexp">/repository/</span>cache </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm<span class="regexp">/repository/</span>local </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm/plugins </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm/starters </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm<span class="regexp">/cache/</span>archive </span><br><span class="line">Creating <span class="regexp">/root/</span>.helm<span class="regexp">/repository/</span>repositories.yaml </span><br><span class="line">Adding stable repo with URL: https:<span class="regexp">//</span>kubernetes-charts.storage.googleapis.com </span><br><span class="line">Adding local repo with URL: http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8879</span>/charts </span><br><span class="line"><span class="variable">$HELM_HOME</span> has been configured at <span class="regexp">/root/</span>.helm.</span><br><span class="line"></span><br><span class="line">Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.</span><br><span class="line"></span><br><span class="line">Please note: by default, Tiller is deployed with an insecure <span class="string">&#x27;allow unauthenticated users&#x27;</span> policy.</span><br><span class="line">To prevent this, run `helm init` with the --tiller-tls-verify flag.</span><br><span class="line">For more information on securing your installation see: https:<span class="regexp">//</span>docs.helm.sh<span class="regexp">/using_helm/</span><span class="comment">#securing-your-helm-installation</span></span><br><span class="line">Happy Helming!</span><br></pre></td></tr></table></figure><h2 id="验证操作"><a href="#验证操作" class="headerlink" title="验证操作"></a>验证操作</h2><h3 id="1-查看-tiller-状态"><a href="#1-查看-tiller-状态" class="headerlink" title="1. 查看 tiller 状态"></a>1. 查看 tiller 状态</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods --namespace kube-system </span></span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="attribute">coredns</span>-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-<span class="number">8</span>zhr<span class="number">5</span>               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">coredns</span>-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-jqn<span class="number">7</span>r               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">etcd</span>-k<span class="number">8</span>s-master                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-apiserver-k<span class="number">8</span>s-master              <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-controller-manager-k<span class="number">8</span>s-master     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-flannel-ds-amd<span class="number">64</span>-krf<span class="number">6</span>t            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-flannel-ds-amd<span class="number">64</span>-tkftg            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-flannel-ds-amd<span class="number">64</span>-zxzld            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-proxy-<span class="number">5</span>znt<span class="number">7</span>                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-proxy-gl<span class="number">9</span>sl                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-proxy-q<span class="number">7</span>j<span class="number">7</span>m                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kube</span>-scheduler-k<span class="number">8</span>s-master              <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">5</span>d<span class="number">16</span>h</span><br><span class="line"><span class="attribute">kubernetes</span>-dashboard-<span class="number">57</span>df<span class="number">4</span>db<span class="number">6</span>b-<span class="number">8</span>b<span class="number">2</span>l<span class="number">4</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">16</span>h</span><br><span class="line"><span class="attribute">metrics</span>-server-<span class="number">879</span>f<span class="number">5</span>ff<span class="number">6</span>d-tpszf         <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">16</span>h</span><br><span class="line"><span class="attribute">tiller</span>-deploy-<span class="number">6</span>f<span class="number">8</span>d<span class="number">4</span>f<span class="number">6</span>c<span class="number">9</span>c-<span class="number">4</span>h<span class="number">95</span>z         <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m<span class="number">39</span>s</span><br></pre></td></tr></table></figure><p>可以看到 tiller 已经是运行状态。</p><h3 id="2-查看-helm-信息"><a href="#2-查看-helm-信息" class="headerlink" title="2. 查看 helm 信息"></a>2. 查看 helm 信息</h3><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># helm <span class="keyword">version</span></span><br><span class="line"></span><br><span class="line">Client: &amp;<span class="keyword">version</span>.<span class="keyword">Version</span>&#123;SemVer:&quot;v2.12.1&quot;, GitCommit:&quot;02a47c7249b1fc6d8fd3b94e6b4babf9d818144e&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br><span class="line"><span class="keyword">Server</span>: &amp;<span class="keyword">version</span>.<span class="keyword">Version</span>&#123;SemVer:&quot;v2.12.1&quot;, GitCommit:&quot;02a47c7249b1fc6d8fd3b94e6b4babf9d818144e&quot;, GitTreeState:&quot;clean&quot;&#125;</span><br></pre></td></tr></table></figure><h1 id="使用-Helm-安装-wordpress"><a href="#使用-Helm-安装-wordpress" class="headerlink" title="使用 Helm 安装 wordpress"></a>使用 Helm 安装 wordpress</h1><h2 id="1-搜索-chart"><a href="#1-搜索-chart" class="headerlink" title="1. 搜索 chart"></a>1. 搜索 chart</h2><p>搜索 wordpress 的 charts</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm search wordpress</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>            CHART VERSIONAPP VERSIONDESCRIPTION                                             </span><br><span class="line"><span class="attribute">stable</span>/wordpress<span class="number">5</span>.<span class="number">0</span>.<span class="number">3</span>        <span class="number">5</span>.<span class="number">0</span>.<span class="number">2</span>      Web publishing platform for building blogs and websites.</span><br></pre></td></tr></table></figure><h2 id="2-查看-chart-的存储信息"><a href="#2-查看-chart-的存储信息" class="headerlink" title="2. 查看 chart 的存储信息"></a>2. 查看 chart 的存储信息</h2><p>创建 wordpress 的时候需要申请  PersistentVolumeClaim，由于我们的环境不支持动态申请所以需要手动创建</p><figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"># helm inspect value stable/wordpress</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">  ## MariaDB admin password</span><br><span class="line">  ## ref: https:<span class="comment">//github.com/bitnami/bitnami-docker-mariadb/blob/master/README.md#setting-the-root-password-on-first-run</span></span><br><span class="line">  ##</span><br><span class="line">  # rootUser:</span><br><span class="line">  #   password:</span><br><span class="line"></span><br><span class="line">  ## Enable persistence using Persistent Volume Claims</span><br><span class="line">  ## ref: http:<span class="comment">//kubernetes.io/docs/user-guide/persistent-volumes/</span></span><br><span class="line">  ##</span><br><span class="line">  master:</span><br><span class="line">    persistence:</span><br><span class="line">      enabled: true</span><br><span class="line">      ## mariadb data Persistent Volume Storage Class</span><br><span class="line">      ## If defined, storageClassName: &lt;storageClass&gt;</span><br><span class="line">      ## If set to <span class="string">&quot;-&quot;</span>, storageClassName: <span class="string">&quot;&quot;</span>, which disables dynamic provisioning</span><br><span class="line">      ## If undefined (the default) or set to null, no storageClassName spec is</span><br><span class="line">      ##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span><br><span class="line">      ##   GKE, AWS &amp; OpenStack)</span><br><span class="line">      ##</span><br><span class="line">      # storageClass: <span class="string">&quot;-&quot;</span></span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: <span class="number">8</span>Gi</span><br><span class="line">      </span><br><span class="line">……</span><br><span class="line"></span><br><span class="line">persistence:</span><br><span class="line">  enabled: true</span><br><span class="line">  ## wordpress data Persistent Volume Storage Class</span><br><span class="line">  ## If defined, storageClassName: &lt;storageClass&gt;</span><br><span class="line">  ## If set to <span class="string">&quot;-&quot;</span>, storageClassName: <span class="string">&quot;&quot;</span>, which disables dynamic provisioning</span><br><span class="line">  ## If undefined (the default) or set to null, no storageClassName spec is</span><br><span class="line">  ##   set, choosing the default provisioner.  (gp2 on AWS, standard on</span><br><span class="line">  ##   GKE, AWS &amp; OpenStack)</span><br><span class="line">  ##</span><br><span class="line">  # storageClass: <span class="string">&quot;-&quot;</span></span><br><span class="line">  ##</span><br><span class="line">  ## If you want to reuse an existing claim, you can pass the name <span class="keyword">of</span> the PVC using</span><br><span class="line">  ## the existingClaim variable</span><br><span class="line">  # existingClaim: your-claim</span><br><span class="line">  accessMode: ReadWriteOnce</span><br><span class="line">  size: <span class="number">10</span>Gi</span><br></pre></td></tr></table></figure><p>可以看到 wordpress 的 chart 需要两个 pv，分别用于 mariadb(8G) 和 wordpress(10G) 的数据存储。</p><h2 id="3-手动创建-chart-所需的-pv"><a href="#3-手动创建-chart-所需的-pv" class="headerlink" title="3. 手动创建 chart 所需的 pv"></a>3. 手动创建 chart 所需的 pv</h2><p>创建 create-pv.yml 文件，输入以下内容</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim create-pv.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mariadb-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">8Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="comment">#storageClassName: nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/mariadb-pv</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.20</span><span class="number">.6</span><span class="number">.116</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="comment">#storageClassName: nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfsdata/wordpress-pv</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">172.20</span><span class="number">.6</span><span class="number">.116</span></span><br></pre></td></tr></table></figure><p>创建 pv</p><figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"># kubectl <span class="built_in">apply</span> -f create-<span class="built_in">pv</span>.yml </span><br><span class="line"></span><br><span class="line">persistentvolume/mariadb-<span class="built_in">pv</span> created</span><br><span class="line">persistentvolume/wordpress-<span class="built_in">pv</span> created</span><br></pre></td></tr></table></figure><h2 id="4-安装-chart"><a href="#4-安装-chart" class="headerlink" title="4. 安装 chart"></a>4. 安装 chart</h2><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"># helm install --name wordpress stable/wordpress</span><br><span class="line"></span><br><span class="line">NAME:   wordpress                                  ---------①---------</span><br><span class="line">LAST DEPLOYED: Fri Jan  <span class="number">4</span> <span class="number">10</span>:<span class="number">32</span>:<span class="number">57</span> <span class="number">2019</span></span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:                                         ---------②---------</span><br><span class="line">==&gt; v1beta1/Deployment</span><br><span class="line">NAME                 DESIRED  CURRENT  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">wordpress-wordpress  <span class="number">1</span>        <span class="number">1</span>        <span class="number">1</span>           <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/StatefulSet</span><br><span class="line">NAME               DESIRED  CURRENT  AGE</span><br><span class="line">wordpress-mariadb  <span class="number">1</span>        <span class="number">1</span>        <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/<span class="constructor">Pod(<span class="params">related</span>)</span></span><br><span class="line">NAME                                  READY  STATUS   RESTARTS  AGE</span><br><span class="line">wordpress-wordpress-<span class="number">56794</span>ff7b9-rf98x  <span class="number">0</span>/<span class="number">1</span>    Pending  <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line">wordpress-mariadb-<span class="number">0</span>                   <span class="number">0</span>/<span class="number">1</span>    Pending  <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                 TYPE    DATA  AGE</span><br><span class="line">wordpress-mariadb    Opaque  <span class="number">2</span>     <span class="number">0</span>s</span><br><span class="line">wordpress-wordpress  Opaque  <span class="number">1</span>     <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                     DATA  AGE</span><br><span class="line">wordpress-mariadb        <span class="number">1</span>     <span class="number">0</span>s</span><br><span class="line">wordpress-mariadb-tests  <span class="number">1</span>     <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/PersistentVolumeClaim</span><br><span class="line">NAME                 STATUS   VOLUME  CAPACITY  ACCESS MODES  STORAGECLASS  AGE</span><br><span class="line">wordpress-wordpress  Pending  <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                 TYPE          CLUSTER-IP      EXTERNAL-IP  <span class="constructor">PORT(S)</span>                     AGE</span><br><span class="line">wordpress-mariadb    ClusterIP     <span class="number">10.100</span>.<span class="number">218.132</span>  &lt;none&gt;       <span class="number">3306</span>/TCP                    <span class="number">0</span>s</span><br><span class="line">wordpress-wordpress  LoadBalancer  <span class="number">10.100</span>.<span class="number">36.64</span>    &lt;pending&gt;    <span class="number">80</span>:<span class="number">31051</span>/TCP,<span class="number">443</span>:<span class="number">30169</span>/TCP  <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:                                             ---------③---------</span><br><span class="line"><span class="number">1.</span> Get the WordPress URL:</span><br><span class="line"></span><br><span class="line">  NOTE: It may take a few minutes <span class="keyword">for</span> the LoadBalancer IP <span class="keyword">to</span> be available.</span><br><span class="line">        Watch the status <span class="keyword">with</span>: &#x27;kubectl get svc --namespace default -w wordpress-wordpress&#x27;</span><br><span class="line">  export SERVICE_IP=<span class="constructor">$(<span class="params">kubectl</span> <span class="params">get</span> <span class="params">svc</span> --<span class="params">namespace</span> <span class="params">default</span> <span class="params">wordpress</span>-<span class="params">wordpress</span> --<span class="params">template</span> <span class="string">&quot;&#123;&#123; range (index .status.loadBalancer.ingress 0) &#125;&#125;&#123;&#123;.&#125;&#125;&#123;&#123; end &#125;&#125;&quot;</span>)</span></span><br><span class="line">  echo <span class="string">&quot;WordPress URL: http://$SERVICE_IP/&quot;</span></span><br><span class="line">  echo <span class="string">&quot;WordPress Admin URL: http://$SERVICE_IP/admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> Login <span class="keyword">with</span> the following credentials <span class="keyword">to</span> see your blog</span><br><span class="line"></span><br><span class="line">  echo Username: user</span><br><span class="line">  echo Password: <span class="constructor">$(<span class="params">kubectl</span> <span class="params">get</span> <span class="params">secret</span> --<span class="params">namespace</span> <span class="params">default</span> <span class="params">wordpress</span>-<span class="params">wordpress</span> -<span class="params">o</span> <span class="params">jsonpath</span>=<span class="string">&quot;&#123;.data.wordpress-password&#125;&quot;</span> | <span class="params">base64</span> --<span class="params">decode</span>)</span></span><br></pre></td></tr></table></figure><p>输出分为 3 部分（上文输出结果中的①②③）：</p><ul><li>① 本次部署 chart 的描述信息。包括 release 的名字（没有指定，则默认生成）。release 部署的 namespace，默认是 default。release的状态 DEPLOYED 表示已经将 chart 部署到集群。</li><li>② release 包含的资源： Service、 Deployment、 Secret 等</li><li>③ release 的使用方法</li></ul><h2 id="5-访问-wordpress"><a href="#5-访问-wordpress" class="headerlink" title="5. 访问  wordpress"></a>5. 访问  wordpress</h2><p>使用 <a href="http://nodeip+service_port/">http://nodeip+service_port</a> 访问wordpress，访问地址为：<a href="http://172.20.6.116:31051/">http://172.20.6.116:31051/</a><br><img data-src="/images/uploads/2019/01/wordpress.png" alt="wordpress"><br>其他信息，包括后台地址，管理员账号等信息可以参考release 的 NOTES 部分。</p><h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>Helm 的使用有点类似 ubuntu 的 apt 或者 RHEL 的 yum，极大的简化了部署一个应用的流程。对于使用者而言，使用 Helm 后不用需要了解 Kubernetes 的 yaml 语法并编写应用部署文件，也无需考虑应用的各种依赖，可以直接通过 Helm 下载并在 kubernetes 上安装需要的应用。<br>除此以外，Helm 还提供了 kubernetes 上的软件部署，删除，升级，回滚应用的强大功能。</p><hr><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://blog.csdn.net/CloudMan6/article/details/80140789">Helm 架构 - 每天5分钟玩转 Docker 容器技术（161）</a><br><a href="https://docs.helm.sh/using_helm/#installing-helm">Helm Quickstart</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Helm-简介&quot;&gt;&lt;a href=&quot;#Helm-简介&quot; class=&quot;headerlink&quot; title=&quot;Helm 简介&quot;&gt;&lt;/a&gt;Helm 简介&lt;/h1&gt;&lt;p&gt;Helm 有两个重要的概念：chart 和 release。&lt;/p&gt;
&lt;p&gt;chart 是创建一个应用的信息集合，包括各种 Kubernetes 对象的配置模板、参数定义、依赖关系、文档说明等。chart 是应用部署的自包含逻辑单元。可以将 chart 想象成 apt、yum 中的软件安装包。&lt;/p&gt;
&lt;p&gt;release 是 chart 的运行实例，代表了一个正在运行的应用。当 chart 被安装到 Kubernetes 集群，就生成一个 release。chart 能够多次安装到同一个集群，每次安装都是一个 release。&lt;/p&gt;
&lt;p&gt;Kubernetes Helm 是一个管理预先配置 Kubernetes 资源包的工具，这里的资源在 Helm 中也被称作 Kubernetes charts。使用 Helm可以：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;查找并使用已经打包为 Kubernetes charts 的流行软件&lt;/li&gt;
&lt;li&gt;分享您自己的应用作为 Kubernetes charts&lt;/li&gt;
&lt;li&gt;为 Kubernetes 应用创建可重复执行的构建&lt;/li&gt;
&lt;li&gt;为您的 Kubernetes 清单文件提供更智能化的管理&lt;/li&gt;
&lt;li&gt;管理 Helm 软件包的发布&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Helm 包含两个组件：Helm 客户端和 Tiller 服务器，如下图所示。&lt;br&gt;&lt;img data-src=&quot;/images/uploads/2019/01/helm.png&quot; alt=&quot;helm&quot;&gt;&lt;/p&gt;
&lt;p&gt;Helm 客户端负责 chart 和 release 的创建和管理以及和 Tiller 的交互。Tiller 服务器运行在 Kubernetes 集群中，它会处理 Helm 客户端的请求，与 Kubernetes API Server 交互。&lt;/p&gt;</summary>
    
    
    
    <category term="docker" scheme="https://www.sunmite.com/categories/docker/"/>
    
    
    <category term="kubernetes" scheme="https://www.sunmite.com/tags/kubernetes/"/>
    
    <category term="helm" scheme="https://www.sunmite.com/tags/helm/"/>
    
  </entry>
  
  <entry>
    <title>使用 kubeadm 部署 kubernetes 1.13.1</title>
    <link href="https://www.sunmite.com/docker/use-kubeadmin-deploy-kubernetes.html"/>
    <id>https://www.sunmite.com/docker/use-kubeadmin-deploy-kubernetes.html</id>
    <published>2019-01-02T05:42:43.000Z</published>
    <updated>2021-01-25T02:17:02.346Z</updated>
    
    <content type="html"><![CDATA[<p>最近有时间重新学习 k8s。k8s 的安装比之前简单了许多，本文介绍如何使用 kubeadm 部署 kubernetns 1.13.1</p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="环境概览"><a href="#环境概览" class="headerlink" title="环境概览"></a>环境概览</h2><p>准备了3台机器，有一台master，两台node，主机名及IP如下：</p><table><thead><tr><th>主机名</th><th>IP地址</th></tr></thead><tbody><tr><td>k8s-master</td><td>172.20.6.116</td></tr><tr><td>k8s-node1</td><td>172.20.6.117</td></tr><tr><td>k8s-node2</td><td>172.20.6.118</td></tr></tbody></table><h2 id="系统设置"><a href="#系统设置" class="headerlink" title="系统设置"></a>系统设置</h2><h3 id="1-修改三台机器的主机名"><a href="#1-修改三台机器的主机名" class="headerlink" title="1. 修改三台机器的主机名"></a>1. 修改三台机器的主机名</h3><figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"># hostnamectl <span class="keyword">set</span>-hostname <span class="comment">XXXX</span></span><br></pre></td></tr></table></figure><h3 id="2-设置本地解析"><a href="#2-设置本地解析" class="headerlink" title="2. 设置本地解析"></a>2. 设置本地解析</h3><p>编辑三台机器的 hosts 文件加入以下内容</p><figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"># vim /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="number">172.20.6.116</span> k8s-master</span><br><span class="line"><span class="number">172.20.6.117</span> k8s-node1</span><br><span class="line"><span class="number">172.20.6.118</span> k8s-node2</span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="3-关闭防火墙"><a href="#3-关闭防火墙" class="headerlink" title="3. 关闭防火墙"></a>3. 关闭防火墙</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> firewalld</span></span><br></pre></td></tr></table></figure><h3 id="4-关闭selinux"><a href="#4-关闭selinux" class="headerlink" title="4. 关闭selinux"></a>4. 关闭selinux</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># sed -i s<span class="regexp">/SELINUX=enforcing/</span>SELINUX=disabled<span class="regexp">/g /</span>etc<span class="regexp">/selinux/</span>config</span><br></pre></td></tr></table></figure><h3 id="5-关闭NetworkManager"><a href="#5-关闭NetworkManager" class="headerlink" title="5. 关闭NetworkManager"></a>5. 关闭NetworkManager</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl <span class="built_in">disable</span> NetworkManager</span></span><br></pre></td></tr></table></figure><h3 id="6-设置时间同步"><a href="#6-设置时间同步" class="headerlink" title="6. 设置时间同步"></a>6. 设置时间同步</h3><p>所有机器上安装 chrony</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install -y chrony</span></span><br></pre></td></tr></table></figure><p>设置时间同步(172.50.10.16为我本地的 NTP 服务器，也可以直接使用阿里云的NTP: time1.aliyun.com)</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># vim /etc/chrony.conf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#server 3.centos.pool.ntp.org iburst</span></span><br><span class="line">server <span class="number">172.50</span><span class="number">.10</span><span class="number">.16</span> iburst</span><br></pre></td></tr></table></figure><p>启动服务并同步时间</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"># systemctl enable chronyd &amp;&amp; systemctl restart chronyd</span><br><span class="line">#  chronyc sources</span><br><span class="line">210 Number of sources = 1</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample               </span><br><span class="line">===============================================================================</span><br><span class="line">^* 172.50.10.16                  3   6    17    13   <span class="code">+103us[  +</span>12us] +/-   24ms</span><br></pre></td></tr></table></figure><p>星号代表同步成功</p><h3 id="7-重启所有主机"><a href="#7-重启所有主机" class="headerlink" title="7. 重启所有主机"></a>7. 重启所有主机</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># reboot</span></span><br></pre></td></tr></table></figure><h1 id="部署-kubernetes"><a href="#部署-kubernetes" class="headerlink" title="部署 kubernetes"></a>部署 kubernetes</h1><h2 id="安装-docker-ce-所有主机"><a href="#安装-docker-ce-所有主机" class="headerlink" title="安装 docker-ce(所有主机 )"></a>安装 docker-ce(所有主机 )</h2><h3 id="1-下载-docker-ce-源"><a href="#1-下载-docker-ce-源" class="headerlink" title="1. 下载 docker-ce 源"></a>1. 下载 docker-ce 源</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># wget -O <span class="regexp">/etc/yum</span>.repos.d<span class="regexp">/docker-ce.repo https:/</span><span class="regexp">/download.docker.com/</span>linux<span class="regexp">/centos/</span>docker-ce.repo</span><br></pre></td></tr></table></figure><h3 id="2-配置-docker-ce-使用国内源"><a href="#2-配置-docker-ce-使用国内源" class="headerlink" title="2. 配置 docker-ce 使用国内源"></a>2. 配置 docker-ce 使用国内源</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># sed -i <span class="string">&#x27;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+&#x27;</span> <span class="regexp">/etc/yum</span>.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure><h3 id="3-安装docker-ce"><a href="#3-安装docker-ce" class="headerlink" title="3. 安装docker-ce"></a>3. 安装docker-ce</h3><p>由于 kubernetes 1.13.1 只在 docker-ce 18.06以下测试过，所以指定安装的 docker-ce 版本</p><figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line"># yum install docker-ce<span class="string">-18</span>.06.1.ce<span class="string">-3</span>.el7</span><br></pre></td></tr></table></figure><h3 id="4-启动并设置开机自启"><a href="#4-启动并设置开机自启" class="headerlink" title="4. 启动并设置开机自启"></a>4. 启动并设置开机自启</h3><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># systemctl <span class="keyword">enable</span> docker.service &amp;&amp; systemctl <span class="keyword">start</span> docker.service</span><br></pre></td></tr></table></figure><h2 id="安装-kubeadm-kubelet-and-kubectl-所有主机"><a href="#安装-kubeadm-kubelet-and-kubectl-所有主机" class="headerlink" title="安装 kubeadm, kubelet and kubectl(所有主机)"></a>安装 kubeadm, kubelet and kubectl(所有主机)</h2><h3 id="1-配置-kubeadm-的源"><a href="#1-配置-kubeadm-的源" class="headerlink" title="1. 配置 kubeadm 的源"></a>1. 配置 kubeadm 的源</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; <span class="regexp">/etc/yum</span>.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/kubernetes/yum</span><span class="regexp">/repos/</span>kubernetes-el7-x86_64/</span><br><span class="line">enabled=<span class="number">1</span></span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line">repo_gpgcheck=<span class="number">1</span></span><br><span class="line">gpgkey=https:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/kubernetes/yum</span><span class="regexp">/doc/yum</span>-key.gpg https:<span class="regexp">//mi</span>rrors.aliyun.com<span class="regexp">/kubernetes/yum</span><span class="regexp">/doc/</span>rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="2-安装-kubeadm-kubelet-and-kubectl"><a href="#2-安装-kubeadm-kubelet-and-kubectl" class="headerlink" title="2. 安装 kubeadm, kubelet and kubectl"></a>2. 安装 kubeadm, kubelet and kubectl</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install -y kubelet kubeadm kubectl</span></span><br></pre></td></tr></table></figure><h3 id="3-启动并设置开机自启"><a href="#3-启动并设置开机自启" class="headerlink" title="3. 启动并设置开机自启"></a>3. 启动并设置开机自启</h3><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># systemctl <span class="keyword">enable</span> kubelet &amp;&amp; systemctl <span class="keyword">start</span> kubelet</span><br></pre></td></tr></table></figure><h3 id="4-调整内核参数"><a href="#4-调整内核参数" class="headerlink" title="4. 调整内核参数"></a>4. 调整内核参数</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="attribute">net</span>.bridge.bridge-nf-call-ip<span class="number">6</span>tables = <span class="number">1</span></span><br><span class="line"><span class="attribute">net</span>.bridge.bridge-nf-call-iptables = <span class="number">1</span></span><br><span class="line"><span class="attribute">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sysctl --system</span></span><br></pre></td></tr></table></figure><h2 id="初始化-k8s-（master-节点）"><a href="#初始化-k8s-（master-节点）" class="headerlink" title="初始化 k8s （master 节点）"></a>初始化 k8s （master 节点）</h2><h3 id="1-导入镜像包"><a href="#1-导入镜像包" class="headerlink" title="1. 导入镜像包"></a>1. 导入镜像包</h3><p>由于不可描述的原因，无法拉取k8s的镜像，所以我准备了一份离线的数据，需要在所有节点导入，下载地址：<a href="https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg">kube.tar</a></p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># docker load -i kube.tar </span></span><br></pre></td></tr></table></figure><p>查看导入后的镜像</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">REPOSITORY</span>                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/kube-proxy                v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span>             fdb<span class="number">321</span>fd<span class="number">30</span>a<span class="number">0</span>        <span class="number">2</span> weeks ago         <span class="number">80</span>.<span class="number">2</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/kube-controller-manager   v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span>             <span class="number">26</span>e<span class="number">6</span>f<span class="number">1</span>db<span class="number">2</span>a<span class="number">52</span>        <span class="number">2</span> weeks ago         <span class="number">146</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/kube-apiserver            v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span>             <span class="number">40</span>a<span class="number">63</span>db<span class="number">91</span>ef<span class="number">8</span>        <span class="number">2</span> weeks ago         <span class="number">181</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/kube-scheduler            v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span>             ab<span class="number">81</span>d<span class="number">7360408</span>        <span class="number">2</span> weeks ago         <span class="number">79</span>.<span class="number">6</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/coredns                   <span class="number">1</span>.<span class="number">2</span>.<span class="number">6</span>               f<span class="number">59</span>dcacceff<span class="number">4</span>        <span class="number">7</span> weeks ago         <span class="number">40</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/etcd                      <span class="number">3</span>.<span class="number">2</span>.<span class="number">24</span>              <span class="number">3</span>cab<span class="number">8</span>e<span class="number">1</span>b<span class="number">9802</span>        <span class="number">3</span> months ago        <span class="number">220</span>MB</span><br><span class="line"><span class="attribute">quay</span>.io/coreos/flannel               v<span class="number">0</span>.<span class="number">10</span>.<span class="number">0</span>-amd<span class="number">64</span>       f<span class="number">0</span>fad<span class="number">859</span>c<span class="number">909</span>        <span class="number">11</span> months ago       <span class="number">44</span>.<span class="number">6</span>MB</span><br><span class="line"><span class="attribute">k8s</span>.gcr.io/pause                     <span class="number">3</span>.<span class="number">1</span>                 da<span class="number">86</span>e<span class="number">6</span>ba<span class="number">6</span>ca<span class="number">1</span>        <span class="number">12</span> months ago       <span class="number">742</span>kB</span><br></pre></td></tr></table></figure><h3 id="2-初始化-master-节点"><a href="#2-初始化-master-节点" class="headerlink" title="2. 初始化 master 节点"></a>2. 初始化 master 节点</h3><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --pod-network-cidr=10.244.0.0/16</span></span><br><span class="line"></span><br><span class="line">**********</span><br><span class="line"></span><br><span class="line">You should now deploy <span class="keyword">a</span> pod network <span class="built_in">to</span> <span class="keyword">the</span> cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> <span class="keyword">with</span> <span class="literal">one</span> <span class="keyword">of</span> <span class="keyword">the</span> options listed <span class="keyword">at</span>:</span><br><span class="line">  <span class="keyword">https</span>://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join <span class="keyword">any</span> <span class="built_in">number</span> <span class="keyword">of</span> machines <span class="keyword">by</span> running <span class="keyword">the</span> following <span class="keyword">on</span> <span class="title">each</span> <span class="title">node</span></span><br><span class="line"><span class="keyword">as</span> root:</span><br><span class="line"></span><br><span class="line">  kubeadm join <span class="number">172.20</span><span class="number">.6</span><span class="number">.116</span>:<span class="number">6443</span> <span class="comment">--token lyycbq.uogsx4a9h7ponmg5 --discovery-token-ca-cert-hash sha256:60d0338c4927907cf56d9697bcdb261cd2fe2dac0f36a9901b254253516177ed</span></span><br></pre></td></tr></table></figure><p>master节点初始化成功，注意保存最后的 kubeadmin join 的内容</p><h3 id="3-加载-k8s-环境变量"><a href="#3-加载-k8s-环境变量" class="headerlink" title="3. 加载 k8s 环境变量"></a>3. 加载 k8s 环境变量</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;export KUBECONFIG=/etc/kubernetes/admin.conf&quot;</span> &gt;&gt; ~/.bash_profile</span></span><br></pre></td></tr></table></figure><h3 id="4-安装-network-addon"><a href="#4-安装-network-addon" class="headerlink" title="4. 安装 network addon"></a>4. 安装 network addon</h3><p>要docker之间能互相通信需要做些配置，这里用Flannel来实现</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">clusterrole</span>.rbac.authorization.k<span class="number">8</span>s.io/flannel created</span><br><span class="line"><span class="attribute">clusterrolebinding</span>.rbac.authorization.k<span class="number">8</span>s.io/flannel created</span><br><span class="line"><span class="attribute">serviceaccount</span>/flannel created</span><br><span class="line"><span class="attribute">configmap</span>/kube-flannel-cfg created</span><br><span class="line"><span class="attribute">daemonset</span>.extensions/kube-flannel-ds-amd<span class="number">64</span> created</span><br><span class="line"><span class="attribute">daemonset</span>.extensions/kube-flannel-ds-arm<span class="number">64</span> created</span><br><span class="line"><span class="attribute">daemonset</span>.extensions/kube-flannel-ds-arm created</span><br><span class="line"><span class="attribute">daemonset</span>.extensions/kube-flannel-ds-ppc<span class="number">64</span>le created</span><br><span class="line"><span class="attribute">daemonset</span>.extensions/kube-flannel-ds-s<span class="number">390</span>x created</span><br></pre></td></tr></table></figure><h3 id="5-确认集群状态"><a href="#5-确认集群状态" class="headerlink" title="5. 确认集群状态"></a>5. 确认集群状态</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br><span class="line"><span class="attribute">NAMESPACE</span>     NAME                                 READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-lhb<span class="number">7</span>w             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">95</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-zprwr             <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">95</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   etcd-k<span class="number">8</span>s-master                      <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">100</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   kube-apiserver-k<span class="number">8</span>s-master            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">100</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   kube-controller-manager-k<span class="number">8</span>s-master   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">100</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-jjdmz          <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">91</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-lfhbs                     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">101</span>m</span><br><span class="line"><span class="attribute">kube</span>-system   kube-scheduler-k<span class="number">8</span>s-master            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">100</span>m</span><br></pre></td></tr></table></figure><p>确认 CoreDNS pod 为运行状态</p><h2 id="加入集群（node节点）"><a href="#加入集群（node节点）" class="headerlink" title="加入集群（node节点）"></a>加入集群（node节点）</h2><h3 id="1-配置node节点加入集群"><a href="#1-配置node节点加入集群" class="headerlink" title="1. 配置node节点加入集群"></a>1. 配置node节点加入集群</h3><p>在 k8s-node1 和 k8s-node2 执行以下命令（初始化中保存的 join 命令)</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm join 172.20.6.116:6443 --token lyycbq.uogsx4a9h7ponmg5 --discovery-token-ca-cert-hash sha256:60d0338c4927907cf56d9697bcdb261cd2fe2dac0f36a9901b254253516177ed</span></span><br><span class="line"></span><br><span class="line">******</span><br><span class="line"></span><br><span class="line">This <span class="keyword">node</span> <span class="title">has</span> joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver <span class="keyword">and</span> a response was received.</span><br><span class="line">* The Kubelet was <span class="literal">inf</span>ormed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run &#x27;kubectl get nodes&#x27; on the <span class="keyword">master</span> <span class="title">to</span> see this <span class="keyword">node</span> <span class="title">join</span> the cluster.</span><br></pre></td></tr></table></figure><h3 id="2-检查集群"><a href="#2-检查集群" class="headerlink" title="2. 检查集群"></a>2. 检查集群</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get nodes</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">NAME</span>         STATUS   ROLES    AGE     VERSION</span><br><span class="line"><span class="attribute">k8s</span>-master   Ready    master   <span class="number">2</span>m<span class="number">23</span>s   v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">k8s</span>-node<span class="number">1</span>    Ready    &lt;none&gt;   <span class="number">39</span>s     v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">k8s</span>-node<span class="number">2</span>    Ready    &lt;none&gt;   <span class="number">16</span>s     v<span class="number">1</span>.<span class="number">13</span>.<span class="number">1</span></span><br></pre></td></tr></table></figure><p>可以看到两个节点都已经加入了，并且是正常的ready状态。 <br>至此，整个集群的配置完成，可以开始使用了。</p><h2 id="配置-dashboard"><a href="#配置-dashboard" class="headerlink" title="配置 dashboard"></a>配置 dashboard</h2><h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><p>默认没有web页面，可以通过以下步骤部署 dashboard</p><h4 id="1-导入-dashboard-ui（所有节点）"><a href="#1-导入-dashboard-ui（所有节点）" class="headerlink" title="1. 导入 dashboard-ui（所有节点）"></a>1. 导入 dashboard-ui（所有节点）</h4><p>下载地址：<a href="https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg">dashboard-ui.tar</a></p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># docker load -i dashboard-ui.tar</span></span><br></pre></td></tr></table></figure><h4 id="2-下载配置文件"><a href="#2-下载配置文件" class="headerlink" title="2. 下载配置文件"></a>2. 下载配置文件</h4><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># wget https:<span class="comment">//raw.githubusercontent.com/kubernetes/dashboard/master/aio/deploy/recommended/kubernetes-dashboard.yaml</span></span></span><br></pre></td></tr></table></figure><p>编辑kubernetes-dashboard.yaml文件，添加type: NodePort，暴露Dashboard服务，便于从外部访问dashboard。注意这里只添加行type: NodePort即可，其他配置不用改。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br></pre></td></tr></table></figure><h4 id="3-部署-Dashboard-UI"><a href="#3-部署-Dashboard-UI" class="headerlink" title="3. 部署 Dashboard UI"></a>3. 部署 Dashboard UI</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl create -f  kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure><h4 id="4-查看-dashboard-服务状态"><a href="#4-查看-dashboard-服务状态" class="headerlink" title="4. 查看 dashboard 服务状态"></a>4. 查看 dashboard 服务状态</h4><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get pods --all-namespaces</span></span><br><span class="line"><span class="attribute">NAMESPACE</span>     NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-<span class="number">8</span>zhr<span class="number">5</span>               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-jqn<span class="number">7</span>r               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   etcd-k<span class="number">8</span>s-master                        <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-apiserver-k<span class="number">8</span>s-master              <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-controller-manager-k<span class="number">8</span>s-master     <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-krf<span class="number">6</span>t            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-tkftg            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-zxzld            <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-<span class="number">5</span>znt<span class="number">7</span>                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-gl<span class="number">9</span>sl                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-q<span class="number">7</span>j<span class="number">7</span>m                       <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kube-scheduler-k<span class="number">8</span>s-master              <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>d<span class="number">22</span>h</span><br><span class="line"><span class="attribute">kube</span>-system   kubernetes-dashboard-<span class="number">57</span>df<span class="number">4</span>db<span class="number">6</span>b-pghk<span class="number">8</span>   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">19</span>h</span><br></pre></td></tr></table></figure><p>kubernetes-dashboard 为运行状态</p><h3 id="创建简单用户"><a href="#创建简单用户" class="headerlink" title="创建简单用户"></a>创建简单用户</h3><h4 id="1-创建服务账号和集群角色绑定配置文件"><a href="#1-创建服务账号和集群角色绑定配置文件" class="headerlink" title="1. 创建服务账号和集群角色绑定配置文件"></a>1. 创建服务账号和集群角色绑定配置文件</h4><p>创建 dashboard-adminuser.yaml 文件，加入以下内容：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim dashboard-adminuser.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-admin</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure><h4 id="2-创建用户和角色绑定"><a href="#2-创建用户和角色绑定" class="headerlink" title="2. 创建用户和角色绑定"></a>2. 创建用户和角色绑定</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl apply -f dashboard-adminuser.yaml</span></span><br></pre></td></tr></table></figure><h4 id="3-查看-Token"><a href="#3-查看-Token" class="headerlink" title="3. 查看 Token"></a>3. 查看 Token</h4><figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"># kubectl -n kube-system describe secret <span class="constructor">$(<span class="params">kubectl</span> -<span class="params">n</span> <span class="params">kube</span>-<span class="params">system</span> <span class="params">get</span> <span class="params">secret</span> | <span class="params">grep</span> <span class="params">kubernetes</span>-<span class="params">dashboard</span>-<span class="params">admin</span>-<span class="params">token</span> | <span class="params">awk</span> &#x27;&#123;<span class="params">print</span> $1&#125;&#x27;)</span></span><br><span class="line"></span><br><span class="line">Name:         kubernetes-dashboard-admin-token-xdrs6</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: <span class="number">14082</span>a92-<span class="number">0e3</span>c-<span class="number">11e9</span>-ac3f-fa163e25b09e</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi14ZHJzNiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjE0MDgyYTkyLTBlM2MtMTFlOS1hYzNmLWZhMTYzZTI1YjA5ZSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.K9Z5NOY2MusdXhiFx6NdA42Jpo1cCChN16CKsdsw-<span class="number">9</span>eh76p1O4kd4u22_ZgWzhRwarnllURXieDxEGpRmCJaBOmMo_xFmlCX6fxFQ-<span class="number">7</span>bWcXuWWpi3ay5qSOPsv_7EyvCvkFSFVfgMnppu3dvEhD5NoeSjnrkHshHxFFnhZc7ePIUVlY9KvMVWv7UDkhinJKy5HjLu_ejwy2jxmSNwZ-g9wnLVzw3-XObmUUL8nTRdE8KehKtpdo6Kd-BJlmfTNUPiSGxrcU1sW1hzwJLsEfTix4oQOhdCh2-z37Gr_1J7-bnf8F5_U90okH2nf1it2brmIM3JbzuQ8sWERx66gEkKQ</span><br><span class="line">ca.crt:     <span class="number">1025</span> <span class="built_in">bytes</span></span><br><span class="line">namespace:  <span class="number">11</span> <span class="built_in">bytes</span></span><br></pre></td></tr></table></figure><p>保存 token 部分的内容</p><h3 id="部署-Metrics-Server"><a href="#部署-Metrics-Server" class="headerlink" title="部署 Metrics Server"></a>部署 Metrics Server</h3><p>Heapter 将在 Kubernetes 1.13 版本中移除（<a href="https://github.com/kubernetes/heapster/blob/master/docs/deprecation.md">https://github.com/kubernetes/heapster/blob/master/docs/deprecation.md</a>），推荐使用 metrics-server 与 Prometheus。</p><h4 id="1-导入-metrics-server-镜像"><a href="#1-导入-metrics-server-镜像" class="headerlink" title="1. 导入 metrics-server 镜像"></a>1. 导入 metrics-server 镜像</h4><p>下载地址：<a href="https://pan.baidu.com/s/1dKNbg7b9IBtPBnadLUADlg">metrics-server.tar</a></p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># docker <span class="keyword">load</span> -i metrics-<span class="keyword">server</span>.tar</span><br></pre></td></tr></table></figure><h4 id="2-保存配置文件"><a href="#2-保存配置文件" class="headerlink" title="2. 保存配置文件"></a>2. 保存配置文件</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># mkdir metrics-server</span></span><br><span class="line"><span class="meta"># cd metrics-server</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/aggregated-metrics-reader.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/auth-delegator.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/auth-reader.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/metrics-apiservice.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/metrics-server-deployment.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/metrics-server-service.yaml</span></span><br><span class="line"><span class="meta"># wget https://github.com/kubernetes-incubator/metrics-server/raw/master/deploy/1.8%2B/resource-reader.yaml</span></span><br></pre></td></tr></table></figure><p>修改 metrics-server-deployment.yaml 文件修改镜像默认拉去策略为 IfNotPresent</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim metrics-server-deployment.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/metrics-server-amd64:v0.3.1</span></span><br><span class="line">        <span class="comment">#imagePullPolicy: Always</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure><p>修改使用 IP 连接并且不验证证书</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim metrics-server-deployment.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">k8s.gcr.io/metrics-server-amd64:v0.3.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/metrics-server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalIP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure><h4 id="3-执行部署"><a href="#3-执行部署" class="headerlink" title="3. 执行部署"></a>3. 执行部署</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># kubectl apply -f ./</span></span><br></pre></td></tr></table></figure><h4 id="4-查看监控数据"><a href="#4-查看监控数据" class="headerlink" title="4. 查看监控数据"></a>4. 查看监控数据</h4><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl top nodes</span></span><br><span class="line"><span class="attribute">NAME</span>         CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line"><span class="attribute">k8s</span>-master   <span class="number">196</span>m         <span class="number">4</span>%     <span class="number">1101</span>Mi          <span class="number">14</span>%       </span><br><span class="line"><span class="attribute">k8s</span>-node<span class="number">1</span>    <span class="number">44</span>m          <span class="number">1</span>%     <span class="number">2426</span>Mi          <span class="number">31</span>%       </span><br><span class="line"><span class="attribute">k8s</span>-node<span class="number">2</span>    <span class="number">38</span>m          <span class="number">0</span>%     <span class="number">2198</span>Mi          <span class="number">28</span>% </span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl top pod --all-namespaces</span></span><br><span class="line"><span class="attribute">NAMESPACE</span>     NAME                                   CPU(cores)   MEMORY(bytes)   </span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-<span class="number">8</span>zhr<span class="number">5</span>               <span class="number">3</span>m           <span class="number">13</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   coredns-<span class="number">86</span>c<span class="number">58</span>d<span class="number">9</span>df<span class="number">4</span>-jqn<span class="number">7</span>r               <span class="number">2</span>m           <span class="number">13</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   etcd-k<span class="number">8</span>s-master                        <span class="number">17</span>m          <span class="number">76</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-apiserver-k<span class="number">8</span>s-master              <span class="number">30</span>m          <span class="number">402</span>Mi           </span><br><span class="line"><span class="attribute">kube</span>-system   kube-controller-manager-k<span class="number">8</span>s-master     <span class="number">36</span>m          <span class="number">63</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-krf<span class="number">6</span>t            <span class="number">2</span>m           <span class="number">13</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-tkftg            <span class="number">3</span>m           <span class="number">15</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-flannel-ds-amd<span class="number">64</span>-zxzld            <span class="number">2</span>m           <span class="number">12</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-<span class="number">5</span>znt<span class="number">7</span>                       <span class="number">2</span>m           <span class="number">14</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-gl<span class="number">9</span>sl                       <span class="number">2</span>m           <span class="number">18</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-proxy-q<span class="number">7</span>j<span class="number">7</span>m                       <span class="number">2</span>m           <span class="number">16</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kube-scheduler-k<span class="number">8</span>s-master              <span class="number">9</span>m           <span class="number">16</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   kubernetes-dashboard-<span class="number">57</span>df<span class="number">4</span>db<span class="number">6</span>b-wtmkt   <span class="number">1</span>m           <span class="number">16</span>Mi            </span><br><span class="line"><span class="attribute">kube</span>-system   metrics-server-<span class="number">879</span>f<span class="number">5</span>ff<span class="number">6</span>d-<span class="number">9</span>q<span class="number">5</span>xw         <span class="number">1</span>m           <span class="number">13</span>Mi  </span><br></pre></td></tr></table></figure><h3 id="查看-Dashboard"><a href="#查看-Dashboard" class="headerlink" title="查看 Dashboard"></a>查看 Dashboard</h3><h4 id="1-查找-dashboard-服务端口"><a href="#1-查找-dashboard-服务端口" class="headerlink" title="1. 查找 dashboard 服务端口"></a>1. 查找 dashboard 服务端口</h4><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line"><span class="attribute">NAME</span>                   TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line"><span class="attribute">kube</span>-dns               ClusterIP   <span class="number">10.96.0.10</span>      &lt;none&gt;        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP   <span class="number">3</span>d<span class="number">19</span>h</span><br><span class="line"><span class="attribute">kubernetes</span>-dashboard   NodePort    <span class="number">10.109.196.92</span>   &lt;none&gt;        <span class="number">443</span>:<span class="number">30678</span>/TCP   <span class="number">17</span>h</span><br><span class="line"><span class="attribute">metrics</span>-server         ClusterIP   <span class="number">10.109.23.19</span>    &lt;none&gt;        <span class="number">443</span>/TCP         <span class="number">6</span>m<span class="number">16</span>s</span><br></pre></td></tr></table></figure><p>端口为: 30678</p><h4 id="2-访问-dashboard"><a href="#2-访问-dashboard" class="headerlink" title="2. 访问 dashboard"></a>2. 访问 dashboard</h4><p>访问地址为: <a href="https://172.20.6.116:30678/">https://172.20.6.116:30678</a> ,选择令牌，输入之前保存的 token 即可进入<br><img data-src="/images/uploads/2019/01/login.png" alt="login"><br><img data-src="/images/uploads/2019/01/dashboard.png" alt="dashboard"></p><hr><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://blog.csdn.net/golduty2/article/details/80700491">kubeadm 部署 kube1.10</a><br><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">Creating a single master cluster with kubeadm</a><br><a href="https://www.cnblogs.com/Irving/p/9818440.html">使用 Kubeadm 安装部署 Kubernetes 1.12.1 集群</a><br><a href="https://juejin.im/entry/5c13894c6fb9a04a006ee615">kubeadm快速部署Kubernetes（1.13.1，HA）</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;最近有时间重新学习 k8s。k8s 的安装比之前简单了许多，本文介绍如何使用 kubeadm 部署 kubernetns 1.13.1&lt;/p&gt;
&lt;h1 id=&quot;前期准备&quot;&gt;&lt;a href=&quot;#前期准备&quot; class=&quot;headerlink&quot; title=&quot;前期准备&quot;&gt;&lt;/a&gt;前期准备&lt;/h1&gt;&lt;h2 id=&quot;环境概览&quot;&gt;&lt;a href=&quot;#环境概览&quot; class=&quot;headerlink&quot; title=&quot;环境概览&quot;&gt;&lt;/a&gt;环境概览&lt;/h2&gt;&lt;p&gt;准备了3台机器，有一台master，两台node，主机名及IP如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;主机名&lt;/th&gt;
&lt;th&gt;IP地址&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;k8s-master&lt;/td&gt;
&lt;td&gt;172.20.6.116&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node1&lt;/td&gt;
&lt;td&gt;172.20.6.117&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node2&lt;/td&gt;
&lt;td&gt;172.20.6.118&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;h2 id=&quot;系统设置&quot;&gt;&lt;a href=&quot;#系统设置&quot; class=&quot;headerlink&quot; title=&quot;系统设置&quot;&gt;&lt;/a&gt;系统设置&lt;/h2&gt;&lt;h3 id=&quot;1-修改三台机器的主机名&quot;&gt;&lt;a href=&quot;#1-修改三台机器的主机名&quot; class=&quot;headerlink&quot; title=&quot;1. 修改三台机器的主机名&quot;&gt;&lt;/a&gt;1. 修改三台机器的主机名&lt;/h3&gt;&lt;figure class=&quot;highlight gams&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# hostnamectl &lt;span class=&quot;keyword&quot;&gt;set&lt;/span&gt;-hostname &lt;span class=&quot;comment&quot;&gt;XXXX&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;2-设置本地解析&quot;&gt;&lt;a href=&quot;#2-设置本地解析&quot; class=&quot;headerlink&quot; title=&quot;2. 设置本地解析&quot;&gt;&lt;/a&gt;2. 设置本地解析&lt;/h3&gt;&lt;p&gt;编辑三台机器的 hosts 文件加入以下内容&lt;/p&gt;
&lt;figure class=&quot;highlight accesslog&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# vim /etc/hosts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;172.20.6.116&lt;/span&gt; k8s-master&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;172.20.6.117&lt;/span&gt; k8s-node1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;172.20.6.118&lt;/span&gt; k8s-node2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="docker" scheme="https://www.sunmite.com/categories/docker/"/>
    
    
    <category term="kubernetes" scheme="https://www.sunmite.com/tags/kubernetes/"/>
    
    <category term="kubeadmin" scheme="https://www.sunmite.com/tags/kubeadmin/"/>
    
  </entry>
  
  <entry>
    <title>使用pacemaker配置mariadb高可用集群</title>
    <link href="https://www.sunmite.com/openstack/MariaDB-High-availability-with-Pacemaker.html"/>
    <id>https://www.sunmite.com/openstack/MariaDB-High-availability-with-Pacemaker.html</id>
    <published>2018-11-14T02:00:44.000Z</published>
    <updated>2021-01-25T02:17:02.348Z</updated>
    
    <content type="html"><![CDATA[<p>Galera cluster是一个多主同步数据库集群，基于同步复制技术和 Oracle 的 MYSQL/InnoDB。使用Galera Cluster时，您可以直接任意节点读取和写入。并且在丢失任何单个节点时可以不中断操作且无需处理复杂故障转移过程。<br><img data-src="/images/uploads/2018/11/galera.png" alt="galera"><br>下面介绍如何为openstack环境配置mariadb galera高可用集群。</p><span id="more"></span><h2 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h2><h3 id="主机配置"><a href="#主机配置" class="headerlink" title="主机配置"></a>主机配置</h3><p>配置三个节点，使用openstack的控制节点<br>192.168.100.161 controller01<br>192.168.100.162 controller02<br>192.168.100.163 controller03</p><h3 id="Haproxy配置"><a href="#Haproxy配置" class="headerlink" title="Haproxy配置"></a>Haproxy配置</h3><p>haproxy 添加以下配置</p><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">frontend vip-db</span><br><span class="line">    bind 192.168.100.160:3306</span><br><span class="line">    timeout client 90m</span><br><span class="line">    default_backend db-galera</span><br><span class="line">backend db-galera</span><br><span class="line">    option httpchk</span><br><span class="line">    option tcpka</span><br><span class="line">    stick-table type ip size 1000</span><br><span class="line">    stick on dst</span><br><span class="line">    timeout server 90m</span><br><span class="line">    server controller01 192.168.100.161:3306<span class="built_in"> check </span>inter 1s port 9200 backup on-marked-down shutdown-sessions</span><br><span class="line">    server controller02 192.168.100.162:3306<span class="built_in"> check </span>inter 1s port 9200 backup on-marked-down shutdown-sessions</span><br><span class="line">    server controller03 192.168.100.163:3306<span class="built_in"> check </span>inter 1s port 9200 backup on-marked-down shutdown-sessions</span><br></pre></td></tr></table></figure><p>其中 192.168.100.160 是 vip 地址</p><h2 id="数据库集群的安装"><a href="#数据库集群的安装" class="headerlink" title="数据库集群的安装"></a>数据库集群的安装</h2><h3 id="安装和配置组件（所有节点）"><a href="#安装和配置组件（所有节点）" class="headerlink" title="安装和配置组件（所有节点）"></a>安装和配置组件（所有节点）</h3><ol><li><p>安装软件包</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install -y mariadb mariadb-galera-server mariadb-galera-common galera rsync xinetd</span></span><br></pre></td></tr></table></figure></li><li><p>创建 /etc/my.cnf.d/openstack.cnf 文件，加入以下内容</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/my.cnf.d/openstack.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">bind-address</span> = <span class="number">192.168</span>.<span class="number">100.161</span>   <span class="comment">#本机管理ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">default-storage-engine</span> = innodb</span><br><span class="line"><span class="attr">innodb_file_per_table</span> = <span class="literal">on</span></span><br><span class="line"><span class="attr">max_connections</span> = <span class="number">4096</span></span><br><span class="line"><span class="attr">collation-server</span> = utf8_general_ci</span><br><span class="line"><span class="attr">character-set-server</span> = utf8</span><br></pre></td></tr></table></figure></li><li><p>修改 mariadb 最大连接数</p></li></ol><ul><li>修改  /usr/lib/systemd/system/mariadb.service 文件加入以下内容<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /usr/lib/systemd/system/mariadb.service</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">LimitNOFILE</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">LimitNPROC</span>=<span class="number">10000</span></span><br></pre></td></tr></table></figure></li><li>重新加载服务<figure class="highlight clean"><table><tr><td class="code"><pre><span class="line"># systemctl --<span class="keyword">system</span> daemon-reload</span><br></pre></td></tr></table></figure></li></ul><h3 id="配置galera-cluster（所有节点）"><a href="#配置galera-cluster（所有节点）" class="headerlink" title="配置galera cluster（所有节点）"></a>配置galera cluster（所有节点）</h3><p>编辑 /etc/my.cnf.d/galera.cnf 文件，修改如下内容</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/my.cnf.d/galera.cnf &lt;&lt; EOF</span></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">skip-name-resolve</span>=1</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">default-storage-engine</span>=innodb</span><br><span class="line"><span class="attribute">innodb_autoinc_lock_mode</span>=2</span><br><span class="line"><span class="attribute">bind-address</span>=192.168.100.161</span><br><span class="line"><span class="attribute">wsrep_on</span>=1</span><br><span class="line"><span class="attribute">wsrep_provider</span>=/usr/lib64/galera/libgalera_smm.so</span><br><span class="line"><span class="attribute">wsrep_provider_options</span>=<span class="string">&quot;pc.recovery=TRUE;gcache.size=300M&quot;</span></span><br><span class="line"><span class="attribute">wsrep_cluster_name</span>=<span class="string">&quot;openstack_cluster&quot;</span></span><br><span class="line"><span class="attribute">wsrep_cluster_address</span>=<span class="string">&quot;gcomm://controller01,controller02,controller03&quot;</span></span><br><span class="line"><span class="attribute">wsrep_node_name</span>=<span class="string">&quot;controller01&quot;</span>                         #主机名</span><br><span class="line"><span class="attribute">wsrep_node_address</span>=<span class="string">&quot;192.168.100.161&quot;</span>                   #ip地址</span><br><span class="line"><span class="attribute">wsrep_slave_threads</span>=1</span><br><span class="line"><span class="attribute">wsrep_certify_nonPK</span>=1</span><br><span class="line"><span class="attribute">wsrep_max_ws_rows</span>=131072</span><br><span class="line"><span class="attribute">wsrep_max_ws_size</span>=1073741824</span><br><span class="line"><span class="attribute">wsrep_debug</span>=0</span><br><span class="line"><span class="attribute">wsrep_convert_LOCK_to_trx</span>=0</span><br><span class="line"><span class="attribute">wsrep_retry_autocommit</span>=1</span><br><span class="line"><span class="attribute">wsrep_auto_increment_control</span>=1</span><br><span class="line"><span class="attribute">wsrep_drupal_282555_workaround</span>=0</span><br><span class="line"><span class="attribute">wsrep_causal_reads</span>=0</span><br><span class="line">wsrep_notify_cmd=</span><br><span class="line"><span class="attribute">wsrep_sst_method</span>=rsync</span><br><span class="line"><span class="attribute">wsrep_sst_auth</span>=root:</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="配置-haproxy-健康检查（所有节点）"><a href="#配置-haproxy-健康检查（所有节点）" class="headerlink" title="配置 haproxy 健康检查（所有节点）"></a>配置 haproxy 健康检查（所有节点）</h3><ol><li>安装 xinted 服务<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install xinetd -y</span></span><br></pre></td></tr></table></figure></li><li>登录数据库，创建 clustercheck 用户，并设置其本地访问数据库的权限<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># systemctl start mariadb.service</span><br><span class="line"># mysql -e &quot;<span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;clustercheck&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;root1234&#x27;</span>;&quot;</span><br><span class="line"># systemctl stop mariadb.service</span><br></pre></td></tr></table></figure></li><li>为 clustercheck 用户创建配置文件 /etc/sysconfig/clustercheck<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/sysconfig/clustercheck &lt;&lt; EOF</span></span><br><span class="line">MYSQL_USERNAME=<span class="string">&quot;clustercheck&quot;</span></span><br><span class="line">MYSQL_PASSWORD=<span class="string">&quot;root1234&quot;</span></span><br><span class="line">MYSQL_HOST=<span class="string">&quot;localhost&quot;</span></span><br><span class="line">MYSQL_PORT=<span class="string">&quot;3306&quot;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li>创建个配置 HAProxy 监控服务 /etc/xinetd.d/galera-monitor<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cat &gt; /etc/xinetd.d/galera-monitor &lt;&lt; EOF</span></span><br><span class="line">service galera-monitor</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">port</span> = <span class="number">9200</span></span><br><span class="line">  <span class="attr">disable</span> = no</span><br><span class="line">  <span class="attr">socket_type</span> = stream</span><br><span class="line">  <span class="attr">protocol</span> = tcp</span><br><span class="line">  <span class="attr">wait</span> = no</span><br><span class="line">  <span class="attr">user</span> = root</span><br><span class="line">  <span class="attr">group</span> = root</span><br><span class="line">  <span class="attr">groups</span> = yes</span><br><span class="line">  <span class="attr">server</span> = /usr/bin/clustercheck</span><br><span class="line">  <span class="attr">type</span> = UNLISTED</span><br><span class="line">  <span class="attr">per_source</span> = UNLIMITED</span><br><span class="line">  <span class="attr">log_on_success</span> =</span><br><span class="line">  <span class="attr">log_on_failure</span> = HOST</span><br><span class="line">  <span class="attr">flags</span> = REUSE</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></li><li>启动 xineted 并设置开机自启<figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl daemon-reload</span></span><br><span class="line"><span class="meta"># systemctl enable xinetd</span></span><br><span class="line"><span class="meta"># systemctl start xinetd</span></span><br></pre></td></tr></table></figure><h3 id="完成安装"><a href="#完成安装" class="headerlink" title="完成安装"></a>完成安装</h3>创建数据库集群<figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># pcs resource <span class="keyword">create</span> galera-<span class="keyword">cluster</span> ocf:heartbeat:galera enable_creation=<span class="literal">true</span> wsrep_cluster_address=<span class="string">&quot;gcomm://controller01,controller02,controller03&quot;</span> additional_parameters=<span class="string">&#x27;--open-files-limit=16384&#x27;</span> enable_creation=<span class="literal">true</span> <span class="built_in">meta</span> master-<span class="built_in">max</span>=<span class="number">3</span> ordered=<span class="literal">true</span> op promote timeout=<span class="number">300</span>s <span class="keyword">on</span>-fail=block --master</span><br></pre></td></tr></table></figure>设置资源依赖<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"># pcs <span class="keyword">constraint</span> <span class="keyword">order</span> <span class="keyword">start</span> haproxy-clone <span class="keyword">then</span> galera-<span class="keyword">cluster</span>-master</span><br></pre></td></tr></table></figure></li></ol><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>查看 pacemaker 资源</p><figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pcs resource</span></span><br><span class="line">……</span><br><span class="line"> <span class="literal">Master</span>/<span class="literal">Slave</span> Set: galera-cluster-<span class="keyword">master</span> <span class="title">[galera-cluster</span>]</span><br><span class="line">     Masters: [ controller01 controller02 controller03 ]</span><br></pre></td></tr></table></figure><p>查看集群状态</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS like &#x27;wsrep_cluster_%&#x27;;</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">|<span class="string"> Variable_name            </span>|<span class="string"> Value                                </span>|</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">|<span class="string"> wsrep_cluster_conf_id    </span>|<span class="string"> 3                                    </span>|</span><br><span class="line">|<span class="string"> wsrep_cluster_size       </span>|<span class="string"> 3                                    </span>|</span><br><span class="line">|<span class="string"> wsrep_cluster_state_uuid </span>|<span class="string"> 83d58f96-e6e3-11e8-82ab-87f7bf579cc6 </span>|</span><br><span class="line">|<span class="string"> wsrep_cluster_status     </span>|<span class="string"> Primary                              </span>|</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure><p>wsrep_cluster_size 为 3 集群成功创建。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Galera cluster是一个多主同步数据库集群，基于同步复制技术和 Oracle 的 MYSQL/InnoDB。使用Galera Cluster时，您可以直接任意节点读取和写入。并且在丢失任何单个节点时可以不中断操作且无需处理复杂故障转移过程。&lt;br&gt;&lt;img data-src=&quot;/images/uploads/2018/11/galera.png&quot; alt=&quot;galera&quot;&gt;&lt;br&gt;下面介绍如何为openstack环境配置mariadb galera高可用集群。&lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="mysql" scheme="https://www.sunmite.com/tags/mysql/"/>
    
    <category term="pacemaker" scheme="https://www.sunmite.com/tags/pacemaker/"/>
    
  </entry>
  
  <entry>
    <title>使用 pacemaker 配置 rabbitmq 高可用集群</title>
    <link href="https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html"/>
    <id>https://www.sunmite.com/openstack/RabbitMQ-High-availability-with-Pacemaker.html</id>
    <published>2018-11-12T04:05:18.000Z</published>
    <updated>2021-01-25T02:17:02.349Z</updated>
    
    <content type="html"><![CDATA[<p>OpenStack 高可用集群各个服务组件之间使用消息队列进行通信，消息队列系统的高可用是 OpenStack 集群能够提供高可用服务的核心基础。在 OpenStack 中 Rabbitmq 是使用最多的高级消息队列系统。下文介绍如何使用 pacemaker 集群配置Rabbitmq 的高可用。</p><span id="more"></span><h3 id="安装和配置组件"><a href="#安装和配置组件" class="headerlink" title="安装和配置组件"></a>安装和配置组件</h3><ol><li><p>安装软件包</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install rabbitmq-server -y</span></span><br></pre></td></tr></table></figure></li><li><p>防止网络分区</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/rabbitmq/rabbitmq.config</span></span><br><span class="line">修改：</span><br><span class="line">%%  &#123;cluster_partition_handling, ignore&#125;,</span><br><span class="line">为：</span><br><span class="line">  &#123;cluster_partition_handling, pause_minority&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改监听地址</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;NODE_IP_ADDRESS=<span class="variable">$&#123;管理ip&#125;</span>&quot;</span> &gt; /etc/rabbitmq/rabbitmq-env.conf</span></span><br></pre></td></tr></table></figure></li><li><p>rabbitmq集群配置</p></li></ol><ul><li>创建自动创建用户设置权限的脚本<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">Vim /usr/<span class="keyword">local</span>/sbin/set_rabbitmq_policy</span><br><span class="line"></span><br><span class="line"># This script is called <span class="keyword">by</span> rabbitmq-server-ha.ocf during RabbitMQ</span><br><span class="line"># <span class="keyword">cluster</span> start up. It is a convenient place to <span class="keyword">set</span> your <span class="keyword">cluster</span></span><br><span class="line"># policy here, <span class="keyword">for</span> example:</span><br><span class="line">#<span class="variable">$&#123;OCF_RESKEY_ctl&#125;</span> set_policy ha-all <span class="string">&quot;.&quot;</span> &#x27;&#123;<span class="string">&quot;ha-mode&quot;</span>:<span class="string">&quot;all&quot;</span>, <span class="string">&quot;ha-sync-mode&quot;</span>:<span class="string">&quot;automatic&quot;</span>&#125;&#x27; --apply-to all --priority 0</span><br><span class="line"><span class="variable">$&#123;OCF_RESKEY_ctl&#125;</span> set_policy ha-all <span class="string">&quot;.&quot;</span> &#x27;&#123;<span class="string">&quot;ha-mode&quot;</span>:<span class="string">&quot;all&quot;</span>, <span class="string">&quot;ha-sync-mode&quot;</span>:<span class="string">&quot;automatic&quot;</span>&#125;&#x27; --apply-to all --priority 0</span><br><span class="line">#add user usage:user passwd</span><br><span class="line"><span class="variable">$&#123;OCF_RESKEY_ctl&#125;</span> add_user openstack 7136fb0c6ac12946e06f</span><br><span class="line"><span class="variable">$&#123;OCF_RESKEY_ctl&#125;</span> set_permissions openstack <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br></pre></td></tr></table></figure></li><li>为脚本增加执行权限<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># chmod <span class="number">755</span> <span class="regexp">/usr/</span>local<span class="regexp">/sbin/</span>set_rabbitmq_policy</span><br></pre></td></tr></table></figure></li><li>创建 rabbitmq 高可用集群<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pcs resource create --force --master rabbitmq-cluster ocf:rabbitmq:rabbitmq-server-ha \</span></span><br><span class="line">    <span class="attribute">erlang_cookie</span>=DPMDALGUKEOMPTHWPYKC <span class="attribute">node_port</span>=5672 \</span><br><span class="line">    op monitor <span class="attribute">interval</span>=30 <span class="attribute">timeout</span>=120 \</span><br><span class="line">    op monitor <span class="attribute">interval</span>=27 <span class="attribute">role</span>=Master <span class="attribute">timeout</span>=120 \</span><br><span class="line">    op monitor <span class="attribute">interval</span>=30 <span class="attribute">role</span>=Slave <span class="attribute">timeout</span>=120 <span class="attribute">OCF_CHECK_LEVEL</span>=30 \</span><br><span class="line">    op start <span class="attribute">interval</span>=0 <span class="attribute">timeout</span>=360 \</span><br><span class="line">    op stop <span class="attribute">interval</span>=0 <span class="attribute">timeout</span>=120 \</span><br><span class="line">    op promote <span class="attribute">interval</span>=0 <span class="attribute">timeout</span>=120 \</span><br><span class="line">    op demote <span class="attribute">interval</span>=0 <span class="attribute">timeout</span>=120 \</span><br><span class="line">    op notify <span class="attribute">interval</span>=0 <span class="attribute">timeout</span>=180 \</span><br><span class="line">    meta <span class="attribute">notify</span>=<span class="literal">true</span> <span class="attribute">ordered</span>=<span class="literal">false</span> <span class="attribute">interleave</span>=<span class="literal">false</span> <span class="attribute">master-max</span>=1 <span class="attribute">master-node-max</span>=1</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3></li></ul><ol><li>确认集群状态<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl cluster_status</span></span><br><span class="line">Cluster status of node rabbit@controller01 ...</span><br><span class="line">[&#123;nodes,[&#123;disc,[rabbit@controller01]&#125;,</span><br><span class="line">&#123;ram,[rabbit@controller03,rabbit@controller02]&#125;]&#125;,</span><br><span class="line">&#123;running_nodes,[rabbit@controller02,rabbit@controller03,rabbit@controller01]&#125;,</span><br><span class="line">&#123;cluster_name,&lt;&lt;<span class="string">&quot;rabbit@controller01&quot;</span>&gt;&gt;&#125;,</span><br><span class="line">&#123;partitions,[]&#125;,</span><br><span class="line">&#123;alarms,[&#123;rabbit@controller02,[]&#125;,</span><br><span class="line">&#123;rabbit@controller03,[]&#125;,</span><br><span class="line">&#123;rabbit@controller01,[]&#125;]&#125;]</span><br></pre></td></tr></table></figure></li><li>确认高可用状态<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># pcs resource </span></span><br><span class="line"> vip(<span class="meta">ocf::heartbeat:IPaddr2</span>):<span class="literal">Started</span> controller01</span><br><span class="line"> <span class="keyword">Clone</span> <span class="title">Set</span>: haproxy-<span class="keyword">clone</span> <span class="title">[haproxy</span>]</span><br><span class="line">     <span class="literal">Started</span>: [ controller01 controller02 controller03 ]</span><br><span class="line"> <span class="keyword">Clone</span> <span class="title">Set</span>: memcached-<span class="keyword">clone</span> <span class="title">[memcached</span>]</span><br><span class="line">     <span class="literal">Started</span>: [ controller01 controller02 controller03 ]</span><br><span class="line"> <span class="literal">Master</span>/<span class="literal">Slave</span> Set: rabbitmq-cluster-<span class="keyword">master</span> <span class="title">[rabbitmq-cluster</span>]</span><br><span class="line">     Masters: [ controller03 ]</span><br><span class="line">     Slaves: [ controller01 controller02 ]</span><br></pre></td></tr></table></figure></li><li>确认 rabbitmq 集群策略<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line"># rabbitmqctl  list_policies</span><br><span class="line"><span class="function"><span class="title">Listing</span></span> policies ...</span><br><span class="line">/ha-<span class="keyword">all</span><span class="keyword">all</span>.&#123;<span class="string">&quot;ha-mode&quot;</span>:<span class="string">&quot;all&quot;</span>,<span class="string">&quot;ha-sync-mode&quot;</span>:<span class="string">&quot;automatic&quot;</span>&#125;<span class="number">0</span></span><br></pre></td></tr></table></figure></li><li>确认 rabbitmq 用户是否正确创建<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl list_users</span></span><br><span class="line"><span class="attribute">Listing</span> users ...</span><br><span class="line"><span class="attribute">openstack</span><span class="meta">[]</span></span><br><span class="line"><span class="attribute">guest</span><span class="meta">[administrator]</span></span><br></pre></td></tr></table></figure></li><li>确认 openstack 用户访问权限<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rabbitmqctl list_permissions </span></span><br><span class="line">Listing permissions in vhost <span class="string">&quot;/&quot;</span> <span class="string">...</span></span><br><span class="line">guest.*.*.*</span><br><span class="line">openstack.*.*.*</span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;OpenStack 高可用集群各个服务组件之间使用消息队列进行通信，消息队列系统的高可用是 OpenStack 集群能够提供高可用服务的核心基础。在 OpenStack 中 Rabbitmq 是使用最多的高级消息队列系统。下文介绍如何使用 pacemaker 集群配置Rabbitmq 的高可用。&lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="rabbitmq" scheme="https://www.sunmite.com/tags/rabbitmq/"/>
    
    <category term="pacemaker" scheme="https://www.sunmite.com/tags/pacemaker/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack 二层网络模式下弹性伸缩测试</title>
    <link href="https://www.sunmite.com/openstack/openstack-autoscalin.html"/>
    <id>https://www.sunmite.com/openstack/openstack-autoscalin.html</id>
    <published>2018-10-19T07:14:10.000Z</published>
    <updated>2021-01-25T02:17:02.335Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>操作系统：CentOS Linux release 7.5.1804 (Core)<br>OpenStack版本：OpenStack Ocata Allinone<br>注意事项：packstack安装时开启 heat-cfn,gnocchi,aodh,panko等   </p><span id="more"></span><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="环境修改"><a href="#环境修改" class="headerlink" title="环境修改"></a>环境修改</h2><p>修改 OpenStack 为二层模式，修改方法这里不在赘述。</p><h2 id="过程描述"><a href="#过程描述" class="headerlink" title="过程描述"></a>过程描述</h2><p><img data-src="/images/uploads/2018/10/liucheng.png" alt="流程图"></p><h2 id="测试步骤"><a href="#测试步骤" class="headerlink" title="测试步骤"></a>测试步骤</h2><h3 id="创建-Stack"><a href="#创建-Stack" class="headerlink" title="创建 Stack"></a>创建 Stack</h3><p>使用以下模版创建 Stack</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">heat_template_version:</span> <span class="number">2016-10-14</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">Example</span> <span class="string">auto</span> <span class="string">scale</span> <span class="string">group,</span> <span class="string">policy</span> <span class="string">and</span> <span class="string">alarm</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">scaleup_group:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Heat::AutoScalingGroup</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">cooldown:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">desired_capacity:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">max_size:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">min_size:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">OS::Nova::Server</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">&#x27;xenial-server-cloudimg-amd64&#x27;</span></span><br><span class="line">          <span class="attr">metadata:</span> &#123;<span class="attr">&quot;metering.server_group&quot;:</span> &#123;<span class="attr">get_param:</span> <span class="string">&quot;OS::stack_id&quot;</span>&#125;&#125;</span><br><span class="line">          <span class="attr">flavor:</span> <span class="string">m1.small</span></span><br><span class="line">          <span class="attr">networks:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">network:</span> <span class="string">net0</span></span><br><span class="line">            </span><br><span class="line">  <span class="attr">scaleup_policy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Heat::ScalingPolicy</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">adjustment_type:</span> <span class="string">change_in_capacity</span></span><br><span class="line">      <span class="attr">auto_scaling_group_id:</span> &#123; <span class="attr">get_resource:</span> <span class="string">scaleup_group</span> &#125;</span><br><span class="line">      <span class="attr">cooldown:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">scaling_adjustment:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">scaledown_policy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Heat::ScalingPolicy</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">adjustment_type:</span> <span class="string">change_in_capacity</span></span><br><span class="line">      <span class="attr">auto_scaling_group_id:</span> &#123; <span class="attr">get_resource:</span> <span class="string">scaleup_group</span> &#125;</span><br><span class="line">      <span class="attr">cooldown:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">scaling_adjustment:</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cpu_alarm_high:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Aodh::GnocchiAggregationByResourcesAlarm</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">description:</span> <span class="string">Scale</span> <span class="string">up</span> <span class="string">if</span> <span class="string">CPU</span> <span class="string">&gt;</span> <span class="number">80</span><span class="string">%</span></span><br><span class="line">      <span class="attr">metric:</span> <span class="string">cpu_util</span></span><br><span class="line">      <span class="attr">aggregation_method:</span> <span class="string">mean</span></span><br><span class="line">      <span class="attr">granularity:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">evaluation_periods:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">threshold:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">resource_type:</span> <span class="string">instance</span></span><br><span class="line">      <span class="attr">comparison_operator:</span> <span class="string">gt</span></span><br><span class="line">      <span class="attr">alarm_actions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">str_replace:</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">trust+url</span></span><br><span class="line">            <span class="attr">params:</span></span><br><span class="line">              <span class="attr">url:</span> &#123;<span class="attr">get_attr:</span> [<span class="string">scaleup_policy</span>, <span class="string">signal_url</span>]&#125;</span><br><span class="line">      <span class="attr">query:</span></span><br><span class="line">        <span class="attr">str_replace:</span></span><br><span class="line">          <span class="attr">template:</span> <span class="string">&#x27;&#123;&quot;=&quot;: &#123;&quot;server_group&quot;: &quot;stack_id&quot;&#125;&#125;&#x27;</span></span><br><span class="line">          <span class="attr">params:</span></span><br><span class="line">            <span class="attr">stack_id:</span> &#123;<span class="attr">get_param:</span> <span class="string">&quot;OS::stack_id&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">cpu_alarm_low:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">OS::Aodh::GnocchiAggregationByResourcesAlarm</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">metric:</span> <span class="string">cpu_util</span></span><br><span class="line">      <span class="attr">aggregation_method:</span> <span class="string">mean</span></span><br><span class="line">      <span class="attr">granularity:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">evaluation_periods:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">threshold:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">resource_type:</span> <span class="string">instance</span></span><br><span class="line">      <span class="attr">comparison_operator:</span> <span class="string">lt</span></span><br><span class="line">      <span class="attr">alarm_actions:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">str_replace:</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">trust+url</span></span><br><span class="line">            <span class="attr">params:</span></span><br><span class="line">              <span class="attr">url:</span> &#123;<span class="attr">get_attr:</span> [<span class="string">scaledown_policy</span>, <span class="string">signal_url</span>]&#125;</span><br><span class="line">      <span class="attr">query:</span></span><br><span class="line">        <span class="attr">str_replace:</span></span><br><span class="line">          <span class="attr">template:</span> <span class="string">&#x27;&#123;&quot;=&quot;: &#123;&quot;server_group&quot;: &quot;stack_id&quot;&#125;&#125;&#x27;</span></span><br><span class="line">          <span class="attr">params:</span></span><br><span class="line">            <span class="attr">stack_id:</span> &#123;<span class="attr">get_param:</span> <span class="string">&quot;OS::stack_id&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">outputs:</span></span><br><span class="line">  <span class="attr">scaleup_policy_signal_url:</span></span><br><span class="line">    <span class="attr">value:</span> &#123;<span class="attr">get_attr:</span> [<span class="string">scaleup_policy</span>, <span class="string">signal_url</span>]&#125;</span><br><span class="line"></span><br><span class="line">  <span class="attr">scaledown_policy_signal_url:</span></span><br><span class="line">    <span class="attr">value:</span> &#123;<span class="attr">get_attr:</span> [<span class="string">scaledown_policy</span>, <span class="string">signal_url</span>]&#125;</span><br></pre></td></tr></table></figure><p>模版定义两个告警和伸缩策略，当 CPU 使用率在 300s 内大于 80% 则发出告警，heat 接收到告警开始创建新的虚拟机，最多 3 台。当 CPU 使用率在 300s 内小于 10% 则发出告警，heat 接收到告警开始删除虚拟机，最少保留 1 台。</p><h3 id="查看创建的-stack-、alarm-和虚拟机"><a href="#查看创建的-stack-、alarm-和虚拟机" class="headerlink" title="查看创建的 stack 、alarm 和虚拟机"></a>查看创建的 stack 、alarm 和虚拟机</h3><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">~ openstack stack list</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------<span class="code">+-----------------+</span>----------------------<span class="code">+--------------+</span></span><br><span class="line">| ID                                   | Stack Name  | Stack Status    | Creation Time        | Updated Time |</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------<span class="code">+-----------------+</span>----------------------<span class="code">+--------------+</span></span><br><span class="line">| af75c5e5-35c6-4ab3-b899-e4d9afbbcd74 | autoscaling | CREATE_COMPLETE | 2018-10-19T03:32:29Z | None         |</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------<span class="code">+-----------------+</span>----------------------<span class="code">+--------------+</span></span><br><span class="line"></span><br><span class="line">➜  ~ openstack alarm list</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| alarm_id                             | type                                       | name                                    | state | severity | enabled |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| 6dfded8c-21a9-4792-a21c-eebc421e8706 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_low-4e2ptwvvhbjq  | alarm | low      | True    |</span><br><span class="line">| 2eaa8f6c-3ec5-43ca-8c19-81470c0686a8 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_high-2t4zh5stxmt7 | ok    | low      | True    |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line"></span><br><span class="line">~ openstack server list</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------------------------------------------------<span class="code">+--------+</span>----------------<span class="code">+------------------------------+</span></span><br><span class="line">| ID                                   | Name                                                  | Status | Networks       | Image Name                   |</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------------------------------------------------<span class="code">+--------+</span>----------------<span class="code">+------------------------------+</span></span><br><span class="line">| 3d723c6d-6c3e-41ba-a906-ded508f5006a | au-aleup_group-glnobyldea74-jnbifnyzqpr7-vghtyrjmru5u | ACTIVE | net0=10.0.1.6  | xenial-server-cloudimg-amd64 |</span><br><span class="line"><span class="code">+--------------------------------------+</span>-------------------------------------------------------<span class="code">+--------+</span>----------------<span class="code">+------------------------------+</span></span><br></pre></td></tr></table></figure><h3 id="自动创建测试"><a href="#自动创建测试" class="headerlink" title="自动创建测试"></a>自动创建测试</h3><h4 id="1-通过-stress-程序对虚拟机-CPU-进行压测"><a href="#1-通过-stress-程序对虚拟机-CPU-进行压测" class="headerlink" title="1. 通过 stress 程序对虚拟机 CPU 进行压测"></a>1. 通过 stress 程序对虚拟机 CPU 进行压测</h4><p>打开虚拟机控制台，运行以下命令进行 CPU 压测，持续 1200s</p><figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span> <span class="comment">stress</span> --<span class="comment">cpu</span> <span class="comment">1</span> --<span class="comment">timeout</span> <span class="comment">1200</span></span><br></pre></td></tr></table></figure><p><img data-src="/images/uploads/2018/10/CPU.png" alt="压力测试"></p><h4 id="2-查看虚拟机的-CPU-使用率"><a href="#2-查看虚拟机的-CPU-使用率" class="headerlink" title="2. 查看虚拟机的 CPU 使用率"></a>2. 查看虚拟机的 CPU 使用率</h4><p>使用以下命令查询虚拟机的 CPU 使用率</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">~ gnocchi measures show cpu_util --resource-id instance_uuid</span><br><span class="line"></span><br><span class="line">+---------------------------+-------------+----------------+</span><br><span class="line">|<span class="string"> timestamp                 </span>|<span class="string"> granularity </span>|<span class="string">          value </span>|</span><br><span class="line">+---------------------------+-------------+----------------+</span><br><span class="line">|<span class="string"> 2018-10-19T06:00:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  0.16605959835 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:05:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.161092701601 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:10:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.162481952842 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:15:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.166559675456 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:20:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.167608932622 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:25:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.664303071272 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:30:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.170293083241 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:35:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  63.2803744387 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:40:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  99.9796696522 </span>|</span><br><span class="line">+---------------------------+-------------+----------------+</span><br></pre></td></tr></table></figure><p>最后两条记录显示 CPU 占用率已经 &gt; 80% 了</p><h4 id="3-查看告警触发情况"><a href="#3-查看告警触发情况" class="headerlink" title="3. 查看告警触发情况"></a>3. 查看告警触发情况</h4><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"><span class="code"> ~ openstack alarm list                                                             </span></span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| alarm_id                             | type                                       | name                                    | state | severity | enabled |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| 6dfded8c-21a9-4792-a21c-eebc421e8706 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_low-4e2ptwvvhbjq  | ok    | low      | True    |</span><br><span class="line">| 2eaa8f6c-3ec5-43ca-8c19-81470c0686a8 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_high-2t4zh5stxmt7 | alarm | low      | True    |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br></pre></td></tr></table></figure><p>可以看到 autoscaling-cpu_alarm_high-2t4zh5stxmt7 告警已经被触发</p><h4 id="4-查看虚拟机"><a href="#4-查看虚拟机" class="headerlink" title="4. 查看虚拟机"></a>4. 查看虚拟机</h4><p><img data-src="/images/uploads/2018/10/create.png" alt="自动创建"><br>可以看到自动创建了一台虚拟机</p><h3 id="自动删除测试"><a href="#自动删除测试" class="headerlink" title="自动删除测试"></a>自动删除测试</h3><h4 id="1-停止虚拟机压测程序"><a href="#1-停止虚拟机压测程序" class="headerlink" title="1. 停止虚拟机压测程序"></a>1. 停止虚拟机压测程序</h4><p>停止压测程序，等待 CPU 使用率降低下来</p><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line">~ gnocchi measures show cpu_util --resource-id 578a14e4-1e00-4812-8039-81209f135116 </span><br><span class="line">+---------------------------+-------------+----------------+</span><br><span class="line">|<span class="string"> timestamp                 </span>|<span class="string"> granularity </span>|<span class="string">          value </span>|</span><br><span class="line">+---------------------------+-------------+----------------+</span><br><span class="line">|<span class="string"> 2018-10-19T06:00:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  0.16605959835 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:05:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.161092701601 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:10:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.162481952842 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:15:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.166559675456 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:20:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.167608932622 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:25:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.664303071272 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:30:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.170293083241 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:35:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  63.2803744387 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:40:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  94.3206761804 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:45:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  99.9847353387 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:50:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">   99.984336257 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T06:55:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string">  30.1423223067 </span>|</span><br><span class="line">|<span class="string"> 2018-10-19T07:00:00+00:00 </span>|<span class="string">       300.0 </span>|<span class="string"> 0.163830348301 </span>|</span><br><span class="line">+---------------------------+-------------+----------------+</span><br></pre></td></tr></table></figure><p>可以看到 CPU 的使用率已经降了下来</p><h4 id="2-查看告警触发情况"><a href="#2-查看告警触发情况" class="headerlink" title="2. 查看告警触发情况"></a>2. 查看告警触发情况</h4><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">~ openstack alarm list                                                                         </span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| alarm_id                             | type                                       | name                                    | state | severity | enabled |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br><span class="line">| 6dfded8c-21a9-4792-a21c-eebc421e8706 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_low-4e2ptwvvhbjq  | alarm | low      | True    |</span><br><span class="line">| 2eaa8f6c-3ec5-43ca-8c19-81470c0686a8 | gnocchi_aggregation_by_resources_threshold | autoscaling-cpu_alarm_high-2t4zh5stxmt7 | ok    | low      | True    |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------------<span class="code">+-----------------------------------------+</span>-------<span class="code">+----------+</span>---------+</span><br></pre></td></tr></table></figure><p>可以看到 autoscaling-cpu_alarm_low-4e2ptwvvhbjq 告警已经被触发</p><h4 id="3-查看虚拟机"><a href="#3-查看虚拟机" class="headerlink" title="3. 查看虚拟机"></a>3. 查看虚拟机</h4><p><img data-src="/images/uploads/2018/10/delete.png" alt="自动删除"><br>可以看到最早创建的一台虚拟机被自动删除了</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文只是最简单的测试，heat 还可以结合 lb 实现更强大的弹性伸缩功能，值得深入学习下。</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h1&gt;&lt;p&gt;操作系统：CentOS Linux release 7.5.1804 (Core)&lt;br&gt;OpenStack版本：OpenStack Ocata Allinone&lt;br&gt;注意事项：packstack安装时开启 heat-cfn,gnocchi,aodh,panko等   &lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="heat" scheme="https://www.sunmite.com/tags/heat/"/>
    
  </entry>
  
  <entry>
    <title>容器生态系统</title>
    <link href="https://www.sunmite.com/docker/container-system.html"/>
    <id>https://www.sunmite.com/docker/container-system.html</id>
    <published>2018-09-27T07:33:11.000Z</published>
    <updated>2021-01-25T02:17:02.356Z</updated>
    
    <content type="html"><![CDATA[<p>图片整理自《每天5分钟玩转Docker容器技术》</p><p><img data-src="/images/uploads/2018/09/container.png" alt="image"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;图片整理自《每天5分钟玩转Docker容器技术》&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&quot;/images/uploads/2018/09/container.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
</summary>
      
    
    
    
    <category term="docker" scheme="https://www.sunmite.com/categories/docker/"/>
    
    
    <category term="docker" scheme="https://www.sunmite.com/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>kolla-mitaka-eol 部署openstack mitaka遇到的问题</title>
    <link href="https://www.sunmite.com/openstack/kolla-mitaka-eol-deploy-openstack.html"/>
    <id>https://www.sunmite.com/openstack/kolla-mitaka-eol-deploy-openstack.html</id>
    <published>2018-07-09T13:13:17.000Z</published>
    <updated>2018-07-18T02:42:17.000Z</updated>
    
    <content type="html"><![CDATA[<p>实验需要使用 kolla 部署 openstack mitaka环境，由于是两年前的版本，实验过程中遇到了一些坑，记录如下。</p><h1 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h1><p>操作系统：CentOS Linux release 7.2.1511 (Core)<br>内核版本：3.10.0-327.28.3.el7.x86_64<br>kolla版本：mitaka-eol<br>docker版本：Docker version 1.13.1, build 092cba3<br>docker镜像：官方tag 2.0.2 (对应 openstack mitaka版本)</p><h1 id="问题一-openvswitch-db-容器无法运行"><a href="#问题一-openvswitch-db-容器无法运行" class="headerlink" title="问题一: openvswitch_db 容器无法运行"></a>问题一: openvswitch_db 容器无法运行</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>kolla-ansible deploy 部署openstack的时候总会遇到 openvswitch_db service 无法启动的问题</p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">TASK: [neutron | Waiting the openvswitch_db service <span class="keyword">to</span> be ready] ************** </span><br><span class="line">failed: [localhost] =&gt; &#123;<span class="string">&quot;attempts&quot;</span>: <span class="number">30</span>, <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;cmd&quot;</span>: [<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;openvswitch_db&quot;</span>, <span class="string">&quot;ovs-vsctl&quot;</span>, <span class="string">&quot;--no-wait&quot;</span>, <span class="string">&quot;show&quot;</span>], <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.032518&quot;</span>, <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2018-07-09 07:33:12.680647&quot;</span>, <span class="string">&quot;failed&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;rc&quot;</span>: <span class="number">1</span>, <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2018-07-09 07:33:12.648129&quot;</span>, <span class="string">&quot;stdout_lines&quot;</span>: [], <span class="string">&quot;warnings&quot;</span>: []&#125;</span><br><span class="line">stderr: <span class="built_in">Error</span> response <span class="keyword">from</span> daemon: Container <span class="number">0cec</span>739aabe06805aa0e1624318ac052d9f8fb176078df3d20a13c4df304fa7a <span class="keyword">is</span> restarting, wait <span class="keyword">until</span> the container <span class="keyword">is</span> running</span><br><span class="line">msg: Task failed <span class="keyword">as</span> maximum retries was encountered</span><br><span class="line"></span><br><span class="line">FATAL: all hosts have already failed -- aborting</span><br></pre></td></tr></table></figure><p>查看容器日志有如下报错</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">INFO:__main__:Kolla config strategy <span class="keyword">set</span> to: COPY_ALWAYS</span><br><span class="line">INFO:__main__:Loading config <span class="keyword">file</span> at /<span class="keyword">var</span>/lib/kolla/config_files/config.json</span><br><span class="line">INFO:__main__:Validating config <span class="keyword">file</span></span><br><span class="line">INFO:__main__:Copying service configuration files</span><br><span class="line">INFO:__main__:Writing <span class="keyword">out</span> command to execute</span><br><span class="line">Running command: &#x27;/usr/sbin/ovsdb-server /<span class="keyword">var</span>/lib/openvswitch/<span class="keyword">conf</span>.<span class="keyword">db</span> -vconsole:emer -vsyslog:<span class="keyword">err</span> -vfile:info --remote=punix:/<span class="keyword">run</span>/openvswitch/<span class="keyword">db</span>.sock --<span class="keyword">log</span>-<span class="keyword">file</span>=/<span class="keyword">var</span>/<span class="keyword">log</span>/openvswitch/ovsdb-server.<span class="keyword">log</span>&#x27;</span><br><span class="line">ovsdb-server: I/O <span class="keyword">error</span>: <span class="keyword">open</span>: /<span class="keyword">var</span>/lib/openvswitch/<span class="keyword">conf</span>.<span class="keyword">db</span> failed (<span class="keyword">No</span> such <span class="keyword">file</span> or directory)</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><h3 id="1-手动创建-openvswitch-db-容器，并进入交互模式"><a href="#1-手动创建-openvswitch-db-容器，并进入交互模式" class="headerlink" title="1. 手动创建 openvswitch_db 容器，并进入交互模式"></a>1. 手动创建 openvswitch_db 容器，并进入交互模式</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">docker</span> run -it kolla/centos-source-openvswitch-db-server:<span class="number">2</span>.<span class="number">0</span>.<span class="number">2</span> /bin/bash</span><br></pre></td></tr></table></figure><h3 id="2-查看启动命令"><a href="#2-查看启动命令" class="headerlink" title="2. 查看启动命令"></a>2. 查看启动命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cd /usr/local/bin</span></span><br><span class="line"><span class="comment"># vi kolla_start</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for the log socket</span></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;!SKIP_LOG_SETUP[@]&#125;</span>&quot;</span> &amp;&amp; -e /var/lib/kolla/heka ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">while</span> [[ ! -S /var/lib/kolla/heka/<span class="built_in">log</span> ]]; <span class="keyword">do</span></span><br><span class="line">        sleep 1</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Processing /var/lib/kolla/config_files/config.json as root.  This is necessary</span></span><br><span class="line"><span class="comment"># to permit certain files to be controlled by the root user which should</span></span><br><span class="line"><span class="comment"># not be writable by the dropped-privileged user, especially /run_command</span></span><br><span class="line">sudo -E kolla_set_configs</span><br><span class="line">CMD=$(cat /run_command)</span><br><span class="line">ARGS=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$&#123;!KOLLA_SKIP_EXTEND_START[@]&#125;</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># Run additional commands if present</span></span><br><span class="line">    <span class="built_in">source</span> kolla_extend_start</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running command: &#x27;<span class="variable">$&#123;CMD&#125;</span><span class="variable">$&#123;ARGS:+ $ARGS&#125;</span>&#x27;&quot;</span></span><br><span class="line"><span class="built_in">exec</span> <span class="variable">$&#123;CMD&#125;</span> <span class="variable">$&#123;ARGS&#125;</span></span><br></pre></td></tr></table></figure><p>注意到 kolla_extend_start 这个脚本</p><h3 id="3-查看-kolla-extend-start"><a href="#3-查看-kolla-extend-start" class="headerlink" title="3. 查看 kolla_extend_start"></a>3. 查看 kolla_extend_start</h3><figure class="highlight d"><table><tr><td class="code"><pre><span class="line"># vi kolla_extend_start</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">&quot;/run/openvswitch&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -e <span class="string">&quot;/etc/openvswitch/conf.db&quot;</span> ]]; then</span><br><span class="line">    ovsdb-tool create <span class="string">&quot;/etc/openvswitch/conf.db&quot;</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>容器启动首先运行 kolla_start 脚本，当没有配置 KOLLA_SKIP_EXTEND_START 变量的时候继续执行 kolla_extend_start 进行一些初始化操作。<br>问题就出在创建 conf.db ，kolla_extend_start 创建的 conf.db 位于 /etc/openvswitch/conf.db ，而启动命令传入的路径却是 /var/lib/openvswitch/conf.db ，所以会报错找不到 /var/lib/openvswitch/conf.db</p><h2 id="修改方法"><a href="#修改方法" class="headerlink" title="修改方法"></a>修改方法</h2><p>两种修改方法，一是修改 openvswitch_db 镜像里面的 kolla_extend_start 脚本创建conf.db的位置，二是修改 openvswitch_db 容器的启动命令参数，这里为了镜像的完整性和操做便利我选择了方法二。<br>编辑 vim /etc/kolla/openvswitch-db-server/config.json 修改如下</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;/usr/sbin/ovsdb-server /etc/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/run/openvswitch/db.sock --log-file=/var/log/openvswitch/ovsdb-server.log&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config_files&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种情况下的配置文件会被 clean-host 命令清理掉，所有我们继续查找 /etc/kolla/openvswitch-db-server/config.json 是在哪里生成的。<br>查找到如下位置 /usr/share/kolla/ansible/roles/neutron/templates/openvswitch-db-server.json.j2 当执行 deploy 操做的时候 openvswitch-db-server.json.j2 会被解析成 openvswitch-db-server.json 并复制到 /etc/kolla/的对应位置，所以只需要修改 openvswitch-db-server.json.j2 即可。</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/usr/</span>share<span class="regexp">/kolla/</span>ansible<span class="regexp">/roles/</span>neutron<span class="regexp">/templates/</span>openvswitch-db-server.json.j2</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;command&quot;</span>: <span class="string">&quot;/usr/sbin/ovsdb-server /etc/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/run/openvswitch/db.sock --log-file=/var/log/openvswitch/ovsdb-server.log&quot;</span>,</span><br><span class="line">    <span class="string">&quot;config_files&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># <span class="regexp">/root/</span>kolla<span class="regexp">/tools/</span>cleanup-containers</span><br><span class="line"># <span class="regexp">/root/</span>kolla<span class="regexp">/tools/</span>cleanup-host</span><br><span class="line"># kolla-ansible deploy</span><br></pre></td></tr></table></figure><h1 id="问题二-kolla-toolbox-镜像中-ansible-版本不符"><a href="#问题二-kolla-toolbox-镜像中-ansible-版本不符" class="headerlink" title="问题二: kolla_toolbox 镜像中 ansible 版本不符"></a>问题二: kolla_toolbox 镜像中 ansible 版本不符</h1><h2 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h2><p>解决问题一后运行 deploy 到最后依旧会报错</p><figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line">TASK: [horizon | Creating the _member_ <span class="keyword">role</span>] ********************************** </span><br><span class="line">failed: [localhost] =&gt; &#123;&quot;attempts&quot;: <span class="number">10</span>, &quot;changed&quot;: <span class="keyword">false</span>, &quot;cmd&quot;: [&quot;docker&quot;, &quot;exec&quot;, &quot;-t&quot;, &quot;kolla_toolbox&quot;, &quot;/usr/bin/ansible&quot;, &quot;localhost&quot;, &quot;-m&quot;, &quot;os_keystone_role&quot;, &quot;-a&quot;, &quot;name=_member_ auth=&#123;# openstack_horizon_auth #&#125;&quot;, &quot;-e&quot;, &quot;&#123;&#x27;openstack_horizon_auth&#x27;:&#123;&#x27;username&#x27;: &#x27;admin&#x27;, &#x27;project_name&#x27;: &#x27;admin&#x27;, &#x27;password&#x27;: &#x27;admin&#x27;, &#x27;auth_url&#x27;: &#x27;http://172.16.15.115:35357&#x27;&#125;&#125;&quot;], &quot;delta&quot;: &quot;0:00:01.223878&quot;, &quot;end&quot;: &quot;2018-07-09 09:18:24.813123&quot;, &quot;failed&quot;: <span class="keyword">true</span>, &quot;rc&quot;: <span class="number">2</span>, &quot;start&quot;: &quot;2018-07-09 09:18:23.589245&quot;, &quot;stdout_lines&quot;: [&quot;localhost | FAILED! =&gt; &#123;&quot;, &quot;    \&quot;failed\&quot;: true, &quot;, &quot;    \&quot;msg\&quot;: \&quot;The module os_keystone_role was <span class="keyword">not</span> <span class="built_in">found</span> <span class="keyword">in</span> configured module paths. Additionally, core modules are missing. <span class="keyword">If</span> this <span class="keyword">is</span> a checkout, run <span class="string">&#x27;git submodule update --init --recursive&#x27;</span> <span class="keyword">to</span> correct this problem.\&quot;&quot;, &quot;&#125;&quot;], &quot;warnings&quot;: []&#125;</span><br><span class="line">stdout: localhost | FAILED! =&gt; &#123;</span><br><span class="line">    &quot;failed&quot;: <span class="keyword">true</span>, </span><br><span class="line">    &quot;msg&quot;: &quot;The module os_keystone_role was not found in configured module paths. Additionally, core modules are missing. If this is a checkout, run &#x27;git submodule update --init --recursive&#x27; to correct this problem.&quot;</span><br><span class="line">&#125;</span><br><span class="line">msg: Task failed <span class="keyword">as</span> maximum retries was encountered</span><br><span class="line"></span><br><span class="line">FATAL: <span class="keyword">all</span> hosts have already failed <span class="comment">-- aborting</span></span><br></pre></td></tr></table></figure><p>执行 git submodule update –init –recursive 后报此错误</p><h2 id="排查错误"><a href="#排查错误" class="headerlink" title="排查错误"></a>排查错误</h2><p>经查询这是一个 bug ,详情见: <a href="https://bugs.launchpad.net/kolla/+bug/1688167">Hitting ansible error “The module os_keystone_role was not found in configured module paths” </a></p><h3 id="1-查看-ansible-版本"><a href="#1-查看-ansible-版本" class="headerlink" title="1. 查看 ansible 版本"></a>1. 查看 ansible 版本</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># docker exec -ti kolla_toolbox <span class="regexp">/usr/</span>bin/ansible --version</span><br><span class="line"></span><br><span class="line">ansible <span class="number">2.1</span>.<span class="number">0</span></span><br><span class="line">  config <span class="keyword">file</span> = <span class="regexp">/home/</span>ansible/.ansible.cfg</span><br><span class="line">  configured module search path = <span class="regexp">/usr/</span>share/ansible</span><br></pre></td></tr></table></figure><h3 id="2-更新-ansible"><a href="#2-更新-ansible" class="headerlink" title="2. 更新 ansible"></a>2. 更新 ansible</h3><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker exec -ti kolla_toolbox sudo pip install ansible==2.1.1.0</span></span><br><span class="line"></span><br><span class="line">We trust you have received <span class="keyword">the</span> usual lecture <span class="keyword">from</span> <span class="keyword">the</span> <span class="keyword">local</span> System</span><br><span class="line">Administrator. It usually boils down <span class="keyword">to</span> these three things:</span><br><span class="line"></span><br><span class="line">    <span class="comment">#1) Respect the privacy of others.</span></span><br><span class="line">    <span class="comment">#2) Think before you type.</span></span><br><span class="line">    <span class="comment">#3) With great power comes great responsibility.</span></span><br><span class="line"></span><br><span class="line">[sudo] password <span class="keyword">for</span> ansible: </span><br></pre></td></tr></table></figure><p>需要 root 权限，容器是以 ansible 用户运行，并且没有密码，无法更新。执行尝试手动 build kolla_toolbox 镜像</p><h3 id="3-使用-kolla-toolbox-的-Dockerfile-文件手动-build-镜像"><a href="#3-使用-kolla-toolbox-的-Dockerfile-文件手动-build-镜像" class="headerlink" title="3. 使用 kolla_toolbox 的 Dockerfile 文件手动 build 镜像"></a>3. 使用 kolla_toolbox 的 Dockerfile 文件手动 build 镜像</h3><p>build 镜像的时候由于各种预制的源已经不存在或者无法访问，因此决定不使用官方pull的镜像，而采用手动更改源的地址，重新build所有镜像，所以也能解决问题二。</p><h1 id="问题三-重新build-kolla镜像"><a href="#问题三-重新build-kolla镜像" class="headerlink" title="问题三: 重新build kolla镜像"></a>问题三: 重新build kolla镜像</h1><h2 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h2><p>需要重新 build openstack mitaka的镜像，但是由于时间问题，镜像内部很多源的地址已经失效，手动替换源为可用的地址，重新build</p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="1-修改kolla使用的源的地址"><a href="#1-修改kolla使用的源的地址" class="headerlink" title="1. 修改kolla使用的源的地址"></a>1. 修改kolla使用的源的地址</h3><p>以下文件会被 COPY 到容器内，可以直接修改</p><ul><li>kibana.yum.repo<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">修改为最新的6.x版本，4.x版本无法访问</span><br><span class="line">vi /usr/share/kolla/docker/base/kibana.yum.repo</span><br><span class="line"></span><br><span class="line"><span class="deletion">-[kibana-4.4]</span></span><br><span class="line"><span class="deletion">-name=Kibana repository for 4.4.x packages</span></span><br><span class="line"><span class="deletion">-baseurl=http://packages.elastic.co/kibana/4.4/centos</span></span><br><span class="line"><span class="deletion">-gpgcheck=1</span></span><br><span class="line"><span class="deletion">-gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</span></span><br><span class="line"><span class="deletion">-enabled=1</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+[kibana-6.x]</span></span><br><span class="line"><span class="addition">+name=Kibana repository for 6.x packages</span></span><br><span class="line"><span class="addition">+baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></span><br><span class="line"><span class="addition">+gpgcheck=0</span></span><br><span class="line"><span class="addition">+enabled=1</span></span><br></pre></td></tr></table></figure></li><li>elasticsearch.repo<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line">为了和kibana的兼容性，修改elasticsearch源为6.x版本</span><br><span class="line"></span><br><span class="line"># vi /usr/share/kolla/docker/base/elasticsearch.repo</span><br><span class="line"></span><br><span class="line"><span class="deletion">-[elasticsearch-2.x]</span></span><br><span class="line"><span class="deletion">-name=Elasticsearch repository for 2.x packages</span></span><br><span class="line"><span class="deletion">-baseurl=http://packages.elastic.co/elasticsearch/2.x/centos</span></span><br><span class="line"><span class="deletion">-gpgcheck=1</span></span><br><span class="line"><span class="deletion">-gpgkey=http://packages.elastic.co/GPG-KEY-elasticsearch</span></span><br><span class="line"><span class="deletion">-enabled=1</span></span><br><span class="line"></span><br><span class="line"><span class="addition">+[elasticsearch-6.x]</span></span><br><span class="line"><span class="addition">+name=Elasticsearch repository for 6.x packages</span></span><br><span class="line"><span class="addition">+baseurl=https://artifacts.elastic.co/packages/6.x/yum</span></span><br><span class="line"><span class="addition">+gpgcheck=0</span></span><br><span class="line"><span class="addition">+enabled=1   #elasticsearch的源在 AWS 上，国内访问不太稳定</span></span><br></pre></td></tr></table></figure><h3 id="2-修改-ceph、openstack、QEMU-EV-源地址"><a href="#2-修改-ceph、openstack、QEMU-EV-源地址" class="headerlink" title="2. 修改 ceph、openstack、QEMU-EV 源地址"></a>2. 修改 ceph、openstack、QEMU-EV 源地址</h3>因为 ceph 、openstack 和 QEMU-EV 的源是在安装了centos-release-ceph-hammer 、centos-release-openstack-mitaka 和 centos-release-qemu-ev 自动生成的因此需要修改对应的 Dockerfile文件，加入修改源地址的操作。<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/docker/base/Dockerfile.j2</span><br><span class="line"></span><br><span class="line">RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 \</span><br><span class="line">    &amp;&amp; yum install -y \</span><br><span class="line">         epel-release \</span><br><span class="line"><span class="deletion">-        centos-release-openstack-mitaka \   #extra源里面已经没有centos-release-openstack-mitaka这个包，手动安装</span></span><br><span class="line"><span class="addition">+        http://mirror.neu.edu.cn/centos/7/cloud/x86_64/openstack-mitaka/centos-release-openstack-mitaka-1-5.el7.noarch.rpm \</span></span><br><span class="line">         yum-plugin-priorities \</span><br><span class="line">         centos-release-ceph-hammer \</span><br><span class="line">         centos-release-qemu-ev \</span><br><span class="line"><span class="addition">+   &amp;&amp; sed -i s/mirror.centos.org/mirror.neu.edu.cn/g /etc/yum.repos.d/CentOS-Ceph-Hammer.repo \</span></span><br><span class="line"><span class="addition">+   &amp;&amp; sed -i s/mirror.centos.org/mirror.neu.edu.cn/g /etc/yum.repos.d/CentOS-OpenStack-mitaka.repo \</span></span><br><span class="line"><span class="addition">+   &amp;&amp; sed -i s#mirror.centos.org/\$contentdir/#mirror.neu.edu.cn/centos/#g /etc/yum.repos.d/CentOS-QEMU-EV.repo \</span></span><br><span class="line"><span class="addition">+   &amp;&amp; rm -rf /etc/yum.repos.d/CentOS-Base.repo &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span></span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 \</span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Storage \</span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Virtualization \</span><br><span class="line">    &amp;&amp; yum clean all</span><br></pre></td></tr></table></figure><h3 id="3-使用阿里云和豆瓣的源进行加速"><a href="#3-使用阿里云和豆瓣的源进行加速" class="headerlink" title="3. 使用阿里云和豆瓣的源进行加速"></a>3. 使用阿里云和豆瓣的源进行加速</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/docker/base/Dockerfile.j2</span><br><span class="line"></span><br><span class="line">RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7 \</span><br><span class="line">    &amp;&amp; yum install -y \</span><br><span class="line">         epel-release \</span><br><span class="line">         http://mirror.neu.edu.cn/centos/7/cloud/x86_64/openstack-mitaka/centos-release-openstack-mitaka-1-5.el7.noarch.rpm \</span><br><span class="line">         yum-plugin-priorities \</span><br><span class="line">         centos-release-ceph-hammer \</span><br><span class="line">         centos-release-qemu-ev \</span><br><span class="line">    &amp;&amp; sed -i s/mirror.centos.org/mirror.neu.edu.cn/g /etc/yum.repos.d/CentOS-Ceph-Hammer.repo \</span><br><span class="line">    &amp;&amp; sed -i s/mirror.centos.org/mirror.neu.edu.cn/g /etc/yum.repos.d/CentOS-OpenStack-mitaka.repo \</span><br><span class="line">    &amp;&amp; sed -i s#mirror.centos.org/\$contentdir/#mirror.neu.edu.cn/centos/#g /etc/yum.repos.d/CentOS-QEMU-EV.repo \</span><br><span class="line"><span class="addition">+   &amp;&amp; rm -rf /etc/yum.repos.d/CentOS-Base.repo &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \</span></span><br><span class="line"><span class="addition">+   &amp;&amp; rm -rf /etc/yum.repos.d/epel.* &amp;&amp; curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo \</span></span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 \</span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Storage \</span><br><span class="line">    &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Virtualization \</span><br><span class="line">    &amp;&amp; yum clean all</span><br><span class="line">    </span><br><span class="line"><span class="addition">+#use douban source</span></span><br><span class="line"><span class="addition">+RUN mkdir ~/.pip \</span></span><br><span class="line"><span class="addition">+     &amp;&amp; &gt; ~/.pip/pip.conf \</span></span><br><span class="line"><span class="addition">+     &amp;&amp; echo &quot;[global]&quot; &gt; ~/.pip/pip.conf \</span></span><br><span class="line"><span class="addition">+     &amp;&amp; echo &quot;index-url = http://pypi.douban.com/simple&quot; &gt;&gt; ~/.pip/pip.conf \</span></span><br><span class="line"><span class="addition">+     &amp;&amp; echo &quot;[install]&quot; &gt;&gt; ~/.pip/pip.conf \</span></span><br><span class="line"><span class="addition">+     &amp;&amp; echo &quot;trusted-host = pypi.douban.com&quot; &gt;&gt; ~/.pip/pip.conf</span></span><br></pre></td></tr></table></figure><h3 id="4-修改-kolla-toolbox"><a href="#4-修改-kolla-toolbox" class="headerlink" title="4. 修改 kolla_toolbox"></a>4. 修改 kolla_toolbox</h3>测试发现编译 kolla_toolbox 镜像的时候使用 pip 安装python包的时候安装了最新的openstack client版本，需要安装 requests&gt;=2.14.2 ,由于依赖会升级 chardet, 而chardet 是系统依赖，在容器中无法升级。所以手动指定openstack client的版本，版本来源 <a href="https://releases.openstack.org/mitaka/index.html">OpenStack Projects Release Notes </a><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/docker/kolla_toolbox/Dockerfile.j2</span><br><span class="line"></span><br><span class="line">RUN curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py \</span><br><span class="line">    &amp;&amp; python get-pip.py \</span><br><span class="line">    &amp;&amp; rm get-pip.py \</span><br><span class="line">    &amp;&amp; pip --no-cache-dir install \</span><br><span class="line"><span class="addition">+       openstacksdk==0.9.0 \</span></span><br><span class="line"><span class="addition">+       osc-lib==0.4.0 \</span></span><br><span class="line"><span class="addition">+       oslo.config==3.13.0 \</span></span><br><span class="line"><span class="addition">+       oslo.i18n==3.8.0 \</span></span><br><span class="line"><span class="addition">+       oslo.serialization==2.11.0 \</span></span><br><span class="line"><span class="addition">+       oslo.utils==3.16.0 \</span></span><br><span class="line"><span class="addition">+       python-cinderclient==1.8.0 \</span></span><br><span class="line"><span class="addition">+       python-glanceclient==2.2.0 \</span></span><br><span class="line"><span class="addition">+       python-heatclient==1.3.0 \</span></span><br><span class="line"><span class="addition">+       python-ironicclient==1.5.0 \</span></span><br><span class="line"><span class="addition">+       python-keystoneclient==3.2.0 \</span></span><br><span class="line"><span class="addition">+       python-neutronclient==4.2.0 \</span></span><br><span class="line"><span class="addition">+       python-novaclient==5.0.0 \</span></span><br><span class="line"><span class="addition">+       python-openstackclient==2.6.0 \</span></span><br><span class="line"><span class="addition">+       python-swiftclient==3.0.0 \</span></span><br><span class="line"><span class="addition">+       python-troveclient==2.3.0 \</span></span><br><span class="line"><span class="addition">+       stevedore==1.16.0 \</span></span><br><span class="line"><span class="addition">+       debtcollector==1.6.0 \</span></span><br><span class="line"><span class="addition">+       keystoneauth1==2.9.0 \</span></span><br><span class="line"><span class="addition">+       cliff==2.1.0 \</span></span><br><span class="line"><span class="addition">+       cmd2==0.6.8 \</span></span><br><span class="line"><span class="addition">+       pbr==1.10.0 \</span></span><br><span class="line"><span class="addition">+       requests==2.10.0 \</span></span><br><span class="line">        ansible==2.1.1.0 \</span><br><span class="line">        MySQL-python \</span><br><span class="line">        os-client-config==1.16.0 \</span><br><span class="line">        pyudev \</span><br><span class="line">        shade==1.4.0</span><br></pre></td></tr></table></figure></li></ul><h3 id="5-手动-build-镜像"><a href="#5-手动-build-镜像" class="headerlink" title="5. 手动 build 镜像"></a>5. 手动 build 镜像</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># 只build基本的镜像</span></span><br><span class="line"><span class="meta"># kolla-build --base centos -t binary horizon cinder heat nova neutron glance keystone ironic rabbitmq keepalived haproxy heka kolla_toolbox mariadb memcached cron openvswitch</span></span><br></pre></td></tr></table></figure><h3 id="6-查看编译后的镜像"><a href="#6-查看编译后的镜像" class="headerlink" title="6. 查看编译后的镜像"></a>6. 查看编译后的镜像</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker images</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">REPOSITORY</span>                                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-db-server       <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">58</span>e<span class="number">8</span>a<span class="number">1</span>cdc<span class="number">387</span>        <span class="number">10</span> minutes ago       <span class="number">379</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-vswitchd        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               cb<span class="number">85</span>d<span class="number">198</span>f<span class="number">02</span>c        <span class="number">10</span> minutes ago       <span class="number">379</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-base            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">0</span>baee<span class="number">06</span>b<span class="number">57</span>a<span class="number">4</span>        <span class="number">10</span> minutes ago       <span class="number">379</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-kolla-toolbox               <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">3</span>f<span class="number">9</span>e<span class="number">86</span>e<span class="number">1292</span>        <span class="number">43</span> minutes ago      <span class="number">631</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-base                        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">4481</span>fe<span class="number">643</span>afa        About an hour ago   <span class="number">344</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-base            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">09</span>ab<span class="number">40</span>d<span class="number">1</span>a<span class="number">684</span>        <span class="number">6</span> hours ago         <span class="number">380</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-ironic-inspector            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">0</span>a<span class="number">692</span>e<span class="number">9</span>b<span class="number">679</span>e        <span class="number">10</span> hours ago        <span class="number">641</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-ironic-api                  <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">087</span>a<span class="number">20</span>a<span class="number">24</span>a<span class="number">84</span>        <span class="number">10</span> hours ago        <span class="number">635</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-ironic-conductor            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">35450</span>cd<span class="number">6</span>b<span class="number">73</span>b        <span class="number">10</span> hours ago        <span class="number">662</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-compute-ironic         <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">0</span>a<span class="number">5</span>a<span class="number">0</span>a<span class="number">85</span>ab<span class="number">7</span>        <span class="number">10</span> hours ago        <span class="number">1</span>.<span class="number">07</span> GB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-ironic-pxe                  <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">505622</span>b<span class="number">6982</span>        <span class="number">10</span> hours ago        <span class="number">639</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-elasticsearch               <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">63064</span>a<span class="number">9</span>d<span class="number">79</span>d<span class="number">1</span>        <span class="number">10</span> hours ago        <span class="number">692</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-kibana                      <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">52426</span>e<span class="number">4</span>d<span class="number">06</span>f        <span class="number">10</span> hours ago        <span class="number">874</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-ironic-base                 <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">09</span>a<span class="number">4902</span>a<span class="number">06</span>be        <span class="number">10</span> hours ago        <span class="number">612</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-libvirt                <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">81</span>f<span class="number">523</span>f<span class="number">3</span>d<span class="number">656</span>        <span class="number">11</span> hours ago        <span class="number">1</span>.<span class="number">11</span> GB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-compute                <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">5</span>b<span class="number">70975</span>fe<span class="number">56</span>d        <span class="number">11</span> hours ago        <span class="number">1</span>.<span class="number">11</span> GB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-volume               <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               acc<span class="number">66141</span>a<span class="number">640</span>        <span class="number">11</span> hours ago        <span class="number">859</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-api                  <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">5</span>ff<span class="number">44</span>bfe<span class="number">4063</span>        <span class="number">11</span> hours ago        <span class="number">850</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-rpcbind              <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">241518</span>b<span class="number">407</span>c        <span class="number">11</span> hours ago        <span class="number">838</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-backup               <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">70</span>e<span class="number">279</span>b<span class="number">6</span>adc<span class="number">7</span>        <span class="number">11</span> hours ago        <span class="number">808</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-scheduler            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">4</span>c<span class="number">8</span>e<span class="number">5140</span>be<span class="number">4</span>        <span class="number">11</span> hours ago        <span class="number">808</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-glance-api                  <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">92</span>ed<span class="number">32</span>bb<span class="number">6344</span>        <span class="number">11</span> hours ago        <span class="number">732</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-conductor              <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               c<span class="number">7</span>f<span class="number">752689</span>dfc        <span class="number">11</span> hours ago        <span class="number">671</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-consoleauth            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">5</span>bb<span class="number">4</span>f<span class="number">725</span>b<span class="number">42</span>d        <span class="number">11</span> hours ago        <span class="number">671</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-scheduler              <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">00</span>ddedda<span class="number">23</span>c<span class="number">4</span>        <span class="number">11</span> hours ago        <span class="number">671</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-glance-registry             <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               e<span class="number">59</span>b<span class="number">0948281</span>e        <span class="number">11</span> hours ago        <span class="number">732</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-ssh                    <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">01</span>c<span class="number">404</span>afdc<span class="number">8</span>b        <span class="number">11</span> hours ago        <span class="number">672</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-api                    <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">29</span>b<span class="number">3451</span>c<span class="number">045</span>        <span class="number">11</span> hours ago        <span class="number">671</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-network                <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               a<span class="number">5</span>cead<span class="number">8</span>aee<span class="number">0</span>b        <span class="number">11</span> hours ago        <span class="number">672</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-openvswitch-agent   <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">36226</span>e<span class="number">14</span>b<span class="number">4</span>d<span class="number">7</span>        <span class="number">11</span> hours ago        <span class="number">670</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-linuxbridge-agent   <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               e<span class="number">9</span>ad<span class="number">4</span>cb<span class="number">7</span>c<span class="number">6</span>cc        <span class="number">11</span> hours ago        <span class="number">670</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-novncproxy             <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">3689</span>a<span class="number">51</span>a<span class="number">5</span>db<span class="number">8</span>        <span class="number">11</span> hours ago        <span class="number">672</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-spicehtml<span class="number">5</span>proxy        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">55</span>fc<span class="number">9</span>d<span class="number">8</span>a<span class="number">62</span>b<span class="number">5</span>        <span class="number">11</span> hours ago        <span class="number">672</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-metadata-agent      <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">45</span>f<span class="number">0</span>f<span class="number">090</span>cf<span class="number">38</span>        <span class="number">11</span> hours ago        <span class="number">646</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cinder-base                 <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               dd<span class="number">0</span>c<span class="number">5</span>b<span class="number">78</span>af<span class="number">7</span>b        <span class="number">11</span> hours ago        <span class="number">808</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-server              <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">171</span>b<span class="number">7</span>bab<span class="number">73</span>ab        <span class="number">11</span> hours ago        <span class="number">646</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-heat-api                    <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               f<span class="number">334</span>caf<span class="number">10</span>d<span class="number">5</span>a        <span class="number">11</span> hours ago        <span class="number">633</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-horizon                     <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">88</span>ceecbc<span class="number">8</span>cf<span class="number">8</span>        <span class="number">11</span> hours ago        <span class="number">763</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-heat-engine                 <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               a<span class="number">53651463235</span>        <span class="number">11</span> hours ago        <span class="number">633</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-heat-api-cfn                <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">7</span>ec<span class="number">6</span>cdd<span class="number">4</span>b<span class="number">04</span>b        <span class="number">11</span> hours ago        <span class="number">633</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-l<span class="number">3</span>-agent            <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">4744</span>d<span class="number">180</span>b<span class="number">09</span>        <span class="number">11</span> hours ago        <span class="number">646</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-dhcp-agent          <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               d<span class="number">4744</span>d<span class="number">180</span>b<span class="number">09</span>        <span class="number">11</span> hours ago        <span class="number">646</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-glance-base                 <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               f<span class="number">78</span>fa<span class="number">9</span>de<span class="number">5</span>c<span class="number">7</span>b        <span class="number">11</span> hours ago        <span class="number">732</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-nova-base                   <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               aa<span class="number">7</span>ae<span class="number">5</span>ae<span class="number">4818</span>        <span class="number">11</span> hours ago        <span class="number">648</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-neutron-base                <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               ed<span class="number">5</span>f<span class="number">4</span>f<span class="number">60</span>a<span class="number">6</span>f<span class="number">4</span>        <span class="number">11</span> hours ago        <span class="number">646</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-heat-base                   <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">4798734</span>eb<span class="number">0</span>d<span class="number">4</span>        <span class="number">11</span> hours ago        <span class="number">610</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-keystone                    <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">55</span>cf<span class="number">2686</span>b<span class="number">33</span>a        <span class="number">11</span> hours ago        <span class="number">644</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openstack-base              <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">9</span>d<span class="number">511</span>be<span class="number">689</span>b<span class="number">7</span>        <span class="number">22</span> hours ago        <span class="number">572</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-mariadb                     <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               cb<span class="number">4</span>c<span class="number">65</span>a<span class="number">6</span>a<span class="number">637</span>        <span class="number">22</span> hours ago        <span class="number">682</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-vswitchd        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">0179076733</span>aa        <span class="number">22</span> hours ago        <span class="number">380</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-openvswitch-db-server       <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               a<span class="number">9</span>e<span class="number">0</span>e<span class="number">1</span>bd<span class="number">0968</span>        <span class="number">22</span> hours ago        <span class="number">380</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-rabbitmq                    <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               cbaeb<span class="number">0</span>b<span class="number">64930</span>        <span class="number">22</span> hours ago        <span class="number">438</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-memcached                   <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">11</span>aa<span class="number">506130</span>a<span class="number">6</span>        <span class="number">22</span> hours ago        <span class="number">403</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-heka                        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">89</span>c<span class="number">723045</span>d<span class="number">40</span>        <span class="number">22</span> hours ago        <span class="number">420</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-cron                        <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">4</span>b<span class="number">0</span>b<span class="number">36</span>b<span class="number">058</span>a<span class="number">1</span>        <span class="number">22</span> hours ago        <span class="number">366</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-keepalived                  <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">7</span>fbc<span class="number">06505</span>ddb        <span class="number">23</span> hours ago        <span class="number">411</span> MB</span><br><span class="line"><span class="attribute">kolla</span>/centos-binary-haproxy                     <span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>               <span class="number">7</span>f<span class="number">65</span>eba<span class="number">43909</span>        <span class="number">23</span> hours ago        <span class="number">367</span> MB</span><br><span class="line"><span class="attribute">centos</span>                                          latest              <span class="number">49</span>f<span class="number">7960</span>eb<span class="number">7</span>e<span class="number">4</span>        <span class="number">5</span> weeks ago         <span class="number">200</span> MB</span><br></pre></td></tr></table></figure><h1 id="问题四-openvswitch-db-容器无法启动"><a href="#问题四-openvswitch-db-容器无法启动" class="headerlink" title="问题四: openvswitch_db 容器无法启动"></a>问题四: openvswitch_db 容器无法启动</h1><h2 id="问题描述-3"><a href="#问题描述-3" class="headerlink" title="问题描述"></a>问题描述</h2><p>重新编译了镜像，可是 deploy 的时候又出现了以下错误</p><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">TASK: [neutron | Waiting the openvswitch_db service <span class="keyword">to</span> be ready] ************** </span><br><span class="line">failed: [localhost] =&gt; &#123;<span class="string">&quot;attempts&quot;</span>: <span class="number">30</span>, <span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;cmd&quot;</span>: [<span class="string">&quot;docker&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;openvswitch_db&quot;</span>, <span class="string">&quot;ovs-vsctl&quot;</span>, <span class="string">&quot;--no-wait&quot;</span>, <span class="string">&quot;show&quot;</span>], <span class="string">&quot;delta&quot;</span>: <span class="string">&quot;0:00:00.057827&quot;</span>, <span class="string">&quot;end&quot;</span>: <span class="string">&quot;2018-07-12 08:04:09.663118&quot;</span>, <span class="string">&quot;failed&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;rc&quot;</span>: <span class="number">1</span>, <span class="string">&quot;start&quot;</span>: <span class="string">&quot;2018-07-12 08:04:09.605291&quot;</span>, <span class="string">&quot;stdout_lines&quot;</span>: [], <span class="string">&quot;warnings&quot;</span>: []&#125;</span><br><span class="line">stderr: <span class="built_in">Error</span> response <span class="keyword">from</span> daemon: Container <span class="number">03426314b</span>560db08c762a8f9aebdb4423571a29ba1c22862e3415ac913289c21 <span class="keyword">is</span> restarting, wait <span class="keyword">until</span> the container <span class="keyword">is</span> running</span><br><span class="line">msg: Task failed <span class="keyword">as</span> maximum retries was encountered</span><br><span class="line"></span><br><span class="line">FATAL: all hosts have already failed -- aborting</span><br></pre></td></tr></table></figure><p>和问题一的报错一致，查看容器日志</p><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">INFO:__main__:Kolla config strategy <span class="keyword">set</span> to: COPY_ALWAYS</span><br><span class="line">INFO:__main__:Loading config <span class="keyword">file</span> at /<span class="keyword">var</span>/lib/kolla/config_files/config.json</span><br><span class="line">INFO:__main__:Validating config <span class="keyword">file</span></span><br><span class="line">INFO:__main__:Copying service configuration files</span><br><span class="line">INFO:__main__:Writing <span class="keyword">out</span> command to execute</span><br><span class="line">Running command: &#x27;/usr/sbin/ovsdb-server /etc/openvswitch/<span class="keyword">conf</span>.<span class="keyword">db</span> -vconsole:emer -vsyslog:<span class="keyword">err</span> -vfile:info --remote=punix:/<span class="keyword">run</span>/openvswitch/<span class="keyword">db</span>.sock --<span class="keyword">log</span>-<span class="keyword">file</span>=/<span class="keyword">var</span>/<span class="keyword">log</span>/openvswitch/ovsdb-server.<span class="keyword">log</span>&#x27;</span><br><span class="line">ovsdb-server: I/O <span class="keyword">error</span>: <span class="keyword">open</span>: /etc/openvswitch/<span class="keyword">conf</span>.<span class="keyword">db</span> failed (<span class="keyword">No</span> such <span class="keyword">file</span> or directory)</span><br></pre></td></tr></table></figure><h2 id="排查问题-1"><a href="#排查问题-1" class="headerlink" title="排查问题"></a>排查问题</h2><p>之前使用的镜像是直接从dockerhub pull的官方的镜像，tag 是 2.0.2，而我使用的 kolla 的版本是 2.0.4。对比了下 2.0.2 和 2.0.4 的openvswitch_db 部分的代码，问题就很明了了。</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">tag:<span class="number">2.0</span>.<span class="number">2</span></span><br><span class="line"></span><br><span class="line">kolla<span class="regexp">/docker/</span>openvswitch<span class="regexp">/openvswitch-db-server/</span>extend_start.sh</span><br><span class="line"></span><br><span class="line">#!<span class="regexp">/bin/</span>bash</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">&quot;/run/openvswitch&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ ! -e <span class="string">&quot;/etc/openvswitch/conf.db&quot;</span> ]]; then</span><br><span class="line">    ovsdb-tool create <span class="string">&quot;/etc/openvswitch/conf.db&quot;</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">tag:mitaka-eol</span><br><span class="line"></span><br><span class="line">kolla/docker/openvswitch/openvswitch-db-server/extend_start.sh</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">&quot;/run/openvswitch&quot;</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">[[ ! -e &quot;/var/lib/openvswitch/conf.db&quot; ]]</span>; <span class="keyword">then</span></span><br><span class="line">    ovsdb-tool <span class="built_in">create</span> <span class="string">&quot;/var/lib/openvswitch/conf.db&quot;</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>2.0.2的镜像会创建 /etc/openvswitch/conf.db 这个文件，而使用2.0.4的版本启动命令是 </p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;/usr/sbin/ovsdb-server /var/lib/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/run/openvswitch/db.sock --log-file=/var/log/openvswitch/ovsdb-server.log&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config_files&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所有会导致问题一的出现，而我重新 build 了镜像，也就是说现在容器启动的时候创建的是 /var/lib/openvswitch/conf.db 。而我修改了启动命令，所以会找不到 /etc/openvswitch/conf.db 文件。解决办法是还原问题一所作的修改:</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/usr/</span>share<span class="regexp">/kolla/</span>ansible<span class="regexp">/roles/</span>neutron<span class="regexp">/templates/</span>openvswitch-db-server.json.j2</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;command&quot;</span>: <span class="string">&quot;/usr/sbin/ovsdb-server /var/lib/openvswitch/conf.db -vconsole:emer -vsyslog:err -vfile:info --remote=punix:/run/openvswitch/db.sock --log-file=/var/log/openvswitch/ovsdb-server.log&quot;</span>,</span><br><span class="line">    <span class="string">&quot;config_files&quot;</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="验证操作"><a href="#验证操作" class="headerlink" title="验证操作"></a>验证操作</h2><p>重新deploy后成功部署</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># kolla-ansible deploy</span></span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">TASK: [manila | Creating Manila database] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="emphasis">* </span></span><br><span class="line"><span class="emphasis">skipping: [localhost]</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">TASK: [manila | Reading json from variable] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">* </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">skipping: [localhost]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK: [manila | Creating Manila database user and setting permissions] <span class="strong">****</span><span class="strong">****</span> </span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">skipping: [localhost]</span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis">TASK: [manila | Running Manila bootstrap container] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">**<span class="emphasis">* </span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">skipping: [localhost]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK: [manila | Starting manila-api container] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span> </span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">skipping: [localhost]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">TASK: [manila | Starting manila-scheduler container] <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">** </span></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">skipping: [localhost]</span></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"></span></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong">TASK: [manila | Starting manila-share container] **</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span> </span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">skipping: [localhost]</span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis"></span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">PLAY RECAP <span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span><span class="strong">****</span> </span></span></span></span></span></span><br><span class="line"><span class="emphasis"><span class="strong"><span class="emphasis"><span class="strong"><span class="emphasis">localhost                  : ok=311  changed=123  unreachable=0    failed=0   </span></span></span></span></span></span><br></pre></td></tr></table></figure><h1 id="问题五-nova-compute-和-nova-libvirt-容器启动失败"><a href="#问题五-nova-compute-和-nova-libvirt-容器启动失败" class="headerlink" title="问题五: nova_compute 和 nova_libvirt 容器启动失败"></a>问题五: nova_compute 和 nova_libvirt 容器启动失败</h1><h2 id="问题描述-4"><a href="#问题描述-4" class="headerlink" title="问题描述"></a>问题描述</h2><p>接问题四，虽然部署成功了，但是查看容器状态，nova 的两个容器总是在启动中</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker ps</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">648c226f0980</span>        kolla/centos-binary-nova-compute:<span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>                <span class="string">&quot;kolla_start&quot;</span>            <span class="number">3</span> days ago          Restarting (<span class="number">0</span>) <span class="number">21</span> hours ago                       nova_compute</span><br><span class="line"><span class="attribute">c492de413c81</span>        kolla/centos-binary-nova-libvirt:<span class="number">2</span>.<span class="number">0</span>.<span class="number">4</span>                <span class="string">&quot;kolla_start&quot;</span>            <span class="number">3</span> days ago          Restarting (<span class="number">6</span>) <span class="number">21</span> hours ago                       nova_libvirt</span><br></pre></td></tr></table></figure><p>查看对应容器的日志<br>nova_compute 容器</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># docker logs <span class="number">648</span>c226f0980</span><br><span class="line">INFO:__main__:Kolla config strategy set to: COPY_ALWAYS</span><br><span class="line">INFO:__main__:Loading config <span class="keyword">file</span> at <span class="regexp">/var/</span>lib<span class="regexp">/kolla/</span>config_files/config.json</span><br><span class="line">INFO:__main__:Validating config <span class="keyword">file</span></span><br><span class="line">INFO:__main__:Copying service configuration files</span><br><span class="line">INFO:__main__:Removing existing destination: <span class="regexp">/etc/</span>nova/nova.conf</span><br><span class="line">INFO:__main__:Copying <span class="regexp">/var/</span>lib<span class="regexp">/kolla/</span>config_files<span class="regexp">/nova.conf to /</span>etc<span class="regexp">/nova/</span>nova.conf</span><br><span class="line">INFO:__main__:Setting permissions <span class="keyword">for</span> <span class="regexp">/etc/</span>nova/nova.conf</span><br><span class="line">INFO:__main__:Writing out command to execute</span><br><span class="line">Running command: <span class="string">&#x27;nova-compute&#x27;</span></span><br><span class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/pkg_resources/</span>__init__.py:<span class="number">187</span>: RuntimeWarning: You have iterated over the result of pkg_resources.parse_version. <span class="keyword">This</span> is a legacy behavior which is inconsistent with the <span class="keyword">new</span> version <span class="keyword">class</span> introduced in setuptools <span class="number">8.0</span>. In most cases, conversion to a tuple is unnecessary. <span class="keyword">For</span> comparison of versions, <span class="keyword">sort</span> the Version instances directly. <span class="keyword">If</span> you have another use <span class="keyword">case</span> requiring the tuple, please <span class="keyword">file</span> a bug with the setuptools <span class="keyword">project</span> describing that need.</span><br><span class="line">  stacklevel=<span class="number">1</span>,</span><br><span class="line">Traceback (most recent <span class="keyword">call</span> last):</span><br><span class="line">  <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/queue.py&quot;</span>, line <span class="number">118</span>, in <span class="keyword">switch</span></span><br><span class="line">    self.greenlet.<span class="keyword">switch</span>(value)</span><br><span class="line">  <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/eventlet/greenthread.py&quot;</span>, line <span class="number">214</span>, in main</span><br><span class="line">    result = function(*args, **kwargs)</span><br><span class="line">  <span class="keyword">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/oslo_service/service.py&quot;</span>, line <span class="number">683</span>, in run_service</span><br><span class="line">    raise SystemExit(<span class="number">1</span>)</span><br><span class="line">SystemExit: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>nova_libvirt 容器</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># docker logs c492de413c81</span><br><span class="line"></span><br><span class="line">INFO:__main__:Kolla config strategy set to: COPY_ALWAYS</span><br><span class="line">INFO:__main__:Loading config <span class="keyword">file</span> at <span class="regexp">/var/</span>lib<span class="regexp">/kolla/</span>config_files/config.json</span><br><span class="line">INFO:__main__:Validating config <span class="keyword">file</span></span><br><span class="line">INFO:__main__:Copying service configuration files</span><br><span class="line">INFO:__main__:Removing existing destination: <span class="regexp">/etc/</span>libvirt/libvirtd.conf</span><br><span class="line">INFO:__main__:Copying <span class="regexp">/var/</span>lib<span class="regexp">/kolla/</span>config_files<span class="regexp">/libvirtd.conf to /</span>etc<span class="regexp">/libvirt/</span>libvirtd.conf</span><br><span class="line">INFO:__main__:Setting permissions <span class="keyword">for</span> <span class="regexp">/etc/</span>libvirt/libvirtd.conf</span><br><span class="line">INFO:__main__:Removing existing destination: <span class="regexp">/etc/</span>libvirt/qemu.conf</span><br><span class="line">INFO:__main__:Copying <span class="regexp">/var/</span>lib<span class="regexp">/kolla/</span>config_files<span class="regexp">/qemu.conf to /</span>etc<span class="regexp">/libvirt/</span>qemu.conf</span><br><span class="line">INFO:__main__:Setting permissions <span class="keyword">for</span> <span class="regexp">/etc/</span>libvirt/qemu.conf</span><br><span class="line">INFO:__main__:Writing out command to execute</span><br><span class="line">Running command: <span class="string">&#x27;/usr/sbin/libvirtd --listen&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><h3 id="1-google"><a href="#1-google" class="headerlink" title="1. google"></a>1. google</h3><p>查找到此问题是 kolla-ansible 的一个 bug，详细介绍见 <a href="https://review.openstack.org/#/c/492033/">Fix nova-libvirt and nova-compute fails to deploy</a></p><h3 id="2-依照上文的方法进行修复"><a href="#2-依照上文的方法进行修复" class="headerlink" title="2. 依照上文的方法进行修复"></a>2. 依照上文的方法进行修复</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/ansible/roles/nova/templates/libvirtd.conf.j2</span><br><span class="line"></span><br><span class="line"><span class="addition">+listen_tls = 0</span></span><br><span class="line">listen_tcp = 1</span><br><span class="line">auth_tcp = &quot;none&quot;</span><br><span class="line">ca_file = &quot;&quot;</span><br><span class="line">log_level = 3</span><br><span class="line">log_outputs = &quot;3:file:/var/log/kolla/libvirt/libvirtd.log&quot;</span><br><span class="line">listen_addr = &quot;&#123;&#123; hostvars[inventory_hostname][&#x27;ansible_&#x27; + api_interface][&#x27;ipv4&#x27;][&#x27;address&#x27;] &#125;&#125;&quot;</span><br></pre></td></tr></table></figure><h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>清除之前的容器重新 deploy 后，nova_compute 和 nova_libvirt 状态正常</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># <span class="regexp">/root/</span>kolla<span class="regexp">/tools/</span>cleanup-containers</span><br><span class="line"># <span class="regexp">/root/</span>kolla<span class="regexp">/tools/</span>cleanup-host</span><br><span class="line"># kolla-ansible deploy</span><br><span class="line"></span><br><span class="line"># docker ps</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">cffc9fc2774b        kolla/centos-binary-nova-compute:<span class="number">2.0</span>.<span class="number">4</span>                <span class="string">&quot;kolla_start&quot;</span>            <span class="number">5</span> minutes ago       Up <span class="number">5</span> minutes                            nova_compute</span><br><span class="line"><span class="number">5</span>f27c8052238        kolla/centos-binary-nova-libvirt:<span class="number">2.0</span>.<span class="number">4</span>                <span class="string">&quot;kolla_start&quot;</span>            <span class="number">5</span> minutes ago       Up <span class="number">5</span> minutes                            nova_libvirt</span><br></pre></td></tr></table></figure><h1 id="问题六-dashboard-无法访问"><a href="#问题六-dashboard-无法访问" class="headerlink" title="问题六: dashboard 无法访问"></a>问题六: dashboard 无法访问</h1><h2 id="问题描述-5"><a href="#问题描述-5" class="headerlink" title="问题描述"></a>问题描述</h2><p>完成以上步骤后，发现控制台无法访问，端口已经监听，浏览器访问报 “504 Gateway Time-out”</p><h2 id="问题排查-1"><a href="#问题排查-1" class="headerlink" title="问题排查"></a>问题排查</h2><h3 id="1-查看-dashboard-日志"><a href="#1-查看-dashboard-日志" class="headerlink" title="1. 查看 dashboard 日志"></a>1. 查看 dashboard 日志</h3><figure class="highlight inform7"><table><tr><td class="code"><pre><span class="line"># docker exec -it heka bash</span><br><span class="line">(heka)<span class="comment">[heka@allinone /]</span>$ tail -50f /var/log/kolla/horizon/horizon.log</span><br><span class="line"><span class="comment">[Mon Jul 16 05:25:13.065432 2018]</span> <span class="comment">[core:error]</span> <span class="comment">[pid 41]</span> <span class="comment">[client 172.16.15.246:59248]</span> End <span class="keyword">of</span> script output before headers: django.wsgi</span><br><span class="line"><span class="comment">[Mon Jul 16 05:31:23.408902 2018]</span> <span class="comment">[core:error]</span> <span class="comment">[pid 43]</span> <span class="comment">[client 172.16.15.227:57733]</span> End <span class="keyword">of</span> script output before headers: django.wsgi</span><br><span class="line"><span class="comment">[Mon Jul 16 05:31:33.443843 2018]</span> <span class="comment">[core:error]</span> <span class="comment">[pid 40]</span> <span class="comment">[client 172.16.15.246:36708]</span> End <span class="keyword">of</span> script output before headers: django.wsgi</span><br></pre></td></tr></table></figure><h3 id="2-dashboard无法访问的问题"><a href="#2-dashboard无法访问的问题" class="headerlink" title="2. dashboard无法访问的问题"></a>2. dashboard无法访问的问题</h3><p>之前使用 packstack 安装M版也遇到 dashboard 无法访问的问题，问题和此问题一致。详情可以参考 <a href="https://bugs.launchpad.net/horizon/+bug/1573488">Openstack Mitaka: can not access dashboard(internal server 500) </a></p><h3 id="3-修改dashboard文件，加入以下内容"><a href="#3-修改dashboard文件，加入以下内容" class="headerlink" title="3. 修改dashboard文件，加入以下内容"></a>3. 修改dashboard文件，加入以下内容</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /etc/kolla/horizon/horizon.conf</span><br><span class="line"></span><br><span class="line">    WSGIScriptReloading On</span><br><span class="line">    WSGIDaemonProcess horizon-http processes=5 threads=1 user=horizon group=horizon display-name=%&#123;GROUP&#125; python-path=/usr/lib/python2.7/site-packages</span><br><span class="line">    WSGIProcessGroup horizon-http</span><br><span class="line"><span class="addition">+   WSGIApplicationGroup %&#123;GLOBAL&#125;</span></span><br></pre></td></tr></table></figure><p>为了使 clean 之后还能使用，还需要修改以下部分</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/ansible/roles/horizon/templates/horizon.conf.j2</span><br><span class="line"></span><br><span class="line">    WSGIScriptReloading On</span><br><span class="line">    WSGIDaemonProcess horizon-http processes=5 threads=1 user=horizon group=horizon display-name=%&#123;GROUP&#125; python-path=&#123;&#123; python_path &#125;&#125;</span><br><span class="line">    WSGIProcessGroup horizon-http</span><br><span class="line"><span class="addition">+   WSGIApplicationGroup %&#123;GLOBAL&#125;</span></span><br></pre></td></tr></table></figure><h2 id="验证-2"><a href="#验证-2" class="headerlink" title="验证"></a>验证</h2><p>重启容器后验证 dashboard 能否打开</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># docker restart horizon</span></span><br></pre></td></tr></table></figure><p><img data-src="/images/uploads/2018/07/dashboard.jpg"></p><h1 id="问题七-dashboard-登陆报错"><a href="#问题七-dashboard-登陆报错" class="headerlink" title="问题七: dashboard 登陆报错"></a>问题七: dashboard 登陆报错</h1><h2 id="问题描述-6"><a href="#问题描述-6" class="headerlink" title="问题描述"></a>问题描述</h2><p>可以正常打开 dashboard 了，但是登陆后有如下错误<br><img data-src="/images/uploads/2018/07/error.jpg"></p><h2 id="排查问题-2"><a href="#排查问题-2" class="headerlink" title="排查问题"></a>排查问题</h2><h3 id="1-查看-dashboard-日志-1"><a href="#1-查看-dashboard-日志-1" class="headerlink" title="1. 查看 dashboard 日志"></a>1. 查看 dashboard 日志</h3><figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line"># docker exec -it heka bash</span><br><span class="line"></span><br><span class="line">(heka)[heka@allinone /]$ tail <span class="number">-50</span>f /var/log/kolla/horizon/horizon.log</span><br><span class="line">……</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368340</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/template/base.py&quot;</span>, line <span class="number">905</span>, in render</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368353</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     bit = self.render_node(node, context)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368373</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/template/base.py&quot;</span>, line <span class="number">919</span>, in render_node</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368387</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     return node.render(context)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368399</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/templatetags/i18n.py&quot;</span>, line <span class="number">145</span>, in render</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368412</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     result = translation.ungettext(singular, plural, count)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368425</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/utils/translation/__init__.py&quot;</span>, line <span class="number">88</span>, in ungettext</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368438</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     return <span class="symbol">_trans</span>.ungettext(singular, plural, number)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368451</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;</span>, line <span class="number">381</span>, in ungettext</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368464</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     return do_ntranslate(singular, plural, number, <span class="string">&#x27;ungettext&#x27;</span>)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368506</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib/python2.7/site-packages/django/utils/translation/trans_real.py&quot;</span>, line <span class="number">358</span>, in do_ntranslate</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368550</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     return getattr(t, translation_function)(singular, plural, number)</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368571</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]   <span class="symbol">File</span> <span class="string">&quot;/usr/lib64/python2.7/gettext.py&quot;</span>, line <span class="number">411</span>, in ungettext</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368585</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>]     tmsg = self.<span class="symbol">_catalog</span>[(msgid1, self.plural(n))]</span><br><span class="line">[<span class="symbol">Mon</span> <span class="symbol">Jul</span> <span class="number">16</span> <span class="number">09</span>:<span class="number">29</span>:<span class="number">07.368597</span> <span class="number">2018</span>] [:error] [pid <span class="number">19</span>] <span class="symbol">AttributeError</span>: <span class="symbol">DjangoTranslation</span> instance has no attribute <span class="string">&#x27;plural&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="2-查看-dashboard-国际化文件夹"><a href="#2-查看-dashboard-国际化文件夹" class="headerlink" title="2. 查看 dashboard 国际化文件夹"></a>2. 查看 dashboard 国际化文件夹</h3><p>发现中文等目录中内容都为空，对比正常环境得知此目录中应该有 LC_MESSAGES 文件，用于生成国际化文件。</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># docker exec -it horizon bash</span><br><span class="line"></span><br><span class="line">(horizon)[root@allinone ~]# ls <span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/openstack_dashboard/</span>locale/zh_CN</span><br></pre></td></tr></table></figure><h3 id="3-启动容器，模拟-horizon-镜像的生成"><a href="#3-启动容器，模拟-horizon-镜像的生成" class="headerlink" title="3. 启动容器，模拟 horizon 镜像的生成"></a>3. 启动容器，模拟 horizon 镜像的生成</h3><p>以 kolla/centos-binary-openstack-base:2.0.4 为镜像创建一个容器</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># docker run -it kolla<span class="regexp">/centos-binary-openstack-base:2.0.4 /</span>bin/bash</span><br></pre></td></tr></table></figure><p>在其中执行安装生成 horizon 镜像的操作</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/usr/</span>share<span class="regexp">/kolla/</span>docker<span class="regexp">/horizon/</span>Dockerfile.j2</span><br><span class="line"></span><br><span class="line">RUN yum -y install \</span><br><span class="line">        openstack-dashboard \</span><br><span class="line">        httpd \</span><br><span class="line">        mod_wsgi \</span><br><span class="line">        <span class="keyword">gettext</span> \</span><br><span class="line">    &amp;&amp; yum clean all \</span><br><span class="line">    &amp;&amp; useradd --user-<span class="keyword">group</span> horizon \</span><br><span class="line">    &amp;&amp; sed -i -r <span class="string">&#x27;s,^(Listen 80),#\1,&#x27;</span> <span class="regexp">/etc/</span>httpd<span class="regexp">/conf/</span>httpd.conf \</span><br><span class="line">    &amp;&amp; ln -s <span class="regexp">/usr/</span>share<span class="regexp">/openstack-dashboard/</span>openstack_dashboard <span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages/openstack_dashboard \</span><br><span class="line">    &amp;&amp; ln -s <span class="regexp">/usr/</span>share<span class="regexp">/openstack-dashboard/</span><span class="keyword">static</span> <span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages/<span class="keyword">static</span> \</span><br><span class="line">    &amp;&amp; chown -R horizon: <span class="regexp">/etc/</span>openstack-dashboard <span class="regexp">/usr/</span>share/openstack-dashboard \</span><br><span class="line">    &amp;&amp; chown -R apache: <span class="regexp">/usr/</span>share<span class="regexp">/openstack-dashboard/</span><span class="keyword">static</span></span><br><span class="line">……</span><br></pre></td></tr></table></figure><p>最终发现在执行了第一步安装 openstack-dashboard 后就没有在 /usr/share/openstack-dashboard/openstack_dashboard/locale 目录中生成对应的 LC_MESSAGES 文件</p><h3 id="4-使用-rpm-命令安装"><a href="#4-使用-rpm-命令安装" class="headerlink" title="4. 使用 rpm 命令安装"></a>4. 使用 rpm 命令安装</h3><p>直接使用 rpm 安装可以生成对应的国际化文件</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">()[root@e06f6d94adba ~]# yum remove openstack-dashboard -y</span><br><span class="line">()[root@e06f6d94adba ~]# rpm -ivh  http:<span class="comment">//mirror.neu.edu.cn/centos/7/cloud/x86_64/openstack-mitaka/openstack-dashboard-9.0.1-1.el7.noarch.rpm</span></span><br><span class="line">()[root@e06f6d94adba ~]# ls <span class="regexp">/usr/</span>share<span class="regexp">/openstack-dashboard/</span>openstack_dashboard<span class="regexp">/locale/</span>zh_CN/</span><br><span class="line">LC_MESSAGES</span><br></pre></td></tr></table></figure><h3 id="5-修改-horizon-的-dockerfile"><a href="#5-修改-horizon-的-dockerfile" class="headerlink" title="5. 修改 horizon 的 dockerfile"></a>5. 修改 horizon 的 dockerfile</h3><p>先用 yum 安装 openstack-dashboard，解决依赖问题。在删除，使用 rpm 安装 openstack-dashboard</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/kolla/docker/horizon/Dockerfile.j2</span><br><span class="line"></span><br><span class="line">RUN yum -y install \</span><br><span class="line">        openstack-dashboard \</span><br><span class="line">        httpd \</span><br><span class="line">        mod_wsgi \</span><br><span class="line">        gettext \</span><br><span class="line"><span class="addition">+   &amp;&amp; rpm -e  openstack-dashboard &amp;&amp; rm -rf /etc/openstack-dashboard/local_settings.rpmsave \</span></span><br><span class="line"><span class="addition">+   &amp;&amp; rpm -ivh  http://mirror.neu.edu.cn/centos/7/cloud/x86_64/openstack-mitaka/openstack-dashboard-9.0.1-1.el7.noarch.rpm \</span></span><br><span class="line">    &amp;&amp; yum clean all \</span><br></pre></td></tr></table></figure><h3 id="6-重新-build-horizon镜像"><a href="#6-重新-build-horizon镜像" class="headerlink" title="6. 重新 build horizon镜像"></a>6. 重新 build horizon镜像</h3><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line"># kolla-build --<span class="built_in">base</span> centos -<span class="built_in">t</span> binary horizon</span><br></pre></td></tr></table></figure><h2 id="验证-3"><a href="#验证-3" class="headerlink" title="验证"></a>验证</h2><p>重新 deploy 后，dashboard 可以正常打开，登陆后可以正常显示<br><img data-src="/images/uploads/2018/07/normal.png"></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;实验需要使用 kolla 部署 openstack mitaka环境，由于是两年前的版本，实验过程中遇到了一些坑，记录如下。&lt;/p&gt;
&lt;h1 id=&quot;系统环境&quot;&gt;&lt;a href=&quot;#系统环境&quot; class=&quot;headerlink&quot; title=&quot;系统环境&quot;&gt;&lt;/a&gt;系统环境&lt;/h1&gt;&lt;p&gt;操作系统：CentOS Linux release 7.2.1511 (Core)&lt;br&gt;内核版本：3.10.0-327.28.3.el7.x86_64&lt;br&gt;kolla版本：mitaka-eol&lt;br&gt;docker版本：Docker version 1.13.1, build 092cba3&lt;br&gt;docker镜像：官方tag 2.0.2 (对应 openstack mitaka版本)&lt;/p&gt;
&lt;h1 id=&quot;问题一-openvswitch-db-容器无法运行&quot;&gt;&lt;a href=&quot;#问题一-openvswitch-db-容器无法运行&quot; class=&quot;headerlink&quot; title=&quot;问题一: openvswitch_db 容器无法运行&quot;&gt;&lt;/a&gt;问题一: openvswitch_db 容器无法运行&lt;/h1&gt;&lt;h2 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h2&gt;&lt;p&gt;kolla-ansible deploy 部署openstack的时候总会遇到 openvswitch_db service 无法启动的问题&lt;/p&gt;
&lt;figure class=&quot;highlight livescript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;TASK: [neutron | Waiting the openvswitch_db service &lt;span class=&quot;keyword&quot;&gt;to&lt;/span&gt; be ready] ************** &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;failed: [localhost] =&amp;gt; &amp;#123;&lt;span class=&quot;string&quot;&gt;&amp;quot;attempts&amp;quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;30&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;changed&amp;quot;&lt;/span&gt;: &lt;span class=&quot;literal&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;cmd&amp;quot;&lt;/span&gt;: [&lt;span class=&quot;string&quot;&gt;&amp;quot;docker&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;exec&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;openvswitch_db&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;ovs-vsctl&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;--no-wait&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;show&amp;quot;&lt;/span&gt;], &lt;span class=&quot;string&quot;&gt;&amp;quot;delta&amp;quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;quot;0:00:00.032518&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;end&amp;quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;quot;2018-07-09 07:33:12.680647&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;failed&amp;quot;&lt;/span&gt;: &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;rc&amp;quot;&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;start&amp;quot;&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;quot;2018-07-09 07:33:12.648129&amp;quot;&lt;/span&gt;, &lt;span class=&quot;string&quot;&gt;&amp;quot;stdout_lines&amp;quot;&lt;/span&gt;: [], &lt;span class=&quot;string&quot;&gt;&amp;quot;warnings&amp;quot;&lt;/span&gt;: []&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;stderr: &lt;span class=&quot;built_in&quot;&gt;Error&lt;/span&gt; response &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; daemon: Container &lt;span class=&quot;number&quot;&gt;0cec&lt;/span&gt;739aabe06805aa0e1624318ac052d9f8fb176078df3d20a13c4df304fa7a &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; restarting, wait &lt;span class=&quot;keyword&quot;&gt;until&lt;/span&gt; the container &lt;span class=&quot;keyword&quot;&gt;is&lt;/span&gt; running&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;msg: Task failed &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; maximum retries was encountered&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;FATAL: all hosts have already failed -- aborting&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查看容器日志有如下报错&lt;/p&gt;
&lt;figure class=&quot;highlight stata&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;INFO:__main__:Kolla config strategy &lt;span class=&quot;keyword&quot;&gt;set&lt;/span&gt; to: COPY_ALWAYS&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO:__main__:Loading config &lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt; at /&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/lib/kolla/config_files/config.json&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO:__main__:Validating config &lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO:__main__:Copying service configuration files&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;INFO:__main__:Writing &lt;span class=&quot;keyword&quot;&gt;out&lt;/span&gt; command to execute&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Running command: &amp;#x27;/usr/sbin/ovsdb-server /&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/lib/openvswitch/&lt;span class=&quot;keyword&quot;&gt;conf&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;db&lt;/span&gt; -vconsole:emer -vsyslog:&lt;span class=&quot;keyword&quot;&gt;err&lt;/span&gt; -vfile:info --remote=punix:/&lt;span class=&quot;keyword&quot;&gt;run&lt;/span&gt;/openvswitch/&lt;span class=&quot;keyword&quot;&gt;db&lt;/span&gt;.sock --&lt;span class=&quot;keyword&quot;&gt;log&lt;/span&gt;-&lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt;=/&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/&lt;span class=&quot;keyword&quot;&gt;log&lt;/span&gt;/openvswitch/ovsdb-server.&lt;span class=&quot;keyword&quot;&gt;log&lt;/span&gt;&amp;#x27;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;ovsdb-server: I/O &lt;span class=&quot;keyword&quot;&gt;error&lt;/span&gt;: &lt;span class=&quot;keyword&quot;&gt;open&lt;/span&gt;: /&lt;span class=&quot;keyword&quot;&gt;var&lt;/span&gt;/lib/openvswitch/&lt;span class=&quot;keyword&quot;&gt;conf&lt;/span&gt;.&lt;span class=&quot;keyword&quot;&gt;db&lt;/span&gt; failed (&lt;span class=&quot;keyword&quot;&gt;No&lt;/span&gt; such &lt;span class=&quot;keyword&quot;&gt;file&lt;/span&gt; or directory)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="docker" scheme="https://www.sunmite.com/tags/docker/"/>
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="kolla" scheme="https://www.sunmite.com/tags/kolla/"/>
    
  </entry>
  
  <entry>
    <title>CentOS 编译安装 ixgbe-5.3.7</title>
    <link href="https://www.sunmite.com/linux/update-ixgbe-on-centos.html"/>
    <id>https://www.sunmite.com/linux/update-ixgbe-on-centos.html</id>
    <published>2018-07-03T07:22:43.000Z</published>
    <updated>2021-01-25T02:17:02.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-安装依赖"><a href="#1-安装依赖" class="headerlink" title="1. 安装依赖"></a>1. 安装依赖</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install gcc kernel-header kernel-devel</span></span><br></pre></td></tr></table></figure><h2 id="2-解压源码并编译"><a href="#2-解压源码并编译" class="headerlink" title="2. 解压源码并编译"></a>2. 解压源码并编译</h2><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># tar zxvf ixgbe-5.3.7.tar.gz</span></span><br><span class="line"><span class="meta"># cd ixgbe-5.3.7/src/</span></span><br><span class="line"><span class="meta"># make </span></span><br></pre></td></tr></table></figure><p>此时还是有以下错误</p><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment"># make</span></span><br><span class="line">common.mk:<span class="number">102</span>: *** Kernel header <span class="built_in">files</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">any</span> <span class="keyword">of</span> <span class="keyword">the</span> expected locations.</span><br><span class="line">common.mk:<span class="number">103</span>: *** Install <span class="keyword">the</span> appropriate kernel development package, e.g.</span><br><span class="line">common.mk:<span class="number">104</span>: *** kernel-devel, <span class="keyword">for</span> building kernel modules <span class="keyword">and</span> <span class="keyword">try</span> again.  Stop.</span><br></pre></td></tr></table></figure><p>打开 common.mk 发现编译时需要 /usr/src/linux 目录，但是系统并没有此目录，手动创建 /usr/src/kernels/3.10.0-862.6.3.el7.x86_64/ 到 /usr/src/linux 的链接即可</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># ln -s <span class="regexp">/usr/</span>src<span class="regexp">/kernels/</span><span class="number">3.10</span>.<span class="number">0</span>-<span class="number">862.6</span>.<span class="number">3</span>.el7.x86_64<span class="regexp">/ /u</span>sr<span class="regexp">/src/</span>linux</span><br></pre></td></tr></table></figure><span id="more"></span><p>重新编译</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># make </span></span><br><span class="line">make[<span class="number">1</span>]: Entering directory `<span class="meta-keyword">/usr/</span>src<span class="meta-keyword">/kernels/</span><span class="number">3.10</span><span class="number">.0</span><span class="number">-862.6</span><span class="number">.3</span>.el7.x86_64&#x27;</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_main.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_api.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_common.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_dcb.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_dcb_82598.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_dcb_82599.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_ethtool.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_lib.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_mbx.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_sriov.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_param.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_phy.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_procfs.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_82598.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_82599.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_x540.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_x550.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_dcb_nl.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_debugfs.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_fcoe.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_ptp.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe_sysfs.o</span><br><span class="line">  CC [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>kcompat.o</span><br><span class="line">  LD [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe.mod.o</span><br><span class="line">  LD [M]  <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>ixgbe.ko</span><br><span class="line">make[<span class="number">1</span>]: Leaving directory `<span class="meta-keyword">/usr/</span>src<span class="meta-keyword">/kernels/</span><span class="number">3.10</span><span class="number">.0</span><span class="number">-862.6</span><span class="number">.3</span>.el7.x86_64&#x27;</span><br></pre></td></tr></table></figure><p>查看编译后驱动信息</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># modinfo ./ixgbe.ko</span></span><br><span class="line"><span class="symbol">filename:</span>       <span class="meta-keyword">/root/</span>ixgbe<span class="number">-5.3</span><span class="number">.7</span><span class="meta-keyword">/src/</span>./ixgbe.ko</span><br><span class="line"><span class="symbol">version:</span>        <span class="number">5.3</span><span class="number">.7</span></span><br><span class="line"><span class="symbol">license:</span>        GPL</span><br><span class="line"><span class="symbol">description:</span>    Intel(R) <span class="number">10</span>GbE PCI Express Linux Network Driver</span><br><span class="line"><span class="symbol">author:</span>         Intel Corporation, <span class="params">&lt;linux.nics@intel.com&gt;</span></span><br><span class="line"><span class="symbol">retpoline:</span>      Y</span><br><span class="line"><span class="symbol">rhelversion:</span>    <span class="number">7.5</span></span><br><span class="line"><span class="symbol">srcversion:</span>     <span class="number">9E1</span>B3824190E963083DADF5</span><br><span class="line">…………</span><br></pre></td></tr></table></figure><h2 id="3-加载驱动"><a href="#3-加载驱动" class="headerlink" title="3. 加载驱动"></a>3. 加载驱动</h2><p>如果系统已经安装 ixgbe 驱动要先卸载</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rmmod ixgbe.ko</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lsmod | grep ixgbe</span></span><br><span class="line"><span class="attribute">ixgbevf</span>                <span class="number">62069</span>  <span class="number">0</span> </span><br></pre></td></tr></table></figure><p>加载ixgbe驱动</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># insmod ./ixgbe.ko</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lsmod | grep ixgbe</span></span><br><span class="line"><span class="attribute">ixgbe</span>                 <span class="number">329961</span>  <span class="number">0</span> </span><br><span class="line"><span class="attribute">ixgbevf</span>                <span class="number">62069</span>  <span class="number">0</span> </span><br><span class="line"><span class="attribute">dca</span>                    <span class="number">15130</span>  <span class="number">2</span> ixgbe,ioatdma</span><br><span class="line"><span class="attribute">ptp</span>                    <span class="number">19231</span>  <span class="number">2</span> tg<span class="number">3</span>,ixgbe</span><br></pre></td></tr></table></figure><p>使用 dmesg 验证驱动是否加载成功</p><figure class="highlight less"><table><tr><td class="code"><pre><span class="line"># <span class="selector-tag">dmesg</span></span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[681507.970884]</span> <span class="selector-tag">Intel</span>(R) <span class="selector-tag">10GbE</span> <span class="selector-tag">PCI</span> <span class="selector-tag">Express</span> <span class="selector-tag">Linux</span> <span class="selector-tag">Network</span> <span class="selector-tag">Driver</span> <span class="selector-tag">-</span> <span class="selector-tag">version</span> <span class="selector-tag">5</span><span class="selector-class">.3</span><span class="selector-class">.7</span></span><br><span class="line"><span class="selector-attr">[681507.970886]</span> <span class="selector-tag">Copyright</span>(c) <span class="selector-tag">1999</span> <span class="selector-tag">-</span> <span class="selector-tag">2018</span> <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span>.</span><br><span class="line"><span class="selector-attr">[681507.989690]</span> <span class="selector-tag">ixgbe</span>: <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">ixgbe_check_options</span>: <span class="selector-tag">FCoE</span> <span class="selector-tag">Offload</span> <span class="selector-tag">feature</span> <span class="selector-tag">enabled</span></span><br><span class="line"><span class="selector-attr">[681508.138527]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">95</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138537]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">96</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138549]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">97</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138557]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">98</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138569]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">99</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138577]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">100</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138589]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">101</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138597]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">102</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138609]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">103</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138616]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">104</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138624]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">105</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138632]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">106</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138640]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">107</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138648]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">108</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138656]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">109</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138664]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">110</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138671]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">111</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138679]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">112</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138691]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">113</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138698]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">114</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138706]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">115</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138714]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">116</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138722]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">117</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138730]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">118</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138737]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">119</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138751]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">120</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br><span class="line"><span class="selector-attr">[681508.138758]</span> <span class="selector-tag">ixgbe</span> <span class="selector-tag">0000</span>:<span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span>: <span class="selector-tag">irq</span> <span class="selector-tag">121</span> <span class="selector-tag">for</span> <span class="selector-tag">MSI</span>/<span class="selector-tag">MSI-X</span></span><br></pre></td></tr></table></figure><h2 id="4-安装-ixgbe-驱动"><a href="#4-安装-ixgbe-驱动" class="headerlink" title="4. 安装 ixgbe 驱动"></a>4. 安装 ixgbe 驱动</h2><p>确认驱动加载成功后，继续安装驱动到系统</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># make install</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">make</span>[<span class="number">1</span>]: Entering directory `/usr/src/kernels/<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">862</span>.<span class="number">6</span>.<span class="number">3</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>&#x27;</span><br><span class="line">  <span class="attribute">Building</span> modules, stage <span class="number">2</span>.</span><br><span class="line">  <span class="attribute">MODPOST</span> <span class="number">1</span> modules</span><br><span class="line"><span class="attribute">make</span>[<span class="number">1</span>]: Leaving directory `/usr/src/kernels/<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">862</span>.<span class="number">6</span>.<span class="number">3</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>&#x27;</span><br><span class="line"><span class="attribute">Copying</span> manpages...</span><br><span class="line"><span class="attribute">Installing</span> modules...</span><br><span class="line"><span class="attribute">make</span>[<span class="number">1</span>]: Entering directory `/usr/src/kernels/<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">862</span>.<span class="number">6</span>.<span class="number">3</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>&#x27;</span><br><span class="line">  <span class="attribute">INSTALL</span> /root/ixgbe-<span class="number">5</span>.<span class="number">3</span>.<span class="number">7</span>/src/ixgbe.ko</span><br><span class="line"><span class="attribute">Can</span>&#x27;t read private key</span><br><span class="line">  <span class="attribute">DEPMOD</span>  <span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">862</span>.<span class="number">6</span>.<span class="number">3</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span></span><br><span class="line"><span class="attribute">make</span>[<span class="number">1</span>]: Leaving directory `/usr/src/kernels/<span class="number">3</span>.<span class="number">10</span>.<span class="number">0</span>-<span class="number">862</span>.<span class="number">6</span>.<span class="number">3</span>.el<span class="number">7</span>.x<span class="number">86</span>_<span class="number">64</span>&#x27;</span><br><span class="line"><span class="attribute">Running</span> depmod...</span><br></pre></td></tr></table></figure><p>ixgbe.ko 会被安装到以下目录</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="regexp">/lib/m</span>odules<span class="regexp">/KERNEL_VERSION/u</span>pdates<span class="regexp">/drivers/</span>net<span class="regexp">/ethernet/i</span>ntel<span class="regexp">/ixgbe/</span></span><br></pre></td></tr></table></figure><p>编译好的驱动将在启动的时候自动加载，也可以用以下命令加载</p><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line"><span class="meta"># modprobe ixgbe</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># modinfo ixgbe</span></span><br><span class="line"><span class="symbol">filename:</span>       <span class="meta-keyword">/lib/</span>modules/<span class="number">3.10</span><span class="number">.0</span><span class="number">-862.6</span><span class="number">.3</span>.el7.x86_64<span class="meta-keyword">/updates/</span>drivers<span class="meta-keyword">/net/</span>ethernet<span class="meta-keyword">/intel/</span>ixgbe/ixgbe.ko</span><br><span class="line"><span class="symbol">version:</span>        <span class="number">5.3</span><span class="number">.7</span></span><br><span class="line"><span class="symbol">license:</span>        GPL</span><br><span class="line"><span class="symbol">description:</span>    Intel(R) <span class="number">10</span>GbE PCI Express Linux Network Driver</span><br><span class="line"><span class="symbol">author:</span>         Intel Corporation, <span class="params">&lt;linux.nics@intel.com&gt;</span></span><br><span class="line"><span class="symbol">retpoline:</span>      Y</span><br><span class="line"><span class="symbol">rhelversion:</span>    <span class="number">7.5</span></span><br><span class="line"><span class="symbol">srcversion:</span>     <span class="number">9E1</span>B3824190E963083DADF5</span><br><span class="line">……</span><br></pre></td></tr></table></figure><hr><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://ask.xmodulo.com/compile-ixgbe-driver-centos-rhel-fedora.html">How to compile ixgbe driver on CentOS, RHEL or Fedora</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-安装依赖&quot;&gt;&lt;a href=&quot;#1-安装依赖&quot; class=&quot;headerlink&quot; title=&quot;1. 安装依赖&quot;&gt;&lt;/a&gt;1. 安装依赖&lt;/h2&gt;&lt;figure class=&quot;highlight vala&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# yum install gcc kernel-header kernel-devel&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;2-解压源码并编译&quot;&gt;&lt;a href=&quot;#2-解压源码并编译&quot; class=&quot;headerlink&quot; title=&quot;2. 解压源码并编译&quot;&gt;&lt;/a&gt;2. 解压源码并编译&lt;/h2&gt;&lt;figure class=&quot;highlight vala&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# tar zxvf ixgbe-5.3.7.tar.gz&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# cd ixgbe-5.3.7/src/&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# make &lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;此时还是有以下错误&lt;/p&gt;
&lt;figure class=&quot;highlight livecodeserver&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# make&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;common.mk:&lt;span class=&quot;number&quot;&gt;102&lt;/span&gt;: *** Kernel header &lt;span class=&quot;built_in&quot;&gt;files&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;any&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; expected locations.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;common.mk:&lt;span class=&quot;number&quot;&gt;103&lt;/span&gt;: *** Install &lt;span class=&quot;keyword&quot;&gt;the&lt;/span&gt; appropriate kernel development package, e.g.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;common.mk:&lt;span class=&quot;number&quot;&gt;104&lt;/span&gt;: *** kernel-devel, &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; building kernel modules &lt;span class=&quot;keyword&quot;&gt;and&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;try&lt;/span&gt; again.  Stop.&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;打开 common.mk 发现编译时需要 /usr/src/linux 目录，但是系统并没有此目录，手动创建 /usr/src/kernels/3.10.0-862.6.3.el7.x86_64/ 到 /usr/src/linux 的链接即可&lt;/p&gt;
&lt;figure class=&quot;highlight gradle&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# ln -s &lt;span class=&quot;regexp&quot;&gt;/usr/&lt;/span&gt;src&lt;span class=&quot;regexp&quot;&gt;/kernels/&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;3.10&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;-&lt;span class=&quot;number&quot;&gt;862.6&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;3&lt;/span&gt;.el7.x86_64&lt;span class=&quot;regexp&quot;&gt;/ /u&lt;/span&gt;sr&lt;span class=&quot;regexp&quot;&gt;/src/&lt;/span&gt;linux&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="linux" scheme="https://www.sunmite.com/categories/linux/"/>
    
    
    <category term="sriov" scheme="https://www.sunmite.com/tags/sriov/"/>
    
    <category term="ixgbe" scheme="https://www.sunmite.com/tags/ixgbe/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack SR-IOV研究</title>
    <link href="https://www.sunmite.com/openstack/openstack-sriov.html"/>
    <id>https://www.sunmite.com/openstack/openstack-sriov.html</id>
    <published>2018-06-15T09:14:23.000Z</published>
    <updated>2021-01-25T02:17:02.336Z</updated>
    
    <content type="html"><![CDATA[<p>关于 SR-IOV 本文就不再介绍了,具体可以查看 <a href="https://www.intel.com/content/www/us/en/embedded/products/networking/82599-sr-iov-driver-companion-guide.html">Intel® 82599 SR-IOV Driver Companion Guide</a>。</p><h2 id="一、系统环境"><a href="#一、系统环境" class="headerlink" title="一、系统环境"></a>一、系统环境</h2><p>操作系统: RHEL 7.2<br>OpenStack版本: OpenStack Mitaka Allinone<br>网卡型号: Intel Corporation 82599ES<br>SR-IVO网卡名: ens1f0, ens1f0</p><h2 id="二、服务器配置"><a href="#二、服务器配置" class="headerlink" title="二、服务器配置"></a>二、服务器配置</h2><p>在服务器 BIOS 中开启 VT-d 和 SR-IOV</p><h2 id="三、操作系统配置"><a href="#三、操作系统配置" class="headerlink" title="三、操作系统配置"></a>三、操作系统配置</h2><h3 id="1-编辑-etc-default-grub-文件-加入以下内容"><a href="#1-编辑-etc-default-grub-文件-加入以下内容" class="headerlink" title="1. 编辑 /etc/default/grub 文件,加入以下内容"></a>1. 编辑 /etc/default/grub 文件,加入以下内容</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=&quot;$(sed &#x27;s, release .*$,,g&#x27; /etc/system-release)&quot;</span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=true</span><br><span class="line">GRUB_TERMINAL_OUTPUT=&quot;console&quot;</span><br><span class="line"><span class="deletion">-GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet&quot;</span></span><br><span class="line"><span class="addition">+GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet intel_iommu=on&quot;</span></span><br><span class="line">GRUB_DISABLE_RECOVERY=&quot;true&quot;</span><br></pre></td></tr></table></figure><p>需要说明的是: ixgbe.max_vfs 参数已经废弃，故没有加入到内核参数中。</p><span id="more"></span><h3 id="2-重新生成-grub-文件"><a href="#2-重新生成-grub-文件" class="headerlink" title="2. 重新生成 grub 文件"></a>2. 重新生成 grub 文件</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># grub2-mkconfig -o <span class="regexp">/boot/g</span>rub2/grub.cfg</span><br></pre></td></tr></table></figure><h3 id="3-配置-SR-IOV-的网卡开机自启"><a href="#3-配置-SR-IOV-的网卡开机自启" class="headerlink" title="3. 配置 SR-IOV 的网卡开机自启"></a>3. 配置 SR-IOV 的网卡开机自启</h3><p>编辑网卡配置文件，修改以下内容</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">BOOTPROTO</span>=none</span><br><span class="line"><span class="attr">ONBOOT</span>=<span class="literal">yes</span></span><br></pre></td></tr></table></figure><h3 id="4-设置开机自动创建-VF-计算节点"><a href="#4-设置开机自动创建-VF-计算节点" class="headerlink" title="4. 设置开机自动创建 VF(计算节点)"></a>4. 设置开机自动创建 VF(计算节点)</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/etc/</span>rc.d/rc.local</span><br><span class="line"></span><br><span class="line">echo <span class="string">&#x27;0&#x27;</span> &gt; <span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/net/</span>ens1f0<span class="regexp">/device/</span>sriov_numvfs</span><br><span class="line">echo <span class="string">&#x27;7&#x27;</span> &gt; <span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/net/</span>ens1f0<span class="regexp">/device/</span>sriov_numvfs</span><br><span class="line">echo <span class="string">&#x27;0&#x27;</span> &gt; <span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/net/</span>ens1f1<span class="regexp">/device/</span>sriov_numvfs</span><br><span class="line">echo <span class="string">&#x27;7&#x27;</span> &gt; <span class="regexp">/sys/</span><span class="keyword">class</span><span class="regexp">/net/</span>ens1f1<span class="regexp">/device/</span>sriov_numvfs</span><br><span class="line"></span><br><span class="line">chmod +x <span class="regexp">/etc/</span>rc.d/rc.local</span><br></pre></td></tr></table></figure><h3 id="5-重启服务器"><a href="#5-重启服务器" class="headerlink" title="5. 重启服务器"></a>5. 重启服务器</h3><h3 id="6-验证-VF-已经创建，并且是-up-状态"><a href="#6-验证-VF-已经创建，并且是-up-状态" class="headerlink" title="6. 验证 VF 已经创建，并且是 up 状态"></a>6. 验证 VF 已经创建，并且是 up 状态</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lspci | grep Ethernet</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">05</span>:<span class="number">00</span>.<span class="number">0</span> Ethernet controller: Intel Corporation <span class="number">82599</span>ES <span class="number">10</span>-Gigabit SFI/SFP+ Network Connection (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">00</span>.<span class="number">1</span> Ethernet controller: Intel Corporation <span class="number">82599</span>ES <span class="number">10</span>-Gigabit SFI/SFP+ Network Connection (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">0</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">1</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">2</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">3</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">4</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">5</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">6</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">10</span>.<span class="number">7</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">0</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">1</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">2</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">3</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">4</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">5</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">6</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"><span class="attribute">05</span>:<span class="number">11</span>.<span class="number">7</span> Ethernet controller: Intel Corporation <span class="number">82599</span> Ethernet Controller Virtual Function (rev <span class="number">01</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip link show ens1f0</span></span><br><span class="line"><span class="attribute">6</span>: ens<span class="number">1</span>f<span class="number">0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq state UP mode DEFAULT qlen <span class="number">1000</span></span><br><span class="line">    <span class="attribute">link</span>/ether <span class="number">14</span>:<span class="number">02</span>:ec:<span class="number">82</span>:<span class="number">96</span>:c<span class="number">0</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">0</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">1</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">2</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">3</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">4</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">5</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">6</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">7</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip link show ens1f1</span></span><br><span class="line"><span class="attribute">7</span>: ens<span class="number">1</span>f<span class="number">1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq state UP mode DEFAULT qlen <span class="number">1000</span></span><br><span class="line">    <span class="attribute">link</span>/ether <span class="number">14</span>:<span class="number">02</span>:ec:<span class="number">82</span>:<span class="number">96</span>:c<span class="number">1</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">0</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">1</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">2</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">3</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">4</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">5</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">6</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">7</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br></pre></td></tr></table></figure><h2 id="四、OpenStack-配置"><a href="#四、OpenStack-配置" class="headerlink" title="四、OpenStack 配置"></a>四、OpenStack 配置</h2><h3 id="安装-sr-iov-agent-计算节点"><a href="#安装-sr-iov-agent-计算节点" class="headerlink" title="安装 sr-iov agent(计算节点)"></a>安装 sr-iov agent(计算节点)</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum -y install openstack-neutron-sriov-nic-agent.noarch</span></span><br></pre></td></tr></table></figure><h3 id="控制节点配置"><a href="#控制节点配置" class="headerlink" title="控制节点配置"></a>控制节点配置</h3><h4 id="1-修改-nova-调度，启用-PciPassthrough-Filter"><a href="#1-修改-nova-调度，启用-PciPassthrough-Filter" class="headerlink" title="1. 修改 nova 调度，启用 PciPassthrough Filter"></a>1. 修改 nova 调度，启用 PciPassthrough Filter</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nova/nova.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">scheduler_available_filters</span>=nova.scheduler.filters.all_filters</span><br><span class="line"><span class="attr">scheduler_default_filters</span>=RetryFilter,AvailabilityZoneFilter,RamFilter,DiskFilter,ComputeFilter,ComputeCapabilitiesFilter,ImagePropertiesFilter,ServerGroupAntiAffinityFilter,ServerGroupAffinityFilter,PciPassthroughFilter</span><br></pre></td></tr></table></figure><h4 id="2-在-ML2-中加载-sriovnicswitch-mechanism-driver-并设置网络绑定"><a href="#2-在-ML2-中加载-sriovnicswitch-mechanism-driver-并设置网络绑定" class="headerlink" title="2. 在 ML2 中加载 sriovnicswitch  mechanism driver,并设置网络绑定"></a>2. 在 ML2 中加载 sriovnicswitch  mechanism driver,并设置网络绑定</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/neutron/plugins/ml2/ml2_conf.ini</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ml2]</span></span><br><span class="line"><span class="attr">type_drivers</span> = flat,vlan</span><br><span class="line">tenant_network_types =</span><br><span class="line"><span class="attr">mechanism_drivers</span> = openvswitch,sriovnicswitch</span><br><span class="line"><span class="attr">extension_drivers</span> = port_security</span><br><span class="line"></span><br><span class="line"><span class="section">[ml2_type_vlan]</span></span><br><span class="line"><span class="attr">network_vlan_ranges</span> = provider,sriov1,sriov2</span><br><span class="line"></span><br><span class="line"><span class="section">[securitygroup]</span></span><br><span class="line"><span class="attr">firewall_driver</span> = neutron.agent.firewall.NoopFirewallDriver</span><br></pre></td></tr></table></figure><h4 id="3-增加支持的-PCI-厂家的-VF-设备"><a href="#3-增加支持的-PCI-厂家的-VF-设备" class="headerlink" title="3. 增加支持的 PCI 厂家的 VF 设备"></a>3. 增加支持的 PCI 厂家的 VF 设备</h4><ul><li>查看id<figure class="highlight less"><table><tr><td class="code"><pre><span class="line"># <span class="selector-tag">lspci</span> <span class="selector-tag">-nn</span> | <span class="selector-tag">grep</span> <span class="selector-tag">-i</span> <span class="selector-tag">ethernet</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">02</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Broadcom</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">NetXtreme</span> <span class="selector-tag">BCM5719</span> <span class="selector-tag">Gigabit</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">PCIe</span> <span class="selector-attr">[14e4:1657]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">02</span>:<span class="selector-tag">00</span><span class="selector-class">.1</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Broadcom</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">NetXtreme</span> <span class="selector-tag">BCM5719</span> <span class="selector-tag">Gigabit</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">PCIe</span> <span class="selector-attr">[14e4:1657]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">02</span>:<span class="selector-tag">00</span><span class="selector-class">.2</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Broadcom</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">NetXtreme</span> <span class="selector-tag">BCM5719</span> <span class="selector-tag">Gigabit</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">PCIe</span> <span class="selector-attr">[14e4:1657]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">02</span>:<span class="selector-tag">00</span><span class="selector-class">.3</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Broadcom</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">NetXtreme</span> <span class="selector-tag">BCM5719</span> <span class="selector-tag">Gigabit</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">PCIe</span> <span class="selector-attr">[14e4:1657]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.0</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599ES</span> <span class="selector-tag">10-Gigabit</span> <span class="selector-tag">SFI</span>/<span class="selector-tag">SFP</span>+ <span class="selector-tag">Network</span> <span class="selector-tag">Connection</span> <span class="selector-attr">[8086:10fb]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">00</span><span class="selector-class">.1</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599ES</span> <span class="selector-tag">10-Gigabit</span> <span class="selector-tag">SFI</span>/<span class="selector-tag">SFP</span>+ <span class="selector-tag">Network</span> <span class="selector-tag">Connection</span> <span class="selector-attr">[8086:10fb]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.0</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.1</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.2</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.3</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.4</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.5</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.6</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">10</span><span class="selector-class">.7</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.0</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.1</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.2</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.3</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.4</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.5</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.6</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br><span class="line"><span class="selector-tag">05</span>:<span class="selector-tag">11</span><span class="selector-class">.7</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">controller</span> <span class="selector-attr">[0200]</span>: <span class="selector-tag">Intel</span> <span class="selector-tag">Corporation</span> <span class="selector-tag">82599</span> <span class="selector-tag">Ethernet</span> <span class="selector-tag">Controller</span> <span class="selector-tag">Virtual</span> <span class="selector-tag">Function</span> <span class="selector-attr">[8086:10ed]</span> (rev <span class="number">01</span>)</span><br></pre></td></tr></table></figure></li><li>配置设备ID<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/m</span>l2/ml2_conf_sriov.ini</span><br><span class="line"></span><br><span class="line">[ml2_sriov]</span><br><span class="line">supported_pci_vendor_devs = <span class="number">8086</span>:<span class="number">10</span>ed</span><br></pre></td></tr></table></figure></li></ul><h4 id="4-修改-neutron-server-启动文件-加载-ml2-conf-sriov-ini-文件"><a href="#4-修改-neutron-server-启动文件-加载-ml2-conf-sriov-ini-文件" class="headerlink" title="4. 修改 neutron-server 启动文件,加载 ml2_conf_sriov.ini 文件"></a>4. 修改 neutron-server 启动文件,加载 ml2_conf_sriov.ini 文件</h4><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/usr/</span>lib<span class="regexp">/systemd/</span>system/neutron-server.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">User=neutron</span><br><span class="line">ExecStart=<span class="regexp">/usr/</span>bin<span class="regexp">/neutron-server --config-file /u</span>sr<span class="regexp">/share/</span>neutron<span class="regexp">/neutron-dist.conf --config-dir /u</span>sr<span class="regexp">/share/</span>neutron<span class="regexp">/server --config-file /</span>etc<span class="regexp">/neutron/</span>neutron.conf --config-<span class="keyword">file</span> <span class="regexp">/etc/</span>neutron<span class="regexp">/plugin.ini --config-file /</span>etc<span class="regexp">/neutron/</span>plugins<span class="regexp">/ml2/m</span>l2_conf_sriov.ini --config-dir <span class="regexp">/etc/</span>neutron<span class="regexp">/conf.d/</span>common --config-dir <span class="regexp">/etc/</span>neutron<span class="regexp">/conf.d/</span>neutron-server --log-<span class="keyword">file</span> <span class="regexp">/var/</span>log<span class="regexp">/neutron/</span>server.log</span><br></pre></td></tr></table></figure><h4 id="5-重启服务"><a href="#5-重启服务" class="headerlink" title="5. 重启服务"></a>5. 重启服务</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl daemon-reload</span></span><br><span class="line"><span class="meta"># systemctl restart neutron-server.service</span></span><br><span class="line"><span class="meta"># systemctl restart openstack-nova-scheduler.service</span></span><br></pre></td></tr></table></figure><h3 id="计算节点配置"><a href="#计算节点配置" class="headerlink" title="计算节点配置"></a>计算节点配置</h3><h4 id="1-配置-PCI-设备白名单"><a href="#1-配置-PCI-设备白名单" class="headerlink" title="1. 配置 PCI 设备白名单"></a>1. 配置 PCI 设备白名单</h4><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /etc/nova/nova.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">[DEFAULT]</span></span><br><span class="line"><span class="attr">pci_passthrough_whitelist</span> = [&#123;<span class="string">&quot;devname&quot;</span>:<span class="string">&quot;ens1f0&quot;</span>,<span class="string">&quot;physical_network&quot;</span>:<span class="string">&quot;sriov1&quot;</span>&#125;,&#123;<span class="string">&quot;devname&quot;</span>:<span class="string">&quot;ens1f1&quot;</span>,<span class="string">&quot;physical_network&quot;</span>:<span class="string">&quot;sriov2&quot;</span>&#125;]</span><br></pre></td></tr></table></figure><h4 id="2-配置-SR-IOV-neutron-agent"><a href="#2-配置-SR-IOV-neutron-agent" class="headerlink" title="2. 配置 SR-IOV neutron agent"></a>2. 配置 SR-IOV neutron agent</h4><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># vim <span class="regexp">/etc/</span>neutron<span class="regexp">/plugins/m</span>l2/sriov_agent.ini</span><br><span class="line"></span><br><span class="line">[securitygroup]</span><br><span class="line">firewall_driver = neutron.agent.firewall.NoopFirewallDriver</span><br><span class="line"></span><br><span class="line">[sriov_nic]</span><br><span class="line">physical_device_mappings = sriov1:ens1f0,sriov2:ens1f1</span><br><span class="line">exclude_devices =</span><br></pre></td></tr></table></figure><h4 id="3-启动-重启服务"><a href="#3-启动-重启服务" class="headerlink" title="3. 启动/重启服务"></a>3. 启动/重启服务</h4><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># systemctl enable neutron-sriov-nic-agent.service</span></span><br><span class="line"><span class="meta"># systemctl start neutron-sriov-nic-agent.service</span></span><br><span class="line"><span class="meta"># systemctl restart openstack-nova-compute.service</span></span><br></pre></td></tr></table></figure><h2 id="五、测试"><a href="#五、测试" class="headerlink" title="五、测试"></a>五、测试</h2><h3 id="1-创建网络"><a href="#1-创建网络" class="headerlink" title="1. 创建网络"></a>1. 创建网络</h3><figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">创建网络</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">neutron</span> <span class="comment">net</span><span class="literal">-</span><span class="comment">create</span> --<span class="comment">provider:network_type</span> <span class="comment">vlan</span> --<span class="comment">provider:physical_network</span> <span class="comment">sriov1</span> --<span class="comment">provider:segmentation_id</span> <span class="comment">10</span> --<span class="comment">router:external</span> <span class="comment">net1</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">neutron</span> <span class="comment">net</span><span class="literal">-</span><span class="comment">create</span> --<span class="comment">provider:network_type</span> <span class="comment">vlan</span> --<span class="comment">provider:physical_network</span> <span class="comment">sriov2</span> --<span class="comment">provider:segmentation_id</span> <span class="comment">20</span> --<span class="comment">router:external</span> <span class="comment">net2</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">创建子网(禁用DHCP)</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">neutron</span> <span class="comment">subnet</span><span class="literal">-</span><span class="comment">create</span> --<span class="comment">name</span> <span class="comment">sriov1</span><span class="literal">-</span><span class="comment">net</span> --<span class="comment">disable</span><span class="literal">-</span><span class="comment">dhcp</span> --<span class="comment">ip</span><span class="literal">-</span><span class="comment">version</span> <span class="comment">4</span> <span class="comment">net1</span> <span class="comment">10</span><span class="string">.</span><span class="comment">0</span><span class="string">.</span><span class="comment">1</span><span class="string">.</span><span class="comment">0/24</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">neutron</span> <span class="comment">subnet</span><span class="literal">-</span><span class="comment">create</span> --<span class="comment">name</span> <span class="comment">sriov2</span><span class="literal">-</span><span class="comment">net</span> --<span class="comment">disable</span><span class="literal">-</span><span class="comment">dhcp</span> --<span class="comment">ip</span><span class="literal">-</span><span class="comment">version</span> <span class="comment">4</span> <span class="comment">net2</span> <span class="comment">10</span><span class="string">.</span><span class="comment">0</span><span class="string">.</span><span class="comment">2</span><span class="string">.</span><span class="comment">0/24</span></span><br></pre></td></tr></table></figure><h3 id="2-创建-port"><a href="#2-创建-port" class="headerlink" title="2. 创建 port"></a>2. 创建 port</h3><figure class="highlight elm"><table><tr><td class="code"><pre><span class="line"># neutron <span class="keyword">port</span>-create net1 <span class="comment">--binding:vnic-type direct</span></span><br><span class="line"># neutron <span class="keyword">port</span>-create net2 <span class="comment">--binding:vnic-type direct</span></span><br></pre></td></tr></table></figure><h3 id="3-创建虚拟机"><a href="#3-创建虚拟机" class="headerlink" title="3. 创建虚拟机"></a>3. 创建虚拟机</h3><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="comment"># neutron port-list</span></span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">------</span>+<span class="params">-------------------</span>+<span class="params">---------------------------------------------------------------------------------</span>+</span><br><span class="line">| id                                   | name | mac_address       | fixed_ips                                                                       |</span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">------</span>+<span class="params">-------------------</span>+<span class="params">---------------------------------------------------------------------------------</span>+</span><br><span class="line">| ba446152-bd45-4a38-9947-1d539e538a68 |      | fa<span class="function">:16</span><span class="function">:3e</span><span class="function">:42</span><span class="function">:6b</span><span class="function">:fd</span> | &#123;<span class="string">&quot;subnet_id&quot;</span>: <span class="string">&quot;04ea17b5-08da-41cc-8114-e0781a1f8041&quot;</span>, <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;10.0.1.3&quot;</span>&#125; |</span><br><span class="line">| bf8a7655-ac16-4dce-bb12-54efd2dd0967 |      | fa<span class="function">:16</span><span class="function">:3e</span><span class="function">:77</span><span class="function">:9f</span><span class="function">:8a</span> | &#123;<span class="string">&quot;subnet_id&quot;</span>: <span class="string">&quot;6612bf80-d682-474f-886e-93029a4a0964&quot;</span>, <span class="string">&quot;ip_address&quot;</span>: <span class="string">&quot;10.0.2.3&quot;</span>&#125; |</span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">------</span>+<span class="params">-------------------</span>+<span class="params">---------------------------------------------------------------------------------</span>+</span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack server create --image rhel-server-7.5-x86_64-kvm --flavor 6 --nic port-id=ba446152-bd45-4a38-9947-1d539e538a68 --nic port-id=bf8a7655-ac16-4dce-bb12-54efd2dd0967 --config-drive True test</span></span><br></pre></td></tr></table></figure><h3 id="4-查看虚拟机网卡"><a href="#4-查看虚拟机网卡" class="headerlink" title="4. 查看虚拟机网卡"></a>4. 查看虚拟机网卡</h3><ul><li>速率<br><img data-src="/images/uploads/2018/06/ethtool.png" alt="网络速率"></li><li>型号<br><img data-src="/images/uploads/2018/06/ethernet.png" alt="网卡型号"></li></ul><h3 id="5-查看-VF"><a href="#5-查看-VF" class="headerlink" title="5. 查看 VF"></a>5. 查看 VF</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ip link show ens1f0</span></span><br><span class="line"><span class="attribute">6</span>: ens<span class="number">1</span>f<span class="number">0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq state UP mode DEFAULT qlen <span class="number">1000</span></span><br><span class="line">    <span class="attribute">link</span>/ether <span class="number">14</span>:<span class="number">02</span>:ec:<span class="number">82</span>:<span class="number">96</span>:c<span class="number">0</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">0</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">1</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">2</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">3</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">4</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">5</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">6</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">7</span> MAC fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">42</span>:<span class="number">6</span>b:fd, vlan <span class="number">10</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip link show ens1f1</span></span><br><span class="line"><span class="attribute">7</span>: ens<span class="number">1</span>f<span class="number">1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq state UP mode DEFAULT qlen <span class="number">1000</span></span><br><span class="line">    <span class="attribute">link</span>/ether <span class="number">14</span>:<span class="number">02</span>:ec:<span class="number">82</span>:<span class="number">96</span>:c<span class="number">1</span> brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">0</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">1</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">2</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">3</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">4</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">5</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">6</span> MAC <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br><span class="line">    <span class="attribute">vf</span> <span class="number">7</span> MAC fa:<span class="number">16</span>:<span class="number">3</span>e:<span class="number">77</span>:<span class="number">9</span>f:<span class="number">8</span>a, vlan <span class="number">20</span>, spoof checking <span class="literal">on</span>, link-state auto</span><br></pre></td></tr></table></figure><hr><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://wiki.openstack.org/wiki/SR-IOV-Passthrough-For-Networking">SR-IOV-Passthrough-For-Networking</a><br><a href="https://docs.openstack.org/ocata/networking-guide/config-sriov.html">OpenStack Networking Guide</a><br><a href="http://www.cnblogs.com/wanstack/p/8757379.html">OpenStack Mitaka Neutron SR-IOV配置</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;关于 SR-IOV 本文就不再介绍了,具体可以查看 &lt;a href=&quot;https://www.intel.com/content/www/us/en/embedded/products/networking/82599-sr-iov-driver-companion-guide.html&quot;&gt;Intel® 82599 SR-IOV Driver Companion Guide&lt;/a&gt;。&lt;/p&gt;
&lt;h2 id=&quot;一、系统环境&quot;&gt;&lt;a href=&quot;#一、系统环境&quot; class=&quot;headerlink&quot; title=&quot;一、系统环境&quot;&gt;&lt;/a&gt;一、系统环境&lt;/h2&gt;&lt;p&gt;操作系统: RHEL 7.2&lt;br&gt;OpenStack版本: OpenStack Mitaka Allinone&lt;br&gt;网卡型号: Intel Corporation 82599ES&lt;br&gt;SR-IVO网卡名: ens1f0, ens1f0&lt;/p&gt;
&lt;h2 id=&quot;二、服务器配置&quot;&gt;&lt;a href=&quot;#二、服务器配置&quot; class=&quot;headerlink&quot; title=&quot;二、服务器配置&quot;&gt;&lt;/a&gt;二、服务器配置&lt;/h2&gt;&lt;p&gt;在服务器 BIOS 中开启 VT-d 和 SR-IOV&lt;/p&gt;
&lt;h2 id=&quot;三、操作系统配置&quot;&gt;&lt;a href=&quot;#三、操作系统配置&quot; class=&quot;headerlink&quot; title=&quot;三、操作系统配置&quot;&gt;&lt;/a&gt;三、操作系统配置&lt;/h2&gt;&lt;h3 id=&quot;1-编辑-etc-default-grub-文件-加入以下内容&quot;&gt;&lt;a href=&quot;#1-编辑-etc-default-grub-文件-加入以下内容&quot; class=&quot;headerlink&quot; title=&quot;1. 编辑 /etc/default/grub 文件,加入以下内容&quot;&gt;&lt;/a&gt;1. 编辑 /etc/default/grub 文件,加入以下内容&lt;/h3&gt;&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# vim /etc/default/grub&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_TIMEOUT=5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_DISTRIBUTOR=&amp;quot;$(sed &amp;#x27;s, release .*$,,g&amp;#x27; /etc/system-release)&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_DEFAULT=saved&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_DISABLE_SUBMENU=true&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_TERMINAL_OUTPUT=&amp;quot;console&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-GRUB_CMDLINE_LINUX=&amp;quot;rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+GRUB_CMDLINE_LINUX=&amp;quot;rd.lvm.lv=rhel/root rd.lvm.lv=rhel/swap rhgb quiet intel_iommu=on&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;GRUB_DISABLE_RECOVERY=&amp;quot;true&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;需要说明的是: ixgbe.max_vfs 参数已经废弃，故没有加入到内核参数中。&lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="sr-iov" scheme="https://www.sunmite.com/tags/sr-iov/"/>
    
  </entry>
  
  <entry>
    <title>openstack 无法连接 Connection aborted , BadStatusLine</title>
    <link href="https://www.sunmite.com/openstack/openstack-connection-aborted.html"/>
    <id>https://www.sunmite.com/openstack/openstack-connection-aborted.html</id>
    <published>2018-05-29T18:37:36.000Z</published>
    <updated>2021-01-25T02:17:02.343Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-发现问题"><a href="#1-发现问题" class="headerlink" title="1. 发现问题"></a>1. 发现问题</h2><p>发现某个节点无法查询网络，继而发现所有的客户端都无法正确查询，而且错误相同</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">cinder 服务无法访问</span><br><span class="line">[root@controller01 ~]<span class="comment"># cinder list</span></span><br><span class="line">ERROR: Unable to establish connection to http:<span class="regexp">//</span>nt-controller:<span class="number">8776</span><span class="regexp">/v2/</span><span class="number">364307</span>d25ca8465daa7982dafc625f05<span class="regexp">/volumes/</span>detail: (<span class="string">&#x27;Connection aborted.&#x27;</span>, BadStatusLine(<span class="string">&quot;&#x27;&#x27;&quot;</span>,))</span><br><span class="line"></span><br><span class="line">nova服务无法访问</span><br><span class="line">[root@controller01 ~]<span class="comment"># nova list</span></span><br><span class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/novaclient/</span>client.py:<span class="number">278</span>: UserWarning: The <span class="string">&#x27;tenant_id&#x27;</span> argument is deprecated <span class="keyword">in</span> Ocata and its use may result <span class="keyword">in</span> errors <span class="keyword">in</span> future releases. As <span class="string">&#x27;project_id&#x27;</span> is provided, the <span class="string">&#x27;tenant_id&#x27;</span> argument will be ignored.</span><br><span class="line">  warnings.warn(msg)</span><br><span class="line">ERROR (ConnectFailure): Unable to establish connection to http:<span class="regexp">//</span>nt-controller:<span class="number">8774</span><span class="regexp">/v2.1/</span><span class="number">364307</span>d25ca8465daa7982dafc625f05<span class="regexp">/servers/</span>detail: (<span class="string">&#x27;Connection aborted.&#x27;</span>, BadStatusLine(<span class="string">&quot;&#x27;&#x27;&quot;</span>,))</span><br></pre></td></tr></table></figure><h2 id="2-问题排查"><a href="#2-问题排查" class="headerlink" title="2. 问题排查"></a>2. 问题排查</h2><h3 id="手动-telnet-端口可以连接"><a href="#手动-telnet-端口可以连接" class="headerlink" title="手动 telnet 端口可以连接"></a>手动 telnet 端口可以连接</h3><figure class="highlight livescript"><table><tr><td class="code"><pre><span class="line">[root@controller01 ~]<span class="comment"># telnet nt-controller 8774</span></span><br><span class="line">Trying <span class="number">192.168</span>.<span class="number">105.253</span>...</span><br><span class="line">Connected <span class="keyword">to</span> nt-controller.</span><br><span class="line">Escape character <span class="keyword">is</span> <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Connection closed <span class="keyword">by</span> foreign host.</span><br></pre></td></tr></table></figure><h3 id="conductor-和-api-服务有无法连接数据库的错误"><a href="#conductor-和-api-服务有无法连接数据库的错误" class="headerlink" title="conductor 和 api 服务有无法连接数据库的错误"></a>conductor 和 api 服务有无法连接数据库的错误</h3><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db     return self.dbapi.connect(*cargs, **cparams)</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db   File <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/__init__.py&quot;</span>, line <span class="number">90</span>, in Connect</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db     return Connection(*args, **kwargs)</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db   File <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, line <span class="number">694</span>, in __init__</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db     self.connect()</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db   File <span class="string">&quot;/usr/lib/python2.7/site-packages/pymysql/connections.py&quot;</span>, line <span class="number">947</span>, in connect</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db     raise exc</span><br><span class="line"><span class="attribute">2018</span>-<span class="number">05</span>-<span class="number">30</span> <span class="number">02</span>:<span class="number">16</span>:<span class="number">08</span>.<span class="number">609</span> <span class="number">29270</span> ERROR nova.servicegroup.drivers.db DBConnectionError: (pymysql.err.OperationalError) (<span class="number">2003</span>, <span class="string">&quot;Can&#x27;t connect to MySQL server on &#x27;nt-controller&#x27; ([Errno 111] ECONNREFUSED)&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="查看数据库集群状态-集群正常"><a href="#查看数据库集群状态-集群正常" class="headerlink" title="查看数据库集群状态(集群正常)"></a>查看数据库集群状态(集群正常)</h3><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW STATUS LIKE <span class="emphasis">&#x27;wsrep_cluster_size&#x27;</span>;</span><br><span class="line"><span class="code">+--------------------+</span>-------+</span><br><span class="line">| Variable_name      | Value |</span><br><span class="line"><span class="code">+--------------------+</span>-------+</span><br><span class="line">| wsrep_cluster_size | 3     |</span><br><span class="line"><span class="code">+--------------------+</span>-------+</span><br></pre></td></tr></table></figure><h2 id="3-问题解决"><a href="#3-问题解决" class="headerlink" title="3. 问题解决"></a>3. 问题解决</h2><p>全部服务都无法连接，而keystone服务又是正常（鉴权服务不在本地），数据库服务也正常，同时和这么多服务有关联的就是 haproxy 了，手动重启 haproxy 后问题解决（haproxy监听端口正常，可能发生了crash）。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;1-发现问题&quot;&gt;&lt;a href=&quot;#1-发现问题&quot; class=&quot;headerlink&quot; title=&quot;1. 发现问题&quot;&gt;&lt;/a&gt;1. 发现问题&lt;/h2&gt;&lt;p&gt;发现某个节点无法查询网络，继而发现所有的客户端都无法正确查询，而且错误相同&lt;/p&gt;
&lt;figure cl</summary>
      
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="haproxy" scheme="https://www.sunmite.com/tags/haproxy/"/>
    
  </entry>
  
  <entry>
    <title>切换用户报错 su Module is unknown</title>
    <link href="https://www.sunmite.com/linux/su-module-is-unknown.html"/>
    <id>https://www.sunmite.com/linux/su-module-is-unknown.html</id>
    <published>2018-04-16T09:13:03.000Z</published>
    <updated>2021-01-25T02:17:02.352Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-发现问题"><a href="#1-发现问题" class="headerlink" title="1. 发现问题"></a>1. 发现问题</h3><p>安全加固后的虚拟机使用普通用户登陆，然后切换到 root 用户的时候有如下报错</p><figure class="highlight avrasm"><table><tr><td class="code"><pre><span class="line">$ su root</span><br><span class="line"><span class="symbol">Password:</span> </span><br><span class="line"><span class="symbol">su:</span> Module is unknown</span><br></pre></td></tr></table></figure><h3 id="2-查找错误"><a href="#2-查找错误" class="headerlink" title="2. 查找错误"></a>2. 查找错误</h3><p>查看 /var/log/secure 文件有如下错误, 找不到库文件 pam_tally.so</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim /var/log/secure</span></span><br><span class="line"><span class="attribute">Apr</span> <span class="number">16</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">32</span> compute<span class="number">01</span> sshd[<span class="number">21311</span>]: pam_unix(sshd:session): session opened for user vmuser by (uid=<span class="number">0</span>)</span><br><span class="line"><span class="attribute">Apr</span> <span class="number">16</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">34</span> compute<span class="number">01</span> su: PAM unable to dlopen(/usr/lib<span class="number">64</span>/security/pam_tally.so): /usr/lib<span class="number">64</span>/security/pam_tally.so: cannot open shared object file: No such file or directory</span><br><span class="line"><span class="attribute">Apr</span> <span class="number">16</span> <span class="number">16</span>:<span class="number">45</span>:<span class="number">34</span> compute<span class="number">01</span> su: PAM adding faulty module: /usr/lib<span class="number">64</span>/security/pam_tally.so</span><br></pre></td></tr></table></figure><h3 id="3-解决办法"><a href="#3-解决办法" class="headerlink" title="3. 解决办法"></a>3. 解决办法</h3><p>把 pam_tally2.so 链接到 pam_tally.so</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># ln -s <span class="regexp">/lib64/</span>security<span class="regexp">/pam_tally2.so /</span>lib64<span class="regexp">/security/</span>pam_tally.so</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-发现问题&quot;&gt;&lt;a href=&quot;#1-发现问题&quot; class=&quot;headerlink&quot; title=&quot;1. 发现问题&quot;&gt;&lt;/a&gt;1. 发现问题&lt;/h3&gt;&lt;p&gt;安全加固后的虚拟机使用普通用户登陆，然后切换到 root 用户的时候有如下报错&lt;/p&gt;
&lt;figure </summary>
      
    
    
    
    <category term="linux" scheme="https://www.sunmite.com/categories/linux/"/>
    
    
    <category term="linux" scheme="https://www.sunmite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Project-Zun(容器管理)</title>
    <link href="https://www.sunmite.com/openstack/openstack-projext-zun.html"/>
    <id>https://www.sunmite.com/openstack/openstack-projext-zun.html</id>
    <published>2018-03-07T08:39:58.000Z</published>
    <updated>2021-01-25T02:17:02.335Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Zun-容器服务简介"><a href="#Zun-容器服务简介" class="headerlink" title="Zun 容器服务简介"></a>Zun 容器服务简介</h2><p>Zun 允许用户无需管理服务器或集群即可快速启动和运行容器。它通过与 Neutron 、Cinder、Keystone 和其他核心 OpenStack 服务集成，无缝地将先进的企业网络、存储和身份验证功能添加到容器中。<br>Zun目标在于解决 <a href="https://sunmite.com/docker/openstack-use-nova-docker-driver.html">Nova Docker driver方案</a>存在的问题，独立于 Nova 之外实现 Docker 部署调度框架，自身实现与 Glance、Neutron、Cinder等组件的集成，但并不实现对容器编排引擎（Container Orchestration Engines COE）的部署调度。Nova-docker通过Nova API访问容器，而Zun不受Nova API的限制。<br>Zun和Magnum的差异在于Zun目标是提供管理容器的API，而Magnum提供部署和管理容器编排引擎（COE）的API。Zun将容器作为Openstack管理的资源，为用户提供了创建和管理这些容器的接口。被Zun管理的容器和其他Openstack资源能够良好的集成在一起，例如Neutron网络和Cinder卷。用户使用统一的、简化的API接口来管理容器，而不需要关心不同容器技术的差异。<br>Zun不准备实现COE提供的很多先进的功能（例如容器保活、负载均衡等），而是提供基本的容器操作（CRUD），并和Openstack紧密集成。  </p><span id="more"></span><h2 id="使用-devstack-安装-Zun"><a href="#使用-devstack-安装-Zun" class="headerlink" title="使用 devstack 安装 Zun"></a>使用 devstack 安装 Zun</h2><p>local.conf 添加如下内容，运行 ./stack.sh</p><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">$ vim local.conf</span><br><span class="line"></span><br><span class="line">……</span><br><span class="line"><span class="comment">#Enable Zun plugin</span></span><br><span class="line">enable_plugin devstack-plugin-container http:<span class="regexp">//gi</span>t.trystack.cn<span class="regexp">/openstack/</span>devstack-plugin-container  <span class="comment">#安装docker，如果已经安装docker，可以忽略</span></span><br><span class="line">enable_plugin zun http:<span class="regexp">//gi</span>t.trystack.cn<span class="regexp">/openstack/</span>zun</span><br><span class="line">enable_plugin zun-ui http:<span class="regexp">//gi</span>t.trystack.cn<span class="regexp">/openstack/</span>zun-ui</span><br><span class="line">enable_plugin kuryr-libnetwork http:<span class="regexp">//gi</span>t.trystack.cn<span class="regexp">/openstack/</span>kuryr-libnetwork</span><br><span class="line">KURYR_CAPABILITY_SCOPE=local          <span class="comment">#单节点安装使用local，多节点要改为global</span></span><br><span class="line">KURYR_ETCD_PORT=<span class="number">2379</span></span><br></pre></td></tr></table></figure><h2 id="Zun-测试"><a href="#Zun-测试" class="headerlink" title="Zun 测试"></a>Zun 测试</h2><h3 id="1-Zun-ui-预览"><a href="#1-Zun-ui-预览" class="headerlink" title="1. Zun-ui 预览"></a>1. Zun-ui 预览</h3><p>创建 Container 的页面和创建虚拟机的页面类似。可以选择来自 DockerHub 或者 Glance 的镜像，可以选择网络、端口、安全组等，支持容器特有的一些功能如限制cpu和内存的使用<br><img data-src="/images/uploads/2018/03/create-container1.png" alt="image"><br><img data-src="/images/uploads/2018/03/create-container1.png" alt="image"></p><h3 id="2-创建容器"><a href="#2-创建容器" class="headerlink" title="2. 创建容器"></a>2. 创建容器</h3><p>考虑到 DockerHub 的龟速，先把镜像拉取到本地</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># docker pull cirros</span></span><br></pre></td></tr></table></figure><p>使用命令行创建一个 cirros 的容器</p><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">$ openstack appcontainer <span class="builtin-name">run</span> --name cirros --net <span class="attribute">network</span>=<span class="variable">$NET_ID</span> cirros</span><br></pre></td></tr></table></figure><h3 id="3-查看容器"><a href="#3-查看容器" class="headerlink" title="3. 查看容器"></a>3. 查看容器</h3><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openstack appcontainer list</span></span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">--------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">-----------</span>+<span class="params">-------</span>+</span><br><span class="line">| uuid                                 | name   | image  | status  | task_state | addresses | ports |</span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">--------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">-----------</span>+<span class="params">-------</span>+</span><br><span class="line">| 61dfa221-826b-496c-963a-e5222ca054a3 | cirros | cirros | Running | None       | 10.0.0.4  | []    |</span><br><span class="line">+<span class="params">--------------------------------------</span>+<span class="params">--------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">------------</span>+<span class="params">-----------</span>+<span class="params">-------</span>+</span><br></pre></td></tr></table></figure><h3 id="4-进入容器查看网络连接"><a href="#4-进入容器查看网络连接" class="headerlink" title="4. 进入容器查看网络连接"></a>4. 进入容器查看网络连接</h3><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment"># openstack appcontainer exec --interactive cirros /bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># openstack appcontainer exec --interactive cirros /bin/sh</span></span><br><span class="line">connected <span class="keyword">to</span> container <span class="string">&quot;cirros&quot;</span></span><br><span class="line">type ~. <span class="keyword">to</span> disconnect</span><br><span class="line">/ #<span class="built_in"> ping </span>10.0.0.5                 # 10.0.0.5 为同一个网络的虚拟机，非容器</span><br><span class="line">PING 10.0.0.5 (10.0.0.5): 56 data bytes</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.0.5: <span class="attribute">seq</span>=0 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=5.934 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.0.5: <span class="attribute">seq</span>=1 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.969 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.0.5: <span class="attribute">seq</span>=2 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.855 ms</span><br><span class="line">64 bytes <span class="keyword">from</span> 10.0.0.5: <span class="attribute">seq</span>=3 <span class="attribute">ttl</span>=64 <span class="attribute">time</span>=0.791 ms</span><br><span class="line">^C</span><br><span class="line">--- 10.0.0.5<span class="built_in"> ping </span>statistics ---</span><br><span class="line">4 packets transmitted, 4 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.791/2.137/5.934 ms</span><br></pre></td></tr></table></figure><h3 id="5-dashboard上面的容器详情"><a href="#5-dashboard上面的容器详情" class="headerlink" title="5. dashboard上面的容器详情"></a>5. dashboard上面的容器详情</h3><p>在 dashboard 上面也可以查看容器的详细信息和 log 以及控制台，查看控制台需要容器以 interactive 模式启动<br><img data-src="/images/uploads/2018/03/details.png" alt="image"><br>对容器的一些基本操作：更新、停止、重启、暂停、执行命令、删除等操作<br><img data-src="/images/uploads/2018/03/command.png" alt="image"><br><img data-src="/images/uploads/2018/03/command1.png" alt="image"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Zun 的操作基本和 docker 的操作一致，使用起来和原生docker容器没有区别。但是现在可以和 Openstack 的资源良好的结合在一起，统一管理，提高的 OpenStack容器管理的灵活度，还是很令人期待的。</p><h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="1-zun-compute-警告信息"><a href="#1-zun-compute-警告信息" class="headerlink" title="1. zun-compute 警告信息"></a>1. zun-compute 警告信息</h3><p>查看 <a href="mailto:&#x64;&#x65;&#118;&#x73;&#x74;&#97;&#x63;&#107;&#64;&#x7a;&#117;&#110;&#x2d;&#x63;&#111;&#x6d;&#x70;&#117;&#x74;&#x65;&#x2e;&#x73;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;">&#x64;&#x65;&#118;&#x73;&#x74;&#97;&#x63;&#107;&#64;&#x7a;&#117;&#110;&#x2d;&#x63;&#111;&#x6d;&#x70;&#117;&#x74;&#x65;&#x2e;&#x73;&#x65;&#x72;&#118;&#x69;&#x63;&#x65;</a> 服务有如下警告：</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">$ journalctl -f --unit devstack@zun-compute.service</span><br><span class="line"></span><br><span class="line">Mar <span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28</span> queens.domian.tld zun-compute[<span class="number">992</span>]: <span class="number">2018</span>-<span class="number">03</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28.172</span> DEBUG docker.auth [-] Trying paths: [<span class="string">&#x27;/opt/stack/.docker/config.json&#x27;</span>, <span class="string">&#x27;/opt/stack/.dockercfg&#x27;</span>] <span class="keyword">from</span> (pid=<span class="number">992</span>) find_config_file <span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/docker/</span>auth.py:<span class="number">234</span></span><br><span class="line">Mar <span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28</span> queens.domian.tld zun-compute[<span class="number">992</span>]: <span class="number">2018</span>-<span class="number">03</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28.173</span> DEBUG docker.auth [-] No config <span class="keyword">file</span> found <span class="keyword">from</span> (pid=<span class="number">992</span>) find_config_file <span class="regexp">/usr/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/docker/</span>auth.py:<span class="number">241</span></span><br><span class="line">Mar <span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28</span> queens.domian.tld zun-compute[<span class="number">992</span>]: <span class="number">2018</span>-<span class="number">03</span>-<span class="number">07</span> <span class="number">13</span>:<span class="number">51</span>:<span class="number">28.208</span> DEBUG zun.compute.manager [-] Complete syncing container states. <span class="keyword">from</span> (pid=<span class="number">992</span>) sync_container_state <span class="regexp">/opt/</span>stack<span class="regexp">/zun/</span>zun<span class="regexp">/compute/m</span>anager.py:<span class="number">951</span></span><br></pre></td></tr></table></figure><p>.docker/config.json 和 .dockercfg 是 docker login 成功后创建的文件。因为 Zun 可以直接从 DockerHub 拉取镜像，我们需要提供认证信息。</p><figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">$ docker login</span><br><span class="line">Login with your Docker ID <span class="keyword">to</span> push and pull images <span class="keyword">from</span> Docker Hub. If you don&#x27;t have a Docker ID, head over <span class="keyword">to</span> https://hub.docker.com <span class="keyword">to</span> create one.</span><br><span class="line">Username: lovelonger           <span class="comment">#这里比较坑，只能写用户名，写邮箱一直登录失败</span></span><br><span class="line">Password: </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure><h3 id="2-端口映射的问题"><a href="#2-端口映射的问题" class="headerlink" title="2. 端口映射的问题"></a>2. 端口映射的问题</h3><p>暂时不知道创建容器的时候怎么添加端口映射，如果容器创建在私有网络上面，上面的服务外部无法访问。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Zun-容器服务简介&quot;&gt;&lt;a href=&quot;#Zun-容器服务简介&quot; class=&quot;headerlink&quot; title=&quot;Zun 容器服务简介&quot;&gt;&lt;/a&gt;Zun 容器服务简介&lt;/h2&gt;&lt;p&gt;Zun 允许用户无需管理服务器或集群即可快速启动和运行容器。它通过与 Neutron 、Cinder、Keystone 和其他核心 OpenStack 服务集成，无缝地将先进的企业网络、存储和身份验证功能添加到容器中。&lt;br&gt;Zun目标在于解决 &lt;a href=&quot;https://sunmite.com/docker/openstack-use-nova-docker-driver.html&quot;&gt;Nova Docker driver方案&lt;/a&gt;存在的问题，独立于 Nova 之外实现 Docker 部署调度框架，自身实现与 Glance、Neutron、Cinder等组件的集成，但并不实现对容器编排引擎（Container Orchestration Engines COE）的部署调度。Nova-docker通过Nova API访问容器，而Zun不受Nova API的限制。&lt;br&gt;Zun和Magnum的差异在于Zun目标是提供管理容器的API，而Magnum提供部署和管理容器编排引擎（COE）的API。Zun将容器作为Openstack管理的资源，为用户提供了创建和管理这些容器的接口。被Zun管理的容器和其他Openstack资源能够良好的集成在一起，例如Neutron网络和Cinder卷。用户使用统一的、简化的API接口来管理容器，而不需要关心不同容器技术的差异。&lt;br&gt;Zun不准备实现COE提供的很多先进的功能（例如容器保活、负载均衡等），而是提供基本的容器操作（CRUD），并和Openstack紧密集成。  &lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="docker" scheme="https://www.sunmite.com/tags/docker/"/>
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="zun" scheme="https://www.sunmite.com/tags/zun/"/>
    
  </entry>
  
  <entry>
    <title>OpenStack Queens Cinder Multi-Attach 功能</title>
    <link href="https://www.sunmite.com/openstack/cinder-multi-attch.html"/>
    <id>https://www.sunmite.com/openstack/cinder-multi-attch.html</id>
    <published>2018-03-06T07:42:27.000Z</published>
    <updated>2021-01-25T02:17:02.335Z</updated>
    
    <content type="html"><![CDATA[<p>OpenStack Queens 平台于2月28日正式发布，这是该开源云平台的第17版。OpenStack Queens 增加了多项新功能，也优化增强了多项旧功能，包括虚拟 GPU（ vGPU ）支持和容器集成的改进。几个新项目也在 OpenStack Queens 这一里程碑中露面，包括提供管理硬件和软件加速资源框架的Cyborg 。<br>Queens 发布了一些强大的面向企业的功能，其中最引人注目的是 Cinder 中的 Multi-Attach 功能。Cinder Multi-Attach 使运维者能够将相同的Cinder 卷加载到多个 VM 中。如果一个节点关闭，另一个节点能够接管并访问该卷。</p><span id="more"></span><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1-安装-OpenStack-Queens"><a href="#1-安装-OpenStack-Queens" class="headerlink" title="1. 安装 OpenStack Queens"></a>1. 安装 OpenStack Queens</h3><p>使用 devstack 安装 openstack (stable/queens)，这里不再赘述。</p><h3 id="2-Cinder-需要满足的条件"><a href="#2-Cinder-需要满足的条件" class="headerlink" title="2. Cinder 需要满足的条件"></a>2. Cinder 需要满足的条件</h3><p>Multi-Attach 功能在 cinder microversion &gt;= 3.50 版本可用，查看 stable/queens 的cinder版本</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cinder --version</span></span><br><span class="line"><span class="attribute">3</span>.<span class="number">5</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure><h3 id="3-Nova-需要满足的条件"><a href="#3-Nova-需要满足的条件" class="headerlink" title="3. Nova 需要满足的条件"></a>3. Nova 需要满足的条件</h3><ul><li>nova api microversion版本高于或等于2.60<figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"># nova version-list</span><br><span class="line">Client supported API versions:</span><br><span class="line">Minimum version 2.1</span><br><span class="line">Maximum version 2.53</span><br><span class="line"></span><br><span class="line">Server supported API versions:</span><br><span class="line"><span class="code">+------+</span>-----------<span class="code">+----------------------+</span>-------------<span class="code">+---------+</span></span><br><span class="line">| Id   | Status    | Updated              | Min Version | Version |</span><br><span class="line"><span class="code">+------+</span>-----------<span class="code">+----------------------+</span>-------------<span class="code">+---------+</span></span><br><span class="line">| v2.0 | SUPPORTED | 2011-01-21T11:33:21Z |             |         |</span><br><span class="line">| v2.1 | CURRENT   | 2013-07-23T11:33:21Z | 2.1         | 2.60    |</span><br><span class="line"><span class="code">+------+</span>-----------<span class="code">+----------------------+</span>-------------<span class="code">+---------+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>Cinder 12.0.0(Queens)或更高</li><li>nova-compute 服务必须运行的是 Queens release的代码版本，hypervisor 的驱动必须支持挂载卷设备到多个虚拟机。<figure class="highlight ldif"><table><tr><td class="code"><pre><span class="line">支持的驱动</span><br><span class="line"><span class="attribute">Libvirt KVM (s390x)</span>: complete</span><br><span class="line"><span class="attribute">Libvirt Virtuozzo CT</span>: missing</span><br><span class="line"><span class="attribute">Libvirt KVM (ppc64)</span>: complete</span><br><span class="line"><span class="attribute">Libvirt KVM (x86)</span>: complete</span><br><span class="line"><span class="attribute">Libvirt KVM (aarch64)</span>: unknown</span><br><span class="line"><span class="attribute">Libvirt LXC</span>: missing</span><br><span class="line"><span class="attribute">Hyper-V</span>: missing</span><br><span class="line"><span class="attribute">Libvirt QEMU (x86)</span>: complete</span><br><span class="line"><span class="attribute">XenServer</span>: missing</span><br><span class="line"><span class="attribute">Libvirt Virtuozzo VM</span>: complete</span><br><span class="line"><span class="attribute">Libvirt Xen</span>: complete</span><br><span class="line"><span class="attribute">PowerVM</span>: missing</span><br><span class="line"><span class="attribute">Ironic</span>: missing</span><br><span class="line"><span class="attribute">VMware vCenter</span>: missing</span><br></pre></td></tr></table></figure></li><li>当使用 libvirt 驱动的时候需要满足 libvirt &gt;= 3.10 或者 qemu &lt; 2.10<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># virsh --version</span></span><br><span class="line"><span class="attribute">3</span>.<span class="number">2</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu-img --version</span></span><br><span class="line"><span class="attribute">qemu</span>-img version <span class="number">2</span>.<span class="number">9</span>.<span class="number">0</span>(qemu-kvm-ev-<span class="number">2</span>.<span class="number">9</span>.<span class="number">0</span>-<span class="number">16</span>.el<span class="number">7</span>_<span class="number">4</span>.<span class="number">13</span>.<span class="number">1</span>)</span><br><span class="line"><span class="attribute">Copyright</span> (c) <span class="number">2003</span>-<span class="number">2017</span> Fabrice Bellard and the QEMU Project developers</span><br></pre></td></tr></table></figure></li><li>不支持 Swapping 正在使用中的 multiattach 卷</li></ul><h3 id="4-Novaclient-版本-gt-9-1-1"><a href="#4-Novaclient-版本-gt-9-1-1" class="headerlink" title="4. Novaclient 版本 &gt; 9.1.1"></a>4. Novaclient 版本 &gt; 9.1.1</h3><p>== 测试中发现 novaclient 版本过低，无法调用 nova api 2.6版本，升级novaclient ==</p><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># pip install -U python-novaclient</span></span><br></pre></td></tr></table></figure><p>综上，本地环境满足上述要求，可以进行 Multi-Attach 测试。</p><h2 id="Multi-Attach-测试"><a href="#Multi-Attach-测试" class="headerlink" title="Multi-Attach 测试"></a>Multi-Attach 测试</h2><h3 id="1-创建-multiattach-的卷类型"><a href="#1-创建-multiattach-的卷类型" class="headerlink" title="1. 创建 multiattach 的卷类型"></a>1. 创建 multiattach 的卷类型</h3><figure class="highlight n1ql"><table><tr><td class="code"><pre><span class="line"># cinder type-<span class="keyword">create</span> multiattach</span><br><span class="line"># cinder <span class="built_in">type</span>-<span class="keyword">key</span> multiattach <span class="keyword">set</span> multiattach=<span class="string">&quot;&lt;is&gt; True&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-创建一个-10G-大小multiattach-卷"><a href="#2-创建一个-10G-大小multiattach-卷" class="headerlink" title="2. 创建一个 10G 大小multiattach 卷"></a>2. 创建一个 10G 大小multiattach 卷</h3><figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="meta"># cinder create 10 --name multiattach-volume --volume-type <span class="meta-string">&lt;volume_type_uuid&gt;</span></span></span><br></pre></td></tr></table></figure><h3 id="3-创建两个测试虚拟机"><a href="#3-创建两个测试虚拟机" class="headerlink" title="3. 创建两个测试虚拟机"></a>3. 创建两个测试虚拟机</h3><figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span> <span class="comment">openstack</span> <span class="comment">server</span> <span class="comment">create</span> --<span class="comment">image</span>  <span class="comment">CentOS</span><span class="literal">-</span><span class="comment">7</span><span class="literal">-</span><span class="comment">x86_64</span> --<span class="comment">flavor</span> <span class="comment">ds1G</span> --<span class="comment">network</span> <span class="comment">private</span> <span class="comment">test01</span></span><br><span class="line"><span class="comment">#</span> <span class="comment">openstack</span> <span class="comment">server</span> <span class="comment">create</span> --<span class="comment">image</span>  <span class="comment">CentOS</span><span class="literal">-</span><span class="comment">7</span><span class="literal">-</span><span class="comment">x86_64</span> --<span class="comment">flavor</span> <span class="comment">ds1G</span> --<span class="comment">network</span> <span class="comment">private</span> <span class="comment">test02</span></span><br></pre></td></tr></table></figure><h3 id="4-挂载-multiattach-volume-到虚拟机-test01"><a href="#4-挂载-multiattach-volume-到虚拟机-test01" class="headerlink" title="4. 挂载 multiattach-volume 到虚拟机 test01"></a>4. 挂载 multiattach-volume 到虚拟机 test01</h3><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"># nova volume-attach test01 &lt;volume_uuid&gt;</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br><span class="line">| Property | Value                                |</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br><span class="line">| device   | /dev/vdb                             |</span><br><span class="line">| id       | ad8c6437-d842-40f7-b3d8-ee15d9623370 |</span><br><span class="line">| serverId | 972393a0-346e-419d-8933-2562290829cf |</span><br><span class="line">| volumeId | ad8c6437-d842-40f7-b3d8-ee15d9623370 |</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="5-继续挂载multiattach-volume-到虚拟机-test02"><a href="#5-继续挂载multiattach-volume-到虚拟机-test02" class="headerlink" title="5. 继续挂载multiattach-volume 到虚拟机 test02"></a>5. 继续挂载multiattach-volume 到虚拟机 test02</h3><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"># nova volume-attach test02 &lt;volume_uuid&gt;</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br><span class="line">| Property | Value                                |</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br><span class="line">| device   | /dev/vdb                             |</span><br><span class="line">| id       | ad8c6437-d842-40f7-b3d8-ee15d9623370 |</span><br><span class="line">| serverId | 93b82c8e-4155-4ad5-9366-6eb2a9c9d34d |</span><br><span class="line">| volumeId | ad8c6437-d842-40f7-b3d8-ee15d9623370 |</span><br><span class="line"><span class="code">+----------+</span>--------------------------------------+</span><br></pre></td></tr></table></figure><h3 id="6-查看卷信息，可以看到有两个挂载信息"><a href="#6-查看卷信息，可以看到有两个挂载信息" class="headerlink" title="6. 查看卷信息，可以看到有两个挂载信息"></a>6. 查看卷信息，可以看到有两个挂载信息</h3><figure class="highlight gherkin"><table><tr><td class="code"><pre><span class="line"><span class="comment"># cinder show ad8c6437-d842-40f7-b3d8-ee15d9623370</span></span><br><span class="line">+--------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Property                       </span>|<span class="string"> Value                                                                            </span>|</span><br><span class="line">+--------------------------------+----------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> attached_servers               </span>|<span class="string"> [&#x27;93b82c8e-4155-4ad5-9366-6eb2a9c9d34d&#x27;, &#x27;972393a0-346e-419d-8933-2562290829cf&#x27;] </span>|</span><br><span class="line">|<span class="string"> attachment_ids                 </span>|<span class="string"> [&#x27;bb764f56-b3bb-4a32-9859-5a25c8eb1287&#x27;, &#x27;deddf8b6-8b6c-4bb4-b309-7eb78d135637&#x27;] </span>|</span><br><span class="line">|<span class="string"> availability_zone              </span>|<span class="string"> nova                                                                             </span>|</span><br><span class="line">|<span class="string"> bootable                       </span>|<span class="string"> false                                                                            </span>|</span><br><span class="line">|<span class="string"> consistencygroup_id            </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> created_at                     </span>|<span class="string"> 2018-03-06T05:43:01.000000                                                       </span>|</span><br><span class="line">|<span class="string"> description                    </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> encrypted                      </span>|<span class="string"> False                                                                            </span>|</span><br><span class="line">|<span class="string"> id                             </span>|<span class="string"> ad8c6437-d842-40f7-b3d8-ee15d9623370                                             </span>|</span><br><span class="line">|<span class="string"> metadata                       </span>|<span class="string"> attached_mode : rw                                                               </span>|</span><br><span class="line">|<span class="string"> migration_status               </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> multiattach                    </span>|<span class="string"> True                                                                             </span>|</span><br><span class="line">|<span class="string"> name                           </span>|<span class="string"> multiattach-volume                                                               </span>|</span><br><span class="line">|<span class="string"> os-vol-host-attr:host          </span>|<span class="string"> queens.domian.tld@lvmdriver-1#lvmdriver-1                                        </span>|</span><br><span class="line">|<span class="string"> os-vol-mig-status-attr:migstat </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> os-vol-mig-status-attr:name_id </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> os-vol-tenant-attr:tenant_id   </span>|<span class="string"> ce5300160e244953bcfab8b9ebf06705                                                 </span>|</span><br><span class="line">|<span class="string"> replication_status             </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> size                           </span>|<span class="string"> 10                                                                               </span>|</span><br><span class="line">|<span class="string"> snapshot_id                    </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> source_volid                   </span>|<span class="string"> None                                                                             </span>|</span><br><span class="line">|<span class="string"> status                         </span>|<span class="string"> in-use                                                                           </span>|</span><br><span class="line">|<span class="string"> updated_at                     </span>|<span class="string"> 2018-03-06T06:16:44.000000                                                       </span>|</span><br><span class="line">|<span class="string"> user_id                        </span>|<span class="string"> 6b1155688e044f5899a5dd154fa269bd                                                 </span>|</span><br><span class="line">|<span class="string"> volume_type                    </span>|<span class="string"> multiattach                                                                      </span>|</span><br><span class="line">+--------------------------------+----------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>如图 test01 和 test02 都能查看到磁盘信息<br><img data-src="/images/uploads/2018/03/test01.png" alt="image"></p><p>接下来在 test02 上面创建分区挂载磁盘到 /mnt 并写入文件<br><img data-src="/images/uploads/2018/03/test02.png" alt="image"></p><p>接着关闭 test02 模拟出现故障，然后在 test01 上挂载分区，查看文件(可能需要手动刷新下分区表)<br><img data-src="/images/uploads/2018/03/test03.png" alt="image"></p><h2 id="Multi-Attach-一些说明"><a href="#Multi-Attach-一些说明" class="headerlink" title="Multi-Attach 一些说明"></a>Multi-Attach 一些说明</h2><p>RO/RW 警告(第二挂载 RW 权限的问题)<br>默认情况下第二次挂载的采用 read/write 模式， 会导致一些问题，尤其是卷迁移之类的操作，后期会有一些改进支持自定义第二个挂载的模式。</p><h2 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h2><ul><li>不支持调整一个 in-use 的卷从 multiattach 类型到非 multiattach 类型</li><li>如果一个 multiattach 卷有不止一个 R/W 模式的挂载正在使用中，不推荐进行 retype 操作。</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;OpenStack Queens 平台于2月28日正式发布，这是该开源云平台的第17版。OpenStack Queens 增加了多项新功能，也优化增强了多项旧功能，包括虚拟 GPU（ vGPU ）支持和容器集成的改进。几个新项目也在 OpenStack Queens 这一里程碑中露面，包括提供管理硬件和软件加速资源框架的Cyborg 。&lt;br&gt;Queens 发布了一些强大的面向企业的功能，其中最引人注目的是 Cinder 中的 Multi-Attach 功能。Cinder Multi-Attach 使运维者能够将相同的Cinder 卷加载到多个 VM 中。如果一个节点关闭，另一个节点能够接管并访问该卷。&lt;/p&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="cinder" scheme="https://www.sunmite.com/tags/cinder/"/>
    
    <category term="Multi-Attach" scheme="https://www.sunmite.com/tags/Multi-Attach/"/>
    
  </entry>
  
  <entry>
    <title>fuel 9.0 制作本地源、bootstrap以及升级9.2</title>
    <link href="https://www.sunmite.com/openstack/fuel-something.html"/>
    <id>https://www.sunmite.com/openstack/fuel-something.html</id>
    <published>2018-02-27T02:47:45.000Z</published>
    <updated>2021-01-25T02:17:02.338Z</updated>
    
    <content type="html"><![CDATA[<p>host-only 联网  </p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">iptables</span> -t nat -A POSTROUTING -s <span class="number">10.20.0.0</span>/<span class="number">24</span> -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="attribute">10</span>.<span class="number">20</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">24</span> 为 host-only 网段</span><br></pre></td></tr></table></figure><h2 id="制作源"><a href="#制作源" class="headerlink" title="制作源"></a>制作源</h2><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /usr/share/fuel-mirror/ubuntu.yaml</span><br><span class="line"><span class="deletion">- ubuntu_baseurl: &amp;ubuntu_baseurl http://archive.ubuntu.com/ubuntu</span></span><br><span class="line"><span class="addition">+ ubuntu_baseurl: &amp;ubuntu_baseurl http://mirrors.aliyun.com/ubuntu</span></span><br><span class="line">mos_baseurl: &amp;mos_baseurl http://mirror.fuel-infra.org/mos-repos/ubuntu/$mos_version</span><br></pre></td></tr></table></figure><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># fuel-createmirror</span></span><br></pre></td></tr></table></figure><h2 id="bootstrap"><a href="#bootstrap" class="headerlink" title="bootstrap"></a>bootstrap</h2><h3 id="更换国内源"><a href="#更换国内源" class="headerlink" title="更换国内源"></a>更换国内源</h3><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"># vim /etc/fuel-bootstrap-cli/fuel_bootstrap_cli.yaml</span><br><span class="line"></span><br><span class="line">repos:</span><br><span class="line">    - name: ubuntu</span><br><span class="line">      section: &quot;main universe multiverse&quot;</span><br><span class="line"><span class="deletion">-     uri: &quot;http://archive.ubuntu.com/ubuntu&quot;</span></span><br><span class="line"><span class="addition">+     uri: &quot;http://mirrors.aliyun.com/ubuntu&quot;</span></span><br><span class="line">      priority:</span><br><span class="line">      suite: trusty</span><br><span class="line">      type: deb</span><br><span class="line">    - name: ubuntu-updates</span><br><span class="line">      section: &quot;main universe multiverse&quot;</span><br><span class="line"><span class="deletion">-     uri: &quot;http://archive.ubuntu.com/ubuntu&quot;</span></span><br><span class="line"><span class="addition">+     uri: &quot;http://mirrors.aliyun.com/ubuntu&quot;</span></span><br><span class="line">      priority:</span><br><span class="line">      suite: trusty-updates</span><br><span class="line">      type: deb</span><br><span class="line">    - name: ubuntu-security</span><br><span class="line">      section: &quot;main universe multiverse&quot;</span><br><span class="line"><span class="deletion">-      uri: &quot;http://archive.ubuntu.com/ubuntu&quot;</span></span><br><span class="line"><span class="addition">+      uri: &quot;http://mirrors.aliyun.com/ubuntu&quot;</span></span><br><span class="line">      priority:</span><br><span class="line">      suite: trusty-security</span><br><span class="line">      type: deb</span><br></pre></td></tr></table></figure><span id="more"></span><h3 id="开始制作-bootstrap"><a href="#开始制作-bootstrap" class="headerlink" title="开始制作 bootstrap"></a>开始制作 bootstrap</h3><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment"># fuel-bootstrap build</span></span><br><span class="line"></span><br><span class="line">……</span><br><span class="line">Building initramfs</span><br><span class="line">Building squashfs</span><br><span class="line">squashfs_image clean-up</span><br><span class="line">Creating archive: <span class="regexp">/tmp/</span><span class="number">59129</span>ecd-cccd-<span class="number">4</span>a13-<span class="number">943</span>b-ed6000d2aa02.tar.gz</span><br><span class="line">--- Building bootstrap image <span class="keyword">END</span> (do_mkbootstrap) ---</span><br><span class="line">Cleanup chroot</span><br><span class="line">Bootstrap image <span class="number">59129</span>ecd-cccd-<span class="number">4</span>a13-<span class="number">943</span>b-ed6000d2aa02 has been built: <span class="regexp">/tmp/</span><span class="number">59129</span>ecd-cccd-<span class="number">4</span>a13-<span class="number">943</span>b-ed6000d2aa02.tar.gz</span><br></pre></td></tr></table></figure><h3 id="导入-bootstrap"><a href="#导入-bootstrap" class="headerlink" title="导入 bootstrap"></a>导入 bootstrap</h3><p>成功后在 /tmp/ 下有如下文件</p><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># ls <span class="regexp">/tmp/</span>*.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="regexp">/tmp/</span><span class="number">59129</span>ecd-cccd-<span class="number">4</span>a13-<span class="number">943</span>b-ed6000d2aa02.tar.gz</span><br></pre></td></tr></table></figure><p>导入 bootstrap</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># fuel-bootstrap import /tmp/59129ecd-cccd-4a13-943b-ed6000d2aa02.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Try</span> extract /tmp/<span class="number">59129</span>ecd-cccd-<span class="number">4</span>a<span class="number">13</span>-<span class="number">943</span>b-ed<span class="number">6000</span>d<span class="number">2</span>aa<span class="number">02</span>.tar.gz to /tmp/tmpnixoNM</span><br><span class="line"><span class="attribute">Bootstrap</span> image <span class="number">59129</span>ecd-cccd-<span class="number">4</span>a<span class="number">13</span>-<span class="number">943</span>b-ed<span class="number">6000</span>d<span class="number">2</span>aa<span class="number">02</span> has been imported.</span><br></pre></td></tr></table></figure><p>激活 bootstrap</p><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment"># fuel-bootstrap activate 59129ecd-cccd-4a13-943b-ed6000d2aa02</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">Bootstrap</span> image <span class="number">59129</span>ecd-cccd-<span class="number">4</span>a<span class="number">13</span>-<span class="number">943</span>b-ed<span class="number">6000</span>d<span class="number">2</span>aa<span class="number">02</span> has been activated.</span><br></pre></td></tr></table></figure><p>查看新增bootstrap</p><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line"># fuel-bootstrap list</span><br><span class="line"></span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------<span class="code">+--------+</span></span><br><span class="line">| uuid                                 | label                                | status |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------<span class="code">+--------+</span></span><br><span class="line">| 59129ecd-cccd-4a13-943b-ed6000d2aa02 | 59129ecd-cccd-4a13-943b-ed6000d2aa02 | active |</span><br><span class="line"><span class="code">+--------------------------------------+</span>--------------------------------------<span class="code">+--------+</span></span><br></pre></td></tr></table></figure><h2 id="升级-Mirantis-OpenStack-9-x-到-9-2"><a href="#升级-Mirantis-OpenStack-9-x-到-9-2" class="headerlink" title="升级 Mirantis OpenStack 9.x 到 9.2"></a>升级 Mirantis OpenStack 9.x 到 9.2</h2><h3 id="1-添加mos92-updates更新源"><a href="#1-添加mos92-updates更新源" class="headerlink" title="1. 添加mos92-updates更新源"></a>1. 添加mos92-updates更新源</h3><figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line"># yum install -y http://mirror.fuel-infra.org/mos-repos/centos/mos<span class="number">9.0</span>-centos<span class="number">7</span>/<span class="number">9.2</span>-updates/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>/Packages/mos-<span class="keyword">release</span><span class="number">-9.2</span><span class="number">-1</span>.el<span class="number">7</span>.<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>.rpm</span><br></pre></td></tr></table></figure><h3 id="2-清除-yum-缓存"><a href="#2-清除-yum-缓存" class="headerlink" title="2. 清除 yum 缓存"></a>2. 清除 yum 缓存</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum clean all</span></span><br></pre></td></tr></table></figure><h3 id="3-安装-mos-playbooks"><a href="#3-安装-mos-playbooks" class="headerlink" title="3. 安装 mos-playbooks"></a>3. 安装 mos-playbooks</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># yum install -y mos-updates</span></span><br></pre></td></tr></table></figure><h3 id="4-切换到mos-playbooks-mos-mu-目录"><a href="#4-切换到mos-playbooks-mos-mu-目录" class="headerlink" title="4. 切换到mos_playbooks/mos_mu/ 目录"></a>4. 切换到mos_playbooks/mos_mu/ 目录</h3><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"># cd mos_playbooks<span class="regexp">/mos_mu/</span></span><br></pre></td></tr></table></figure><h3 id="5-执行环境准备的playbook"><a href="#5-执行环境准备的playbook" class="headerlink" title="5. 执行环境准备的playbook"></a>5. 执行环境准备的playbook</h3><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="meta"># ansible-playbook playbooks/mos9_prepare_fuel.yml</span></span><br></pre></td></tr></table></figure><h3 id="6-升级Fuel-节点上的包、服务、配置，期间各服务都会重启"><a href="#6-升级Fuel-节点上的包、服务、配置，期间各服务都会重启" class="headerlink" title="6. 升级Fuel 节点上的包、服务、配置，期间各服务都会重启"></a>6. 升级Fuel 节点上的包、服务、配置，期间各服务都会重启</h3><figure class="highlight ada"><table><tr><td class="code"><pre><span class="line"># ansible-playbook playbooks/update_fuel.yml -e &#x27;&#123;<span class="string">&quot;rebuild_bootstrap&quot;</span>:<span class="literal">false</span>&#125;&#x27;</span><br></pre></td></tr></table></figure><h3 id="7-升级Fuel-bootstrap-内核"><a href="#7-升级Fuel-bootstrap-内核" class="headerlink" title="7. 升级Fuel bootstrap 内核"></a>7. 升级Fuel bootstrap 内核</h3><figure class="highlight gcode"><table><tr><td class="code"><pre><span class="line"><span class="attr"># ansible-playbook playbooks/mos9</span>_fuel_upgrade_ker<span class="symbol">nel_4</span><span class="number">.4</span>.yml</span><br></pre></td></tr></table></figure><h3 id="8-确认升级成功"><a href="#8-确认升级成功" class="headerlink" title="8. 确认升级成功"></a>8. 确认升级成功</h3><figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line"># fuel2 fuel-version</span><br><span class="line"> </span><br><span class="line"><span class="symbol">api:</span> <span class="comment">&#x27;1&#x27;</span></span><br><span class="line"><span class="symbol">auth_required:</span> <span class="literal">true</span></span><br><span class="line"><span class="symbol">feature_groups:</span> []</span><br><span class="line"><span class="symbol">openstack_version:</span> mitaka-<span class="number">9.0</span></span><br><span class="line"><span class="symbol">release:</span> <span class="comment">&#x27;9.2&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://docs.mirantis.com/openstack/fuel/fuel-9.2/release-notes/update-product.html#update-from-9-to-9-2">Update to minor releases (9.x)</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;host-only 联网  &lt;/p&gt;
&lt;figure class=&quot;highlight apache&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;iptables&lt;/span&gt; -t nat -A POSTROUTING -s &lt;span class=&quot;number&quot;&gt;10.20.0.0&lt;/span&gt;/&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt; -j MASQUERADE&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attribute&quot;&gt;10&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;20&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;.&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;/&lt;span class=&quot;number&quot;&gt;24&lt;/span&gt; 为 host-only 网段&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;制作源&quot;&gt;&lt;a href=&quot;#制作源&quot; class=&quot;headerlink&quot; title=&quot;制作源&quot;&gt;&lt;/a&gt;制作源&lt;/h2&gt;&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# vim /usr/share/fuel-mirror/ubuntu.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;- ubuntu_baseurl: &amp;amp;ubuntu_baseurl http://archive.ubuntu.com/ubuntu&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+ ubuntu_baseurl: &amp;amp;ubuntu_baseurl http://mirrors.aliyun.com/ubuntu&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;mos_baseurl: &amp;amp;mos_baseurl http://mirror.fuel-infra.org/mos-repos/ubuntu/$mos_version&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;figure class=&quot;highlight vala&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;# fuel-createmirror&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;h2 id=&quot;bootstrap&quot;&gt;&lt;a href=&quot;#bootstrap&quot; class=&quot;headerlink&quot; title=&quot;bootstrap&quot;&gt;&lt;/a&gt;bootstrap&lt;/h2&gt;&lt;h3 id=&quot;更换国内源&quot;&gt;&lt;a href=&quot;#更换国内源&quot; class=&quot;headerlink&quot; title=&quot;更换国内源&quot;&gt;&lt;/a&gt;更换国内源&lt;/h3&gt;&lt;figure class=&quot;highlight diff&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;# vim /etc/fuel-bootstrap-cli/fuel_bootstrap_cli.yaml&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;repos:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - name: ubuntu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      section: &amp;quot;main universe multiverse&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-     uri: &amp;quot;http://archive.ubuntu.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+     uri: &amp;quot;http://mirrors.aliyun.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      priority:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      suite: trusty&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      type: deb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - name: ubuntu-updates&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      section: &amp;quot;main universe multiverse&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-     uri: &amp;quot;http://archive.ubuntu.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+     uri: &amp;quot;http://mirrors.aliyun.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      priority:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      suite: trusty-updates&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      type: deb&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    - name: ubuntu-security&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      section: &amp;quot;main universe multiverse&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;deletion&quot;&gt;-      uri: &amp;quot;http://archive.ubuntu.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;addition&quot;&gt;+      uri: &amp;quot;http://mirrors.aliyun.com/ubuntu&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      priority:&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      suite: trusty-security&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      type: deb&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;</summary>
    
    
    
    <category term="openstack" scheme="https://www.sunmite.com/categories/openstack/"/>
    
    
    <category term="openstack" scheme="https://www.sunmite.com/tags/openstack/"/>
    
    <category term="fuel" scheme="https://www.sunmite.com/tags/fuel/"/>
    
    <category term="bootstrap" scheme="https://www.sunmite.com/tags/bootstrap/"/>
    
  </entry>
  
</feed>
